name: Build Release Bundles

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v0.1.6'

permissions:
  contents: write

jobs:
  build-linux-bundles:
    name: Build Linux ${{ matrix.variant }} (${{ matrix.arch }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64]
        variant: [cpu, vulkan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git wget
          
          # Install Vulkan SDK from LunarG (Ubuntu 22.04 repos have outdated Vulkan headers)
          if [ "${{ matrix.variant }}" = "vulkan" ]; then
            # Add LunarG Vulkan SDK repository
            wget -qO - https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo apt-key add -
            sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
            sudo apt-get update
            # Install Vulkan SDK (includes up-to-date headers and glslang)
            sudo apt-get install -y vulkan-sdk
          fi
      
      - name: Clone llama.cpp
        run: |
          git clone --depth 1 https://github.com/ggml-org/llama.cpp /tmp/llama.cpp
          cd /tmp/llama.cpp
          echo "LLAMA_VERSION=$(git describe --tags --always)" >> $GITHUB_ENV
      
      - name: Build llama-server binary
        run: |
          cd /tmp/llama.cpp
          mkdir build && cd build
          
          # Set variant-specific flags
          GPU_FLAGS=""
          if [ "${{ matrix.variant }}" = "vulkan" ]; then
            GPU_FLAGS="-DGGML_VULKAN=ON"
            # Vulkan SDK is installed, CMake will find it automatically
          fi
          
          cmake .. \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DGGML_STATIC=ON \
            -DLLAMA_CURL=OFF \
            $GPU_FLAGS
          cmake --build . --config Release -j $(nproc) --target llama-server
      
      - name: Build OffGrid bundle
        run: |
          VERSION="${{ github.ref_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          fi
          
          # Build OffGrid binary (without CGO)
          go build \
            -ldflags="-s -w -X main.Version=${VERSION} -X main.BuildTime=$(date -u '+%Y-%m-%d_%H:%M:%S')" \
            -o offgrid \
            ./cmd/offgrid
          
          # Copy llama-server binary
          cp /tmp/llama.cpp/build/bin/llama-server ./llama-server
          
          # Create bundle directory
          BUNDLE_NAME="offgrid-${VERSION}-linux-${{ matrix.arch }}-${{ matrix.variant }}"
          mkdir -p "$BUNDLE_NAME"
          cp offgrid "$BUNDLE_NAME/"
          cp llama-server "$BUNDLE_NAME/"
          
          # Create install script
          cat > "$BUNDLE_NAME/install.sh" << 'EOF'
          #!/bin/bash
          set -e
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          sudo cp "$SCRIPT_DIR/offgrid" /usr/local/bin/offgrid
          sudo cp "$SCRIPT_DIR/llama-server" /usr/local/bin/llama-server
          sudo chmod +x /usr/local/bin/offgrid /usr/local/bin/llama-server
          echo "✓ Installed to /usr/local/bin"
          EOF
          chmod +x "$BUNDLE_NAME/install.sh"
          
          # Create checksums
          cd "$BUNDLE_NAME"
          sha256sum offgrid llama-server > checksums.sha256
          cd ..
          
          # Create tarball
          tar -czf "${BUNDLE_NAME}.tar.gz" "$BUNDLE_NAME"
          
          echo "ASSET_PATH=${BUNDLE_NAME}.tar.gz" >> $GITHUB_ENV
          echo "ASSET_NAME=${BUNDLE_NAME}.tar.gz" >> $GITHUB_ENV
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: offgrid-linux-${{ matrix.arch }}-${{ matrix.variant }}
          path: ${{ env.ASSET_PATH }}
      
      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ASSET_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos-bundles:
    name: Build macOS ${{ matrix.arch }}
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [arm64, amd64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install dependencies
        run: |
          brew install cmake
      
      - name: Clone llama.cpp
        run: |
          git clone --depth 1 https://github.com/ggml-org/llama.cpp /tmp/llama.cpp
          cd /tmp/llama.cpp
          echo "LLAMA_VERSION=$(git describe --tags --always)" >> $GITHUB_ENV
      
      - name: Build llama-server binary
        run: |
          cd /tmp/llama.cpp
          mkdir build && cd build
          
          # Set architecture-specific flags
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ARCH_FLAGS="-DCMAKE_OSX_ARCHITECTURES=arm64 -DGGML_METAL=ON -DGGML_NATIVE=OFF"
          else
            ARCH_FLAGS="-DCMAKE_OSX_ARCHITECTURES=x86_64 -DGGML_NATIVE=OFF"
          fi
          
          cmake .. \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLAMA_CURL=OFF \
            $ARCH_FLAGS
          cmake --build . --config Release -j $(sysctl -n hw.ncpu) --target llama-server
      
      - name: Build OffGrid bundle
        run: |
          VERSION="${{ github.ref_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          fi
          
          # Set architecture for Go build
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            export GOARCH=arm64
          else
            export GOARCH=amd64
          fi
          
          # Build OffGrid binary (without CGO)
          go build \
            -ldflags="-s -w -X main.Version=${VERSION} -X main.BuildTime=$(date -u '+%Y-%m-%d_%H:%M:%S')" \
            -o offgrid \
            ./cmd/offgrid
          
          # Copy llama-server binary
          cp /tmp/llama.cpp/build/bin/llama-server ./llama-server
          
          # Create bundle directory
          BUNDLE_NAME="offgrid-${VERSION}-darwin-${{ matrix.arch }}"
          mkdir -p "$BUNDLE_NAME"
          cp offgrid "$BUNDLE_NAME/"
          cp llama-server "$BUNDLE_NAME/"
          
          # Create install script
          cat > "$BUNDLE_NAME/install.sh" << 'EOF'
          #!/bin/bash
          set -e
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          sudo cp "$SCRIPT_DIR/offgrid" /usr/local/bin/offgrid
          sudo cp "$SCRIPT_DIR/llama-server" /usr/local/bin/llama-server
          sudo chmod +x /usr/local/bin/offgrid /usr/local/bin/llama-server
          echo "✓ Installed to /usr/local/bin"
          EOF
          chmod +x "$BUNDLE_NAME/install.sh"
          
          # Create checksums
          cd "$BUNDLE_NAME"
          shasum -a 256 offgrid llama-server > checksums.sha256
          cd ..
          
          # Create tarball
          tar -czf "${BUNDLE_NAME}.tar.gz" "$BUNDLE_NAME"
          
          echo "ASSET_PATH=${BUNDLE_NAME}.tar.gz" >> $GITHUB_ENV
          echo "ASSET_NAME=${BUNDLE_NAME}.tar.gz" >> $GITHUB_ENV
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: offgrid-darwin-${{ matrix.arch }}
          path: ${{ env.ASSET_PATH }}
      
      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ASSET_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-installer:
    name: Create unified installer
    runs-on: ubuntu-latest
    needs: [build-linux-bundles, build-macos-bundles]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create installer script
        run: |
          VERSION="${{ github.ref_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          fi
          
          cat > install-bundle.sh << 'INSTALLER_EOF'
          #!/bin/bash
          set -e
          VERSION="VERSION_PLACEHOLDER"
          REPO="takuphilchan/offgrid-llm"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          case "$ARCH" in
              x86_64|amd64) ARCH="amd64" ;;
              aarch64|arm64) ARCH="arm64" ;;
          esac
          
          # Auto-detect GPU variant for Linux
          GPU_VARIANT="cpu"
          if [ "$OS" = "linux" ]; then
              if command -v vulkaninfo &> /dev/null && vulkaninfo --summary &> /dev/null 2>&1; then
                  GPU_VARIANT="vulkan"
                  echo "✓ Vulkan detected - downloading GPU-accelerated version"
              else
                  echo "→ CPU-only version (install vulkan-tools for GPU acceleration)"
              fi
          fi
          
          if [ "$OS" = "linux" ]; then
              BUNDLE_NAME="offgrid-${VERSION}-linux-${ARCH}-${GPU_VARIANT}.tar.gz"
          else
              BUNDLE_NAME="offgrid-${VERSION}-darwin-${ARCH}.tar.gz"
          fi
          
          echo "Downloading OffGrid LLM ${VERSION} (${OS}-${ARCH}-${GPU_VARIANT})..."
          if ! curl -fsSL "${BASE_URL}/${BUNDLE_NAME}" -o /tmp/offgrid-bundle.tar.gz; then
              echo "⚠️  GPU version not available, falling back to CPU..."
              BUNDLE_NAME="offgrid-${VERSION}-${OS}-${ARCH}-cpu.tar.gz"
              curl -fsSL "${BASE_URL}/${BUNDLE_NAME}" -o /tmp/offgrid-bundle.tar.gz
          fi
          
          echo "Extracting..."
          tar -xzf /tmp/offgrid-bundle.tar.gz -C /tmp
          BUNDLE_DIR=$(find /tmp -maxdepth 1 -type d -name "offgrid-${VERSION}-*" | head -1)
          if [ -d "$BUNDLE_DIR" ] && [ -f "$BUNDLE_DIR/install.sh" ]; then
              cd "$BUNDLE_DIR"
              bash install.sh
          else
              echo "Error: Bundle extraction failed"
              exit 1
          fi
          rm -rf /tmp/offgrid-bundle.tar.gz "$BUNDLE_DIR"
          echo "✓ Installation complete! Run: offgrid --version"
          INSTALLER_EOF
          
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" install-bundle.sh
          chmod +x install-bundle.sh
      
      - name: Upload installer
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: install-bundle.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
