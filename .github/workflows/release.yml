name: Release Buildname: Release Buildname: Release Build



on:

  push:

    tags:on:on:

      - 'v*'

  workflow_dispatch:  push:  push:



env:    tags:    tags:

  GO_VERSION: '1.21'

      - 'v*'      - 'v*'

jobs:

  build-and-release:  workflow_dispatch:  workflow_dispatch:

    name: Build and Release

    runs-on: ubuntu-latest    inputs:

    

    steps:env:      version:

      - name: Checkout repository

        uses: actions/checkout@v4  GO_VERSION: '1.21'        description: 'Version to release (e.g., v0.1.0)'



      - name: Set up Go        required: true

        uses: actions/setup-go@v5

        with:jobs:        default: 'v0.1.0-alpha'

          go-version: ${{ env.GO_VERSION }}

  # Build and create release with Go binaries only

      - name: Get version

        id: version  build-and-release:env:

        run: |

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then    name: Build and Release  GO_VERSION: '1.21'

            echo "version=v0.1.0-manual" >> $GITHUB_OUTPUT

          else    runs-on: ubuntu-latest

            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

          fi    jobs:



      - name: Build all platforms    steps:  # Build OffGrid LLM Go binaries for all platforms

        run: |

          VERSION=${{ steps.version.outputs.version }}      - name: Checkout repository  build-offgrid:

          mkdir -p dist

                  uses: actions/checkout@v4    name: Build OffGrid - ${{ matrix.os }} (${{ matrix.arch }})

          GOOS=linux GOARCH=amd64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-linux-amd64 ./cmd/offgrid

          GOOS=linux GOARCH=arm64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-linux-arm64 ./cmd/offgrid    runs-on: ubuntu-latest

          GOOS=darwin GOARCH=amd64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-darwin-amd64 ./cmd/offgrid

          GOOS=darwin GOARCH=arm64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-darwin-arm64 ./cmd/offgrid      - name: Set up Go    strategy:

          GOOS=windows GOARCH=amd64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-windows-amd64.exe ./cmd/offgrid

          GOOS=windows GOARCH=arm64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-windows-arm64.exe ./cmd/offgrid        uses: actions/setup-go@v5      matrix:



      - name: Create release packages        with:        include:

        run: |

          VERSION=${{ steps.version.outputs.version }}          go-version: ${{ env.GO_VERSION }}          - goos: linux

          mkdir -p release

                      goarch: amd64

          for arch in amd64 arm64; do

            mkdir -p pkg-linux-${arch}      - name: Get version            os: linux

            cp dist/offgrid-linux-${arch} pkg-linux-${arch}/offgrid

            cp README.md LICENSE pkg-linux-${arch}/        id: version            arch: amd64

            tar -czf release/offgrid-${VERSION}-linux-${arch}.tar.gz -C pkg-linux-${arch} .

          done        run: |          - goos: linux

          

          for arch in amd64 arm64; do          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then            goarch: arm64

            mkdir -p pkg-darwin-${arch}

            cp dist/offgrid-darwin-${arch} pkg-darwin-${arch}/offgrid            echo "version=v0.1.0-manual" >> $GITHUB_OUTPUT            os: linux

            cp README.md LICENSE pkg-darwin-${arch}/

            tar -czf release/offgrid-${VERSION}-darwin-${arch}.tar.gz -C pkg-darwin-${arch} .          else            arch: arm64

          done

                      echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT          - goos: darwin

          for arch in amd64 arm64; do

            mkdir -p pkg-windows-${arch}          fi            goarch: amd64

            cp dist/offgrid-windows-${arch}.exe pkg-windows-${arch}/offgrid.exe

            cp README.md LICENSE pkg-windows-${arch}/            os: darwin

            cp installers/install-windows.ps1 pkg-windows-${arch}/install.ps1

            cd pkg-windows-${arch} && zip -r ../release/offgrid-${VERSION}-windows-${arch}.zip . && cd ../..      - name: Build all platforms            arch: amd64

          done

        run: |          - goos: darwin

      - name: Generate checksums

        run: |          VERSION=${{ steps.version.outputs.version }}            goarch: arm64

          cd release

          sha256sum * > checksums.txt                      os: darwin

          cat checksums.txt

          # Linux AMD64            arch: arm64

      - name: Create Release Notes

        run: |          GOOS=linux GOARCH=amd64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-linux-amd64 ./cmd/offgrid          - goos: windows

          VERSION=${{ steps.version.outputs.version }}

          cat > release_notes.md << 'EOF'                      goarch: amd64

          ## OffGrid LLM

                    # Linux ARM64            os: windows

          Cross-platform AI inference system for edge deployments.

                    GOOS=linux GOARCH=arm64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-linux-arm64 ./cmd/offgrid            arch: amd64

          ### Quick Install

                              - goos: windows

          **Linux/macOS:**

          ```bash          # macOS AMD64 (Intel)            goarch: arm64

          curl -fsSL https://raw.githubusercontent.com/takuphilchan/offgrid-llm/main/installers/install.sh | bash

          ```          GOOS=darwin GOARCH=amd64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-darwin-amd64 ./cmd/offgrid            os: windows

          

          **Windows (PowerShell as Admin):**                      arch: arm64

          ```powershell

          irm https://raw.githubusercontent.com/takuphilchan/offgrid-llm/main/installers/install-windows.ps1 | iex          # macOS ARM64 (Apple Silicon)

          ```

                    GOOS=darwin GOARCH=arm64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-darwin-arm64 ./cmd/offgrid    steps:

          ### Manual Download

                          - name: Checkout repository

          Download the appropriate package below, extract, and add to PATH.

                    # Windows AMD64        uses: actions/checkout@v4

          **Note:** llama.cpp is required but not included. Install separately:

          - **Linux**: Run root `install.sh` to build from source with GPU support          GOOS=windows GOARCH=amd64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-windows-amd64.exe ./cmd/offgrid

          - **macOS**: `brew install llama.cpp`

          - **Windows**: Download from [llama.cpp releases](https://github.com/ggerganov/llama.cpp/releases)                - name: Set up Go

          

          Or use the quick install scripts above - they handle llama.cpp automatically.          # Windows ARM64        uses: actions/setup-go@v5

          

          ### Platform Support          GOOS=windows GOARCH=arm64 go build -ldflags "-X main.Version=${VERSION}" -o dist/offgrid-windows-arm64.exe ./cmd/offgrid        with:

          

          - Linux (x86_64, ARM64)          go-version: ${{ env.GO_VERSION }}

          - macOS (Intel, Apple Silicon)

          - Windows (x86_64, ARM64)      - name: Create release packages

          

          ### Verify Downloads        run: |      - name: Get version

          

          SHA256 checksums in `checksums.txt`          VERSION=${{ steps.version.outputs.version }}        id: version

          EOF

          mkdir -p release        run: |

      - name: Create GitHub Release

        uses: softprops/action-gh-release@v1                    if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then

        with:

          files: release/*          # Linux packages            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

          body_path: release_notes.md

          draft: false          for arch in amd64 arm64; do          else

          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

        env:            mkdir -p pkg-linux-${arch}            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            cp dist/offgrid-linux-${arch} pkg-linux-${arch}/offgrid          fi

            cp README.md LICENSE pkg-linux-${arch}/        shell: bash

            tar -czf release/offgrid-${VERSION}-linux-${arch}.tar.gz -C pkg-linux-${arch} .

          done      - name: Build binary

                  run: |

          # macOS packages          BINARY_NAME="offgrid"

          for arch in amd64 arm64; do          if [ "${{ matrix.goos }}" = "windows" ]; then

            mkdir -p pkg-darwin-${arch}            BINARY_NAME="offgrid.exe"

            cp dist/offgrid-darwin-${arch} pkg-darwin-${arch}/offgrid          fi

            cp README.md LICENSE pkg-darwin-${arch}/          

            tar -czf release/offgrid-${VERSION}-darwin-${arch}.tar.gz -C pkg-darwin-${arch} .          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \

          done          go build -ldflags "-X main.Version=${{ steps.version.outputs.version }}" \

                      -o ${BINARY_NAME} ./cmd/offgrid

          # Windows packages

          for arch in amd64 arm64; do      - name: Upload OffGrid artifact

            mkdir -p pkg-windows-${arch}        uses: actions/upload-artifact@v4

            cp dist/offgrid-windows-${arch}.exe pkg-windows-${arch}/offgrid.exe        with:

            cp README.md LICENSE pkg-windows-${arch}/          name: offgrid-${{ matrix.os }}-${{ matrix.arch }}

            cp installers/install-windows.ps1 pkg-windows-${arch}/install.ps1          path: offgrid${{ matrix.goos == 'windows' && '.exe' || '' }}

            cd pkg-windows-${arch} && zip -r ../release/offgrid-${VERSION}-windows-${arch}.zip . && cd ..          retention-days: 1

          done

  # Package for Linux (tar.gz archives)

      - name: Generate checksums  package-linux:

        run: |    name: Package Linux

          cd release    needs: [build-llama-cpp, build-offgrid]

          sha256sum * > checksums.txt    runs-on: ubuntu-latest

          cat checksums.txt    strategy:

      matrix:

      - name: Create Release Notes        arch: [amd64, arm64]

        run: |

          VERSION=${{ steps.version.outputs.version }}    steps:

          cat > release_notes.md << EOF      - name: Checkout repository

          ## OffGrid LLM ${VERSION}        uses: actions/checkout@v4

          

          Cross-platform AI inference system for edge deployments.      - name: Download OffGrid binary

                  uses: actions/download-artifact@v4

          ### Quick Install        with:

                    name: offgrid-linux-${{ matrix.arch }}

          **Linux/macOS:**          path: package/

          \`\`\`bash

          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/installers/install.sh | bash      - name: Download llama-server binary

          \`\`\`        uses: actions/download-artifact@v4

                  with:

          **Windows (PowerShell as Admin):**          name: llama-server-linux-${{ matrix.arch }}

          \`\`\`powershell          path: package/

          irm https://raw.githubusercontent.com/${{ github.repository }}/main/installers/install-windows.ps1 | iex

          \`\`\`      - name: Get version

                  id: version

          ### Manual Installation        run: |

                    if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then

          Download the appropriate package for your platform below, extract it, and add to your PATH.            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

                    else

          **Note:** You'll need to install llama.cpp separately:            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

          - Linux: Use the root \`install.sh\` script to build from source with GPU support          fi

          - macOS: \`brew install llama.cpp\`

          - Windows: Download from [llama.cpp releases](https://github.com/ggerganov/llama.cpp/releases)      - name: Create package structure

                  run: |

          Or use the quick install scripts above which handle llama.cpp installation automatically.          mkdir -p package/bin

                    chmod +x package/offgrid package/llama-server

          ### Platform Support          mv package/offgrid package/bin/

                    mv package/llama-server package/bin/

          - ✅ Linux (x86_64, ARM64)          

          - ✅ macOS (Intel, Apple Silicon)          # Copy documentation

          - ✅ Windows (x86_64, ARM64)          cp README.md package/

                    cp LICENSE package/

          ### Verify Downloads          

                    # Create install script

          Check integrity with SHA256 checksums in \`checksums.txt\`          cat > package/install.sh << 'EOF'

          EOF          #!/bin/bash

          set -e

      - name: Create GitHub Release          

        uses: softprops/action-gh-release@v1          echo "Installing OffGrid LLM..."

        with:          

          files: release/*          # Install binaries

          body_path: release_notes.md          sudo install -m 755 bin/offgrid /usr/local/bin/offgrid

          draft: false          sudo install -m 755 bin/llama-server /usr/local/bin/llama-server

          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}          

        env:          # Create config directory

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}          mkdir -p ~/.config/offgrid

          
          echo "✓ Installation complete!"
          echo "Run 'offgrid --help' to get started"
          EOF
          
          chmod +x package/install.sh

      - name: Create tar.gz archive
        run: |
          cd package
          tar -czf ../offgrid-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.tar.gz .

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: package-linux-${{ matrix.arch }}
          path: offgrid-*.tar.gz

  # Package for macOS (DMG)
  package-macos:
    name: Package macOS
    needs: [build-llama-cpp, build-offgrid]
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OffGrid binary
        uses: actions/download-artifact@v4
        with:
          name: offgrid-darwin-${{ matrix.arch }}
          path: artifacts/

      - name: Download llama-server binary
        uses: actions/download-artifact@v4
        with:
          name: llama-server-darwin-${{ matrix.arch }}
          path: artifacts/

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create application bundle
        run: |
          chmod +x artifacts/offgrid artifacts/llama-server
          bash build/macos/create-app-bundle.sh \
            artifacts/offgrid \
            artifacts/llama-server \
            ${{ steps.version.outputs.version }}

      - name: Create DMG
        run: |
          bash build/macos/create-dmg.sh \
            ${{ steps.version.outputs.version }} \
            ${{ matrix.arch }}

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: package-darwin-${{ matrix.arch }}
          path: '*.dmg'

  # Package for Windows (ZIP + Installer)
  package-windows:
    name: Package Windows
    needs: [build-llama-cpp, build-offgrid]
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OffGrid binary
        uses: actions/download-artifact@v4
        with:
          name: offgrid-windows-${{ matrix.arch }}
          path: package/

      - name: Download llama-server binary
        uses: actions/download-artifact@v4
        with:
          name: llama-server-windows-${{ matrix.arch }}
          path: package/

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create package structure
        shell: bash
        run: |
          # Copy documentation
          cp README.md package/
          cp LICENSE package/
          
          # Copy install script
          cp installers/install-windows.ps1 package/install.ps1

      - name: Create ZIP archive
        shell: bash
        run: |
          cd package
          7z a ../offgrid-${{ steps.version.outputs.version }}-windows-${{ matrix.arch }}.zip .

      - name: Upload ZIP package
        uses: actions/upload-artifact@v4
        with:
          name: package-windows-${{ matrix.arch }}
          path: '*.zip'

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [package-linux, package-macos, package-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: package-*

      - name: Organize artifacts
        run: |
          mkdir -p release
          find dist -name "*.tar.gz" -exec mv {} release/ \;
          find dist -name "*.dmg" -exec mv {} release/ \;
          find dist -name "*.zip" -exec mv {} release/ \;
          ls -lh release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## OffGrid LLM ${GITHUB_REF#refs/tags/}
          
          ### What's New
          
          Edge-optimized AI inference system with cross-platform support.
          
          ### Installation
          
          #### Linux
          ```bash
          # Download and extract
          wget https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF#refs/tags/}/offgrid-${GITHUB_REF#refs/tags/}-linux-amd64.tar.gz
          tar -xzf offgrid-${GITHUB_REF#refs/tags/}-linux-amd64.tar.gz
          cd offgrid-${GITHUB_REF#refs/tags/}-linux-amd64
          
          # Install
          sudo ./install.sh
          ```
          
          #### macOS
          ```bash
          # Download and install
          curl -LO https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF#refs/tags/}/offgrid-${GITHUB_REF#refs/tags/}-darwin-arm64.dmg
          open offgrid-${GITHUB_REF#refs/tags/}-darwin-arm64.dmg
          ```
          
          #### Windows
          ```powershell
          # Download and extract
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF#refs/tags/}/offgrid-${GITHUB_REF#refs/tags/}-windows-amd64.zip" -OutFile offgrid.zip
          Expand-Archive offgrid.zip -DestinationPath offgrid
          cd offgrid
          
          # Install
          .\install.ps1
          ```
          
          ### What's Included
          
          - ✅ Pre-compiled binaries for all platforms
          - ✅ Bundled llama-server (llama.cpp)
          - ✅ Installation scripts
          - ✅ Documentation
          
          ### Supported Platforms
          
          - Linux (x86_64, ARM64)
          - macOS (Intel, Apple Silicon)
          - Windows (x86_64, ARM64)
          
          ### Verify Downloads
          
          Check integrity with SHA256 checksums in `checksums.txt`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
