name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0-alpha'

env:
  GO_VERSION: '1.21'
  LLAMA_CPP_VERSION: 'b4288'  # Specify llama.cpp release or commit

jobs:
  # Build llama.cpp binaries for all platforms
  build-llama-cpp:
    name: Build llama.cpp - ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            output: llama-server
            cmake_flags: -DGGML_NATIVE=OFF
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            output: llama-server
            cmake_flags: -DGGML_NATIVE=OFF
          # macOS builds
          - os: darwin
            arch: amd64
            runner: macos-13  # Intel runner
            output: llama-server
            cmake_flags: -DGGML_METAL=ON -DGGML_NATIVE=OFF
          - os: darwin
            arch: arm64
            runner: macos-14  # Apple Silicon runner
            output: llama-server
            cmake_flags: -DGGML_METAL=ON -DGGML_NATIVE=OFF
          # Windows builds
          - os: windows
            arch: amd64
            runner: windows-latest
            output: llama-server.exe
            cmake_flags: -DGGML_NATIVE=OFF

    steps:
      - name: Checkout llama.cpp
        uses: actions/checkout@v4
        with:
          repository: ggerganov/llama.cpp
          ref: ${{ env.LLAMA_CPP_VERSION }}

      - name: Install build dependencies (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Install build dependencies (macOS)
        if: matrix.os == 'darwin'
        run: |
          brew install cmake

      - name: Build llama-server
        run: |
          mkdir build
          cd build
          cmake .. ${{ matrix.cmake_flags }} -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release --target llama-server -j$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          if [ "${{ matrix.os }}" = "windows" ]; then
            cp build/bin/Release/${{ matrix.output }} artifact/ || cp build/bin/${{ matrix.output }} artifact/
          else
            cp build/bin/${{ matrix.output }} artifact/
          fi
        shell: bash

      - name: Upload llama-server artifact
        uses: actions/upload-artifact@v4
        with:
          name: llama-server-${{ matrix.os }}-${{ matrix.arch }}
          path: artifact/${{ matrix.output }}
          retention-days: 1

  # Build OffGrid LLM Go binaries
  build-offgrid:
    name: Build OffGrid - ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            os: linux
            arch: amd64
          - goos: linux
            goarch: arm64
            os: linux
            arch: arm64
          - goos: darwin
            goarch: amd64
            os: darwin
            arch: amd64
          - goos: darwin
            goarch: arm64
            os: darwin
            arch: arm64
          - goos: windows
            goarch: amd64
            os: windows
            arch: amd64
          - goos: windows
            goarch: arm64
            os: windows
            arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Build binary
        run: |
          BINARY_NAME="offgrid"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_NAME="offgrid.exe"
          fi
          
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
          go build -ldflags "-X main.Version=${{ steps.version.outputs.version }}" \
            -o ${BINARY_NAME} ./cmd/offgrid

      - name: Upload OffGrid artifact
        uses: actions/upload-artifact@v4
        with:
          name: offgrid-${{ matrix.os }}-${{ matrix.arch }}
          path: offgrid${{ matrix.goos == 'windows' && '.exe' || '' }}
          retention-days: 1

  # Package for Linux (tar.gz archives)
  package-linux:
    name: Package Linux
    needs: [build-llama-cpp, build-offgrid]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OffGrid binary
        uses: actions/download-artifact@v4
        with:
          name: offgrid-linux-${{ matrix.arch }}
          path: package/

      - name: Download llama-server binary
        uses: actions/download-artifact@v4
        with:
          name: llama-server-linux-${{ matrix.arch }}
          path: package/

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create package structure
        run: |
          mkdir -p package/bin
          chmod +x package/offgrid package/llama-server
          mv package/offgrid package/bin/
          mv package/llama-server package/bin/
          
          # Copy documentation
          cp README.md package/
          cp LICENSE package/
          
          # Create install script
          cat > package/install.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Installing OffGrid LLM..."
          
          # Install binaries
          sudo install -m 755 bin/offgrid /usr/local/bin/offgrid
          sudo install -m 755 bin/llama-server /usr/local/bin/llama-server
          
          # Create config directory
          mkdir -p ~/.config/offgrid
          
          echo "✓ Installation complete!"
          echo "Run 'offgrid --help' to get started"
          EOF
          
          chmod +x package/install.sh

      - name: Create tar.gz archive
        run: |
          cd package
          tar -czf ../offgrid-${{ steps.version.outputs.version }}-linux-${{ matrix.arch }}.tar.gz .

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: package-linux-${{ matrix.arch }}
          path: offgrid-*.tar.gz

  # Package for macOS (DMG)
  package-macos:
    name: Package macOS
    needs: [build-llama-cpp, build-offgrid]
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OffGrid binary
        uses: actions/download-artifact@v4
        with:
          name: offgrid-darwin-${{ matrix.arch }}
          path: artifacts/

      - name: Download llama-server binary
        uses: actions/download-artifact@v4
        with:
          name: llama-server-darwin-${{ matrix.arch }}
          path: artifacts/

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create application bundle
        run: |
          chmod +x artifacts/offgrid artifacts/llama-server
          bash build/macos/create-app-bundle.sh \
            artifacts/offgrid \
            artifacts/llama-server \
            ${{ steps.version.outputs.version }}

      - name: Create DMG
        run: |
          bash build/macos/create-dmg.sh \
            ${{ steps.version.outputs.version }} \
            ${{ matrix.arch }}

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: package-darwin-${{ matrix.arch }}
          path: '*.dmg'

  # Package for Windows (ZIP + Installer)
  package-windows:
    name: Package Windows
    needs: [build-llama-cpp, build-offgrid]
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OffGrid binary
        uses: actions/download-artifact@v4
        with:
          name: offgrid-windows-${{ matrix.arch }}
          path: package/

      - name: Download llama-server binary
        uses: actions/download-artifact@v4
        with:
          name: llama-server-windows-${{ matrix.arch }}
          path: package/

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create package structure
        shell: bash
        run: |
          # Copy documentation
          cp README.md package/
          cp LICENSE package/
          
          # Copy install script
          cp installers/install-windows.ps1 package/install.ps1

      - name: Create ZIP archive
        shell: bash
        run: |
          cd package
          7z a ../offgrid-${{ steps.version.outputs.version }}-windows-${{ matrix.arch }}.zip .

      - name: Upload ZIP package
        uses: actions/upload-artifact@v4
        with:
          name: package-windows-${{ matrix.arch }}
          path: '*.zip'

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [package-linux, package-macos, package-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: package-*

      - name: Organize artifacts
        run: |
          mkdir -p release
          find dist -name "*.tar.gz" -exec mv {} release/ \;
          find dist -name "*.dmg" -exec mv {} release/ \;
          find dist -name "*.zip" -exec mv {} release/ \;
          ls -lh release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## OffGrid LLM ${GITHUB_REF#refs/tags/}
          
          ### What's New
          
          Edge-optimized AI inference system with cross-platform support.
          
          ### Installation
          
          #### Linux
          ```bash
          # Download and extract
          wget https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF#refs/tags/}/offgrid-${GITHUB_REF#refs/tags/}-linux-amd64.tar.gz
          tar -xzf offgrid-${GITHUB_REF#refs/tags/}-linux-amd64.tar.gz
          cd offgrid-${GITHUB_REF#refs/tags/}-linux-amd64
          
          # Install
          sudo ./install.sh
          ```
          
          #### macOS
          ```bash
          # Download and install
          curl -LO https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF#refs/tags/}/offgrid-${GITHUB_REF#refs/tags/}-darwin-arm64.dmg
          open offgrid-${GITHUB_REF#refs/tags/}-darwin-arm64.dmg
          ```
          
          #### Windows
          ```powershell
          # Download and extract
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF#refs/tags/}/offgrid-${GITHUB_REF#refs/tags/}-windows-amd64.zip" -OutFile offgrid.zip
          Expand-Archive offgrid.zip -DestinationPath offgrid
          cd offgrid
          
          # Install
          .\install.ps1
          ```
          
          ### What's Included
          
          - ✅ Pre-compiled binaries for all platforms
          - ✅ Bundled llama-server (llama.cpp)
          - ✅ Installation scripts
          - ✅ Documentation
          
          ### Supported Platforms
          
          - Linux (x86_64, ARM64)
          - macOS (Intel, Apple Silicon)
          - Windows (x86_64, ARM64)
          
          ### Verify Downloads
          
          Check integrity with SHA256 checksums in `checksums.txt`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
