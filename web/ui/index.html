<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OffGrid LLM - v0.1.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { background: #0f172a; color: #e2e8f0; }
        .tab-active { background: #1e293b; border-bottom: 2px solid #10b981; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: #10b981; color: white; }
        .btn-primary:hover { background: #059669; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-slate-900 border-b border-slate-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-emerald-400">OffGrid LLM</h1>
            <div class="flex items-center gap-4">
                <span class="text-sm text-slate-400">v0.1.2</span>
                <div class="flex items-center gap-2">
                    <span class="status-dot status-online"></span>
                    <span class="text-sm" id="serverStatus">Server Online</span>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-slate-900 border-b border-slate-700 px-6">
        <div class="flex gap-1">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active px-4 py-3 text-sm font-medium">Dashboard</button>
            <button onclick="switchTab('chat')" id="tab-chat" class="px-4 py-3 text-sm font-medium hover:bg-slate-800">Chat</button>
            <button onclick="switchTab('library')" id="tab-library" class="px-4 py-3 text-sm font-medium hover:bg-slate-800">Library</button>
            <button onclick="switchTab('sessions')" id="tab-sessions" class="px-4 py-3 text-sm font-medium hover:bg-slate-800">Sessions</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="px-4 py-3 text-sm font-medium hover:bg-slate-800">Settings</button>
            <button onclick="switchTab('help')" id="tab-help" class="px-4 py-3 text-sm font-medium hover:bg-slate-800">Help</button>
        </div>
    </nav>

    <main class="container mx-auto p-6">
        <div id="content-dashboard" class="space-y-6">
            <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="card">
                    <h3 class="text-sm font-semibold text-slate-400 mb-2">CPU & RAM</h3>
                    <div class="text-2xl font-bold text-emerald-400" id="ramStatus">Loading...</div>
                    <div class="text-xs text-slate-400 mt-1" id="ramDetails"></div>
                </div>
                
                <div class="card">
                    <h3 class="text-sm font-semibold text-slate-400 mb-2">GPU</h3>
                    <div class="text-2xl font-bold text-cyan-400" id="gpuStatus">Checking...</div>
                    <div class="text-xs text-slate-400 mt-1" id="gpuDetails"></div>
                </div>
                
                <div class="card">
                    <h3 class="text-sm font-semibold text-slate-400 mb-2">Disk Space</h3>
                    <div class="text-2xl font-bold text-blue-400" id="diskStatus">Loading...</div>
                    <div class="text-xs text-slate-400 mt-1" id="diskDetails"></div>
                </div>
            </div>

            <div class="card">
                <h3 class="text-lg font-semibold mb-4">Active Model</h3>
                <div id="activeModelInfo">
                    <p class="text-slate-400">No model currently loaded</p>
                    <button onclick="switchTab('library')" class="btn btn-primary mt-4">Load Model</button>
                </div>
            </div>

            <div class="card">
                <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="switchTab('chat')" class="btn btn-primary">Start Chat</button>
                    <button onclick="switchTab('library')" class="btn bg-slate-700 hover:bg-slate-600 text-white">Browse Models</button>
                    <button onclick="switchTab('sessions')" class="btn bg-slate-700 hover:bg-slate-600 text-white">View Sessions</button>
                    <button onclick="loadSystemHealth()" class="btn bg-slate-700 hover:bg-slate-600 text-white">Refresh</button>
                </div>
            </div>
        </div>

        <div id="content-chat" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-3xl font-bold">Chat</h2>
                <div class="flex items-center gap-4">
                    <select id="chatModelSelect" class="bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm">
                        <option value="">Select Model...</option>
                    </select>
                    <button onclick="clearChat()" class="btn bg-slate-700 hover:bg-slate-600 text-white text-sm">Clear</button>
                    <button onclick="saveCurrentSession()" class="btn btn-primary text-sm">Save</button>
                </div>
            </div>

            <div class="card mb-4" style="height: 500px; overflow-y: auto;" id="chatMessages">
                <div class="text-center text-slate-400 py-20">
                    <p class="text-lg mb-2">No messages yet</p>
                    <p class="text-sm">Select a model and start chatting</p>
                </div>
            </div>

            <div class="card">
                <div class="flex gap-4">
                    <textarea id="chatInput" rows="3" placeholder="Type your message..." 
                        class="flex-1 bg-slate-900 border border-slate-700 rounded px-4 py-3 resize-none focus:outline-none focus:border-emerald-500"
                        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChatMessage();}"></textarea>
                    <button onclick="sendChatMessage()" class="btn btn-primary px-8">Send</button>
                </div>
                <div class="flex items-center gap-4 mt-4 text-sm text-slate-400">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="streamMode" checked class="rounded">
                        <span>Stream</span>
                    </label>
                    <span>Press Enter to send, Shift+Enter for new line</span>
                </div>
            </div>
        </div>

        <div id="content-library" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Model Library</h2>
            
            <div class="card mb-6">
                <div class="flex gap-4 mb-4">
                    <input type="text" id="librarySearch" placeholder="Search models..." 
                        class="flex-1 bg-slate-900 border border-slate-700 rounded px-4 py-2 focus:outline-none focus:border-emerald-500"
                        oninput="filterLibrary()">
                    <select id="libraryFilter" class="bg-slate-900 border border-slate-700 rounded px-4 py-2" onchange="filterLibrary()">
                        <option value="all">All Models</option>
                        <option value="installed">Installed</option>
                        <option value="catalog">Catalog</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadInstalledModels()" class="btn btn-primary text-sm">Installed Models</button>
                    <button onclick="loadCatalog()" class="btn bg-slate-700 hover:bg-slate-600 text-white text-sm">Browse Catalog</button>
                </div>
            </div>

            <div id="libraryContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center text-slate-400 py-20">
                    <p class="text-lg mb-2">No models loaded</p>
                    <p class="text-sm">Click "Installed Models" or "Browse Catalog"</p>
                </div>
            </div>
        </div>

        <div id="content-sessions" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Sessions</h2>
            
            <div class="card mb-4">
                <button onclick="loadSessions()" class="btn btn-primary mb-4">Load Sessions</button>
                <div id="sessionsList"></div>
            </div>
        </div>

        <div id="content-settings" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Settings</h2>
            
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">Inference Settings</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Temperature: <span id="tempValue">0.7</span></label>
                            <input type="range" min="0" max="2" step="0.1" value="0.7" id="tempSetting" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Max Tokens</label>
                            <input type="number" value="2000" id="maxTokensSetting" class="bg-slate-900 border border-slate-700 rounded px-4 py-2 w-full">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">About</h3>
                    <p class="text-sm text-slate-400 mb-2">OffGrid LLM v0.1.2</p>
                    <p class="text-xs text-slate-500">Offline-first LLM inference system</p>
                </div>
            </div>
        </div>

        <div id="content-help" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Help & Documentation</h2>
            
            <div class="space-y-4">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3 text-emerald-400">Getting Started</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm text-slate-300">
                        <li>Go to Library and click "Browse Catalog"</li>
                        <li>Select a model and click "Download"</li>
                        <li>Once downloaded, click "Run" to load the model</li>
                        <li>Go to Chat tab to start chatting</li>
                    </ol>
                </div>

                <div class="card">
                    <h3 class="text-lg font-semibold mb-3 text-cyan-400">CLI Commands</h3>
                    <pre class="text-xs bg-slate-900 p-3 rounded"><code>offgrid catalog              # List available models
offgrid download &lt;model&gt;     # Download a model
offgrid run &lt;model&gt;          # Run a model
offgrid chat                 # Interactive chat
offgrid doctor               # System diagnostics</code></pre>
                </div>
            </div>
        </div>
    </main>

    <script>
        function switchTab(tabName) {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));
            document.getElementById('tab-' + tabName).classList.add('tab-active');
        }

        async function loadSystemHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                if (data.system) {
                    document.getElementById('ramStatus').textContent = Math.round(data.system.memory_percent) + '%';
                    document.getElementById('ramDetails').textContent = Math.round(data.system.memory_mb) + ' MB used';
                    document.getElementById('diskStatus').textContent = data.system.disk_free_gb + ' GB';
                    document.getElementById('diskDetails').textContent = 'Available storage';
                }
                
                if (data.models_loaded > 0) {
                    document.getElementById('activeModelInfo').innerHTML = '<p class="font-semibold text-emerald-400">Model Active</p><p class="text-sm text-slate-400">' + data.models_loaded + ' model(s) loaded</p><button onclick="switchTab(\'chat\')" class="btn btn-primary mt-4">Chat Now</button>';
                }
            } catch (error) {
                console.error('Failed to load health:', error);
            }
        }

        let chatMessages = [];
        let currentModel = '';

        async function loadModelsForChat() {
            try {
                const response = await fetch('/models');
                const result = await response.json();
                const models = result.data || result.models || result;
                const select = document.getElementById('chatModelSelect');
                select.innerHTML = '<option value="">Select Model...</option>';
                models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id || m.name || m;
                    opt.textContent = m.id || m.name || m;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Failed to load models:', error);
                console.error('Response:', error);
                const select = document.getElementById('chatModelSelect');
                select.innerHTML = '<option value="">âš  Failed to load models</option>';
            }
        }

        document.getElementById('chatModelSelect').addEventListener('change', function() {
            currentModel = this.value;
        });

        function clearChat() {
            chatMessages = [];
            document.getElementById('chatMessages').innerHTML = '<div class="text-center text-slate-400 py-20"><p class="text-lg mb-2">No messages yet</p><p class="text-sm">Select a model and start chatting</p></div>';
        }

        function addMessage(role, content) {
            const container = document.getElementById('chatMessages');
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }
            const msgDiv = document.createElement('div');
            msgDiv.className = 'p-4 rounded-lg mb-4 ' + (role === 'user' ? 'bg-emerald-900/20 border border-emerald-500/30' : 'bg-slate-800/50 border border-slate-700');
            msgDiv.innerHTML = '<div class="text-xs font-semibold mb-2 ' + (role === 'user' ? 'text-emerald-400' : 'text-cyan-400') + '">' + (role === 'user' ? 'You' : 'Assistant') + '</div><div class="text-sm whitespace-pre-wrap">' + content + '</div>';
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (!currentModel) {
                alert('Please select a model first');
                return;
            }

            input.value = '';
            chatMessages.push({ role: 'user', content: message });
            addMessage('user', message);

            try {
                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: chatMessages,
                        stream: document.getElementById('streamMode').checked,
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (document.getElementById('streamMode').checked) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let assistantMessage = '';
                    const container = document.getElementById('chatMessages');
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'p-4 rounded-lg mb-4 bg-slate-800/50 border border-slate-700';
                    msgDiv.innerHTML = '<div class="text-xs font-semibold mb-2 text-cyan-400">Assistant</div><div class="text-sm whitespace-pre-wrap"></div>';
                    container.appendChild(msgDiv);

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                try {
                                    const json = JSON.parse(data);
                                    const content = json.choices?.[0]?.delta?.content;
                                    if (content) {
                                        assistantMessage += content;
                                        msgDiv.querySelector('div:last-child').textContent = assistantMessage;
                                        container.scrollTop = container.scrollHeight;
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                    chatMessages.push({ role: 'assistant', content: assistantMessage });
                } else {
                    const data = await response.json();
                    const assistantMessage = data.choices[0].message.content;
                    chatMessages.push({ role: 'assistant', content: assistantMessage });
                    addMessage('assistant', assistantMessage);
                }
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('system', 'Error: Failed to get response. Make sure a model is loaded.');
            }
        }

        function saveCurrentSession() {
            if (chatMessages.length === 0) {
                alert('No messages to save');
                return;
            }
            
            const sessionName = prompt('Enter session name:', 'chat-' + new Date().toISOString().split('T')[0]);
            if (!sessionName) return;

            const sessions = JSON.parse(localStorage.getItem('offgrid-sessions') || '[]');
            sessions.push({
                name: sessionName,
                model: currentModel,
                messages: chatMessages,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('offgrid-sessions', JSON.stringify(sessions));
            alert('Session saved!');
        }

        let libraryModels = [];

        async function loadInstalledModels() {
            try {
                const response = await fetch('/models');
                const models = await response.json();
                libraryModels = models.map(m => ({
                    name: m.name || m,
                    type: 'installed',
                    size: m.size || 'Unknown'
                }));
                displayLibraryModels(libraryModels);
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        async function loadCatalog() {
            try {
                const response = await fetch('/catalog');
                const catalog = await response.json();
                libraryModels = catalog.map(m => ({
                    name: m.name,
                    description: m.description || '',
                    type: 'catalog',
                    size: m.size || 'Unknown'
                }));
                displayLibraryModels(libraryModels);
            } catch (error) {
                console.error('Failed to load catalog:', error);
            }
        }

        function displayLibraryModels(models) {
            const container = document.getElementById('libraryContent');
            if (models.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-slate-400 py-20"><p>No models found</p></div>';
                return;
            }

            container.innerHTML = models.map(model => 
                '<div class="card"><div class="flex items-start justify-between mb-3"><h3 class="font-semibold text-emerald-400">' + model.name + '</h3><span class="text-xs px-2 py-1 rounded ' + (model.type === 'installed' ? 'bg-emerald-900/30 text-emerald-400' : 'bg-slate-700 text-slate-300') + '">' + model.type + '</span></div>' + (model.description ? '<p class="text-xs text-slate-400 mb-3">' + model.description + '</p>' : '') + '<div class="text-xs text-slate-500 mb-3">Size: ' + model.size + '</div><div class="flex gap-2">' + (model.type === 'installed' ? '<button onclick="alert(\'Use CLI: offgrid run ' + model.name + '\')" class="btn btn-primary text-xs flex-1">Run</button>' : '<button onclick="alert(\'Use CLI: offgrid download ' + model.name + '\')" class="btn btn-primary text-xs flex-1">Download</button>') + '</div></div>'
            ).join('');
        }

        function filterLibrary() {
            const search = document.getElementById('librarySearch').value.toLowerCase();
            const filter = document.getElementById('libraryFilter').value;
            
            let filtered = libraryModels;
            if (filter !== 'all') {
                filtered = filtered.filter(m => m.type === filter);
            }
            if (search) {
                filtered = filtered.filter(m => m.name.toLowerCase().includes(search));
            }
            displayLibraryModels(filtered);
        }

        function loadSessions() {
            const sessions = JSON.parse(localStorage.getItem('offgrid-sessions') || '[]');
            const container = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-slate-400">No saved sessions</p>';
                return;
            }
            
            container.innerHTML = sessions.map((session, index) => 
                '<div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 mb-3"><div class="flex items-center justify-between mb-2"><h4 class="font-semibold text-emerald-400">' + session.name + '</h4><button onclick="deleteSession(' + index + ')" class="text-red-400 hover:text-red-300 text-xs">Delete</button></div><p class="text-xs text-slate-500 mb-2">Model: ' + (session.model || 'Unknown') + '</p><p class="text-xs text-slate-500 mb-3">' + (session.messages?.length || 0) + ' messages</p><button onclick="restoreSession(' + index + ')" class="btn btn-primary text-xs">Restore</button></div>'
            ).join('');
        }

        function restoreSession(index) {
            const sessions = JSON.parse(localStorage.getItem('offgrid-sessions') || '[]');
            const session = sessions[index];
            if (!session) return;
            
            chatMessages = session.messages || [];
            currentModel = session.model || '';
            document.getElementById('chatModelSelect').value = currentModel;
            document.getElementById('chatMessages').innerHTML = '';
            chatMessages.forEach(msg => addMessage(msg.role, msg.content));
            switchTab('chat');
        }

        function deleteSession(index) {
            if (!confirm('Delete this session?')) return;
            const sessions = JSON.parse(localStorage.getItem('offgrid-sessions') || '[]');
            sessions.splice(index, 1);
            localStorage.setItem('offgrid-sessions', JSON.stringify(sessions));
            loadSessions();
        }

        document.getElementById('tempSetting').addEventListener('input', function() {
            document.getElementById('tempValue').textContent = this.value;
        });

        document.getElementById('tab-chat').addEventListener('click', loadModelsForChat);
        loadModelsForChat();
        loadSystemHealth();
        setInterval(loadSystemHealth, 5000);
    </script>
</body>
</html>
