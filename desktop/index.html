<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>OffGrid LLM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Terminal Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme - Clean & Crisp */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb; /* Gray 50 - Very subtle gray */
            --bg-tertiary: #f3f4f6; /* Gray 100 */
            --text-primary: #111827; /* Gray 900 */
            --text-secondary: #6b7280; /* Gray 500 */
            --accent-primary: #06b6d4; /* Cyan 500 */
            --accent-hover: #0891b2; /* Cyan 600 */
            --accent-primary-alpha: rgba(6, 182, 212, 0.1);
            --border-color: #e5e7eb; /* Gray 200 */
            --card-bg: #ffffff;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --input-bg: #ffffff;
            --input-border: #d1d5db; /* Gray 300 */
            --code-bg: #f9fafb;
            --code-inline-bg: #f3f4f6;
            --header-bg: rgba(255, 255, 255, 0.9);
            --nav-bg: #f9fafb;
            --message-user-bg: #f3f4f6; /* Gray 100 - Neutral for user */
            --message-assistant-bg: transparent;
            --scrollbar-track: transparent;
            --scrollbar-thumb: #d1d5db;
            --scrollbar-thumb-hover: #9ca3af;
            --terminal-bg: #111827; /* Gray 900 */
            --terminal-text: #e5e7eb;
            --success-color: #10b981; /* Emerald 500 */
            
            /* ANSI Colors */
            --ansi-black: #374151;
            --ansi-cyan: #06b6d4;
            --ansi-green: #10b981;
            --ansi-yellow: #f59e0b;
            --ansi-red: #ef4444;
            --ansi-blue: #3b82f6;
            --ansi-magenta: #d946ef;
            --ansi-white: #f9fafb;
            --ansi-gray: #9ca3af;
        }

        [data-theme="dark"] {
            /* Dark Theme - True Neutral (No Blue Tint) */
            --bg-primary: #0a0a0a; /* Neutral 950 - True Black/Gray */
            --bg-secondary: #171717; /* Neutral 900 */
            --bg-tertiary: #262626; /* Neutral 800 */
            --text-primary: #fafafa; /* Neutral 50 */
            --text-secondary: #a3a3a3; /* Neutral 400 */
            --accent-primary: #06b6d4; /* Cyan 500 */
            --accent-hover: #0891b2; /* Cyan 600 */
            --accent-primary-alpha: rgba(6, 182, 212, 0.15);
            --border-color: #262626;
            --card-bg: #171717;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --input-bg: #171717;
            --input-border: #404040;
            --code-bg: #000000;
            --code-inline-bg: rgba(255, 255, 255, 0.08);
            --header-bg: rgba(10, 10, 10, 0.9);
            --nav-bg: #171717;
            --message-user-bg: #262626; /* Neutral 800 */
            --message-assistant-bg: transparent;
            --scrollbar-track: transparent;
            --scrollbar-thumb: #404040;
            --scrollbar-thumb-hover: #525252;
            --terminal-bg: #000000;
            --terminal-text: #e5e5e5;
            --success-color: #34d399;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
        }
        
        body { 
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: row; /* Changed to row for sidebar layout */
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            padding: 24px 16px;
            z-index: 20;
            height: 100%;
        }

        .sidebar-header {
            margin-bottom: 24px;
            padding: 0 12px;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.02em;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .nav-item.active .nav-icon {
            color: var(--accent-primary);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            stroke-width: 2px;
            color: inherit;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 12px;
            padding-right: 12px;
        }

        /* Main Content Area */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
            position: relative;
        }

        .text-accent { color: var(--accent-primary); }
        .text-secondary { color: var(--text-secondary); }
        .bg-primary { background: var(--bg-primary); }
        .bg-secondary { background: var(--bg-secondary); }
        .border-theme { border-color: var(--border-color); }
        
        .input-theme {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .input-theme:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary-alpha);
            outline: none;
        }
        
        .bg-tertiary { background: var(--bg-tertiary); }
        .bg-card { background: var(--card-bg); }
        
        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .card { 
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            font-size: 14px;
            font-weight: 500;
            outline: none;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover:not(:disabled) {
            opacity: 1;
            transform: translateY(-1px);
            filter: brightness(1.1);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn-sm { 
            padding: 4px 12px; 
            font-size: 12px; 
        }
        
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
        }
        
        .btn-primary { 
            background: var(--accent-primary);
            color: white; 
        }
        
        .btn-primary:hover:not(:disabled) { 
            background: var(--accent-hover);
        }
        
        .btn-secondary { 
            background: var(--bg-tertiary);
            color: var(--text-primary); 
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover:not(:disabled) { 
            background: var(--bg-secondary);
        }
        
        .btn-danger { 
            background: #f14c4c;
            color: white; 
        }
        
        .btn-danger:hover:not(:disabled) { 
            background: #d63b3b;
        }
        
        .btn-info { 
            background: var(--accent-primary);
            color: white; 
        }
        
        .btn-info:hover:not(:disabled) { 
            background: var(--accent-hover);
        }
        
        .tab { 
            padding: 10px 16px; 
            cursor: pointer; 
            border-bottom: 1px solid transparent; 
            transition: all 0.2s ease;
            font-weight: 400;
            color: var(--text-secondary);
        }
        
        .tab:hover { 
            color: var(--text-primary);
        }
        
        .tab.active { 
            border-bottom-color: var(--accent-primary);
            color: var(--text-primary);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message { 
            padding: 24px 0;
            margin-bottom: 0;
            word-wrap: break-word;
            border-bottom: 1px solid transparent;
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .message:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .message-wrapper {
            max-width: 56rem;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .message-user { 
            background: var(--message-user-bg);
        }
        
        .message-user .message-wrapper {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        
        .message-assistant { 
            background: var(--message-assistant-bg);
        }
        
        .message-assistant .message-wrapper {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .message-user .message-avatar {
            background: var(--accent-primary);
            color: white;
        }
        
        .message-assistant .message-avatar {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            color: white;
        }
        
        .message-body {
            flex: 1;
            min-width: 0;
            line-height: 1.6;
            font-size: 15px;
        }
        
        .message-actions { 
            display: flex; 
            gap: 8px; 
            margin-top: 12px; 
        }
        
        /* Modal Overlay Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }
        
        .modal-dialog {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .modal-dialog.warning {
            border-top: 4px solid #cca700;
        }
        
        .modal-dialog.error {
            border-top: 4px solid #f14c4c;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .modal-icon {
            font-size: 24px;
            line-height: 1;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-body {
            margin-bottom: 24px;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        /* Agent Step Styles */
        .agent-step {
            padding: 16px;
            border-radius: 8px;
            border-left: 3px solid;
            margin-bottom: 12px;
            background: var(--bg-tertiary);
        }
        
        .agent-step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .agent-step-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .agent-step-indicator.streaming {
            background: #10b981;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .agent-step-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .agent-step-number {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .agent-step-tool {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            font-weight: 600;
        }
        
        .agent-step-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
        }
        
        .agent-step-meta {
            margin-top: 12px;
        }
        
        .agent-step-meta-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .agent-step-code {
            font-family: 'JetBrains Mono', 'SF Mono', monospace;
            font-size: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            overflow-x: auto;
            max-height: 150px;
            margin: 0;
        }
        
        .agent-step-code.result {
            background: rgba(16, 185, 129, 0.08);
            border-color: rgba(16, 185, 129, 0.2);
        }
        
        /* Step type variants */
        .agent-step-thought {
            border-color: #3b82f6;
        }
        .agent-step-thought .agent-step-indicator { background: #3b82f6; }
        .agent-step-thought .agent-step-label { color: #3b82f6; }
        
        .agent-step-action {
            border-color: #f59e0b;
        }
        .agent-step-action .agent-step-indicator { background: #f59e0b; }
        .agent-step-action .agent-step-label { color: #f59e0b; }
        
        .agent-step-observation {
            border-color: #10b981;
        }
        .agent-step-observation .agent-step-indicator { background: #10b981; }
        .agent-step-observation .agent-step-label { color: #10b981; }
        
        .agent-step-answer, .agent-step-complete {
            border-color: #06b6d4;
        }
        .agent-step-answer .agent-step-indicator,
        .agent-step-complete .agent-step-indicator { background: #06b6d4; }
        .agent-step-answer .agent-step-label,
        .agent-step-complete .agent-step-label { color: #06b6d4; }
        
        .agent-step-error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.08);
        }
        .agent-step-error .agent-step-indicator { background: #ef4444; }
        .agent-step-error .agent-step-label { color: #ef4444; }
        
        .agent-step-streaming {
            border-color: #10b981;
        }
        .agent-step-streaming .agent-step-label { color: #10b981; }
        
        .agent-step-step {
            border-color: #8b5cf6;
        }
        .agent-step-step .agent-step-indicator { background: #8b5cf6; }
        .agent-step-step .agent-step-label { color: #8b5cf6; }
        
        .agent-step-default {
            border-color: var(--text-secondary);
        }

        .terminal-card {
            background: #0d1117 !important;
            border: 1px solid #21262d !important;
            box-shadow: none !important;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .terminal-card:hover {
            border-color: #30363d !important;
            box-shadow: none !important;
            transform: none;
        }
        
        .terminal-output { 
            overflow-y: auto;
            overflow-x: auto;
            padding: 16px;
            background: #0d1117;
            flex: 1;
            min-height: 0;
        }

        .terminal-pre {
            line-height: 1.6;
            font-size: 13px;
        }
        
        /* Custom scrollbar for terminal */
        .terminal-output::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        .terminal-output::-webkit-scrollbar-track {
            background: #0d1117;
        }
        
        .terminal-output::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 5px;
        }
        
        .terminal-output::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        
        /* Terminal pre block - THE KEY to proper formatting */
        #terminalPre {
            margin: 0;
            padding: 0;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #c9d1d9;
            white-space: pre;
            word-wrap: normal;
            overflow-wrap: normal;
        }
        
        /* ANSI color classes - GitHub dark theme inspired */
        .ansi-black { color: #484f58; }
        .ansi-cyan { color: #06b6d4; }
        .ansi-green { color: #7ee787; }
        .ansi-yellow { color: #e3b341; }
        .ansi-red { color: #f85149; }
        .ansi-blue { color: #58a6ff; }
        .ansi-magenta { color: #bc8cff; }
        .ansi-purple { color: #bc8cff; }
        .ansi-gray { color: #8b949e; }
        .ansi-white { color: #c9d1d9; }
        .ansi-bold { font-weight: bold; }
        .ansi-dim { color: #6e7681; }
        .ansi-normal { font-weight: normal; }
        
        .terminal-error { 
            color: #f85149;
            font-weight: 500; 
        }
        
        .terminal-success { 
            color: #58a6ff; 
            font-weight: 500; 
        }
        
        .terminal-prompt { 
            color: #7ee787;
            font-weight: 600;
            margin-top: 12px;
            margin-bottom: 2px;
            display: block;
            padding-left: 0;
            font-family: inherit;
        }
        
        .terminal-prompt::before {
            content: 'â¯ ';
            color: #7ee787;
        }
        
        /* Progress bar styling */
        .terminal-progress {
            background: #21262d;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 4px 0;
        }
        
        .terminal-progress-bar {
            height: 4px;
            background: #30363d;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 6px;
        }
        
        .terminal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #238636, #2ea043);
            transition: width 0.2s ease;
        }
        
        .terminal-input-line { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 12px 16px;
            border-top: 1px solid #21262d;
            background: #0d1117;
        }

        .terminal-input-line .terminal-prompt {
            margin: 0;
            padding: 0;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            color: #7ee787;
            font-weight: 500;
        }
        
        .terminal-input { 
            background: transparent; 
            border: none; 
            color: #c9d1d9; 
            flex: 1; 
            outline: none; 
            box-shadow: none !important;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 13px; 
        }
        
        .terminal-input::placeholder {
            color: #6e7681;
        } 
        }
        
        .terminal-running { 
            opacity: 0.6; 
            pointer-events: none; 
        }
        
        .model-item { 
            padding: 16px; 
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            box-shadow: var(--card-shadow);
        }
        
        .model-item:hover { 
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            box-shadow: 0 2px 8px rgba(0, 188, 212, 0.15);
        }
        
        .badge { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .badge-success { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; 
        }
        
        .badge-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white; 
        }
        
        .badge-error { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white; 
        }
        
        .badge-info { 
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white; 
        }
        
        .hidden { 
            display: none; 
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        
        .chat-container { 
            display: flex; 
            flex-direction: column; 
            height: calc(100vh - 220px);
            min-height: 600px;
        }
        
        .chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 16px; 
        }
        
        .chat-input-area { 
            padding: 16px; 
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        
        .scrollable { 
            overflow-y: auto; 
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }
        
        .scrollable::-webkit-scrollbar { 
            width: 8px; 
        }
        
        .scrollable::-webkit-scrollbar-track { 
            background: transparent;
            border-radius: 4px;
        }
        
        .scrollable::-webkit-scrollbar-thumb { 
            background: var(--scrollbar-thumb);
            border-radius: 4px; 
        }
        
        .scrollable::-webkit-scrollbar-thumb:hover { 
            background: var(--scrollbar-thumb-hover);
        }

        /* Global scrollbar styling */
        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        *::-webkit-scrollbar-track {
            background: transparent;
        }
        
        *::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }
        
        *::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) transparent;
        }

        /* Example prompt cards - theme aware */
        .example-prompt-card {
            padding: 1rem;
            text-align: left;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            transition: all 0.2s;
        }
        
        .example-prompt-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }
        
        .example-prompt-card .card-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .example-prompt-card:hover .card-title {
            color: var(--accent-primary);
        }
        
        .example-prompt-card .card-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .settings-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 16px; 
        }
        
        .stat-card { 
            text-align: center; 
            padding: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            transition: box-shadow 0.2s ease;
        }
        
        .stat-card:hover {
            box-shadow: var(--card-shadow);
            border-color: var(--accent-primary);
        }
        
        .stat-value { 
            font-size: 32px; 
            font-weight: 700; 
            color: var(--accent-primary);
        }
        
        /* Thinking indicator animation */
        .thinking-indicator .thinking-dots {
            display: flex;
            gap: 4px;
        }
        
        .thinking-indicator .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: thinking-bounce 1.4s infinite ease-in-out both;
        }
        
        .thinking-indicator .dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .thinking-indicator .dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes thinking-bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .thinking-text {
            animation: thinking-pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes thinking-pulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
        }
        
        .stat-label { 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-top: 6px;
            font-weight: 500;
        }
        
        header {
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }
        
        nav {
            background: transparent;
        }
        
        /* Code block styling */
        .message-content pre {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .message-content code {
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .message-content pre code {
            display: block;
            padding: 0;
            background: transparent;
            border: none;
        }
        
        .message-content :not(pre) > code {
            background: rgba(110, 118, 129, 0.4);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
            color: #e2e8f0;
        }
        
        /* Prose styling for markdown content */
        .message-content.prose {
            max-width: none;
        }
        
        .message-content.prose p {
            margin: 8px 0;
            line-height: 1.7;
        }
        
        .message-content.prose ul, 
        .message-content.prose ol {
            margin: 8px 0;
            padding-left: 24px;
        }
        
        .message-content.prose li {
            margin: 4px 0;
        }
        
        .message-content.prose h1,
        .message-content.prose h2,
        .message-content.prose h3,
        .message-content.prose h4 {
            margin: 16px 0 8px 0;
            font-weight: 600;
            color: #06b6d4;
        }
        
        .message-content.prose h1 { font-size: 1.5em; }
        .message-content.prose h2 { font-size: 1.3em; }
        .message-content.prose h3 { font-size: 1.1em; }
        
        .message-content.prose blockquote {
            border-left: 4px solid #06b6d4;
            padding-left: 16px;
            margin: 12px 0;
            color: #94a3b8;
            font-style: italic;
        }
        
        .message-content.prose a {
            color: #06b6d4;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .message-content.prose a:hover {
            border-bottom-color: #06b6d4;
        }        .message-content.prose table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }
        
        .message-content.prose th,
        .message-content.prose td {
            border: 1px solid #334155;
            padding: 8px 12px;
            text-align: left;
        }
        
        .message-content.prose th {
            background: rgba(6, 182, 212, 0.1);
            font-weight: 600;
            color: #06b6d4;
        }

        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: background 0.3s ease;
            z-index: 10000;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 1);
        }
        
        .theme-toggle svg {
            width: 20px;
            height: 20px;
            stroke: #333;
        }
        
        [data-theme="dark"] .theme-toggle svg {
            stroke: #ccc;
        }

        .border-accent-hover:hover {
            border-color: var(--accent-primary) !important;
        }
        
        .app-nav {
            background: var(--nav-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            flex-shrink: 0;
        }

    </style>
</head>
<body class="antialiased">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>OffGrid</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <button onclick="switchTab('chat')" id="tab-chat" class="nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                Chat
            </button>
            <button onclick="switchTab('knowledge')" id="tab-knowledge" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path><line x1="12" y1="6" x2="12" y2="12"></line><line x1="9" y1="9" x2="15" y2="9"></line></svg>
                Knowledge
            </button>
            <button onclick="switchTab('benchmark')" id="tab-benchmark" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                Benchmark
            </button>
            <button onclick="switchTab('models')" id="tab-models" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                Models
            </button>
            <button onclick="switchTab('terminal')" id="tab-terminal" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                Terminal
            </button>
            
            <div class="my-3 border-t border-theme mx-3"></div>
            <div class="px-3 mb-2 text-xs text-secondary uppercase tracking-wider font-semibold">Advanced</div>
            
            <button onclick="switchTab('agent')" id="tab-agent" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
                Agent
            </button>
            <button onclick="switchTab('lora')" id="tab-lora" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                LoRA
            </button>
            
            <!-- Multi-user features (hidden by default in single-user mode) -->
            <div id="multiUserNav" class="hidden">
                <div class="my-3 border-t border-theme mx-3"></div>
                <div class="px-3 mb-2 text-xs text-secondary uppercase tracking-wider font-semibold">Admin</div>
                <button onclick="switchTab('users')" id="tab-users" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    Users
                </button>
                <button onclick="switchTab('metrics')" id="tab-metrics" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                    Metrics
                </button>
            </div>
        </nav>

        <div class="sidebar-footer">
            <!-- Auth Status -->
            <div id="authStatus" class="w-full mb-2 p-2 bg-tertiary rounded-lg">
                <div id="authLoggedIn" class="hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-accent/20 flex items-center justify-center text-accent text-xs font-bold" id="authUserInitial">U</div>
                            <div>
                                <div class="text-xs font-medium" id="authUsername">User</div>
                                <div class="text-xs text-secondary" id="authRole">user</div>
                            </div>
                        </div>
                        <button onclick="handleLogout()" class="p-1 hover:bg-tertiary rounded text-secondary hover:text-red-400" title="Logout">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        </button>
                    </div>
                </div>
                <div id="authLoggedOut">
                    <button onclick="showLoginModal()" class="w-full text-xs py-1 px-2 bg-accent/20 text-accent rounded hover:bg-accent/30 transition-colors">
                        <svg class="inline w-3 h-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                        Login
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="statusBadge" class="badge badge-success">Ready</span>
                <span class="text-xs text-secondary">v0.2.3</span>
            </div>
            <button id="theme-toggle" class="p-2 rounded-lg hover:bg-tertiary transition-colors text-secondary hover:text-primary" title="Toggle Theme">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Chat Tab -->
        <div id="content-chat" class="h-full flex flex-col overflow-hidden">
            <!-- Simplified Chat Header -->
            <div class="px-4 py-3 border-b border-theme bg-secondary/50 backdrop-blur-sm z-10">
                <div class="flex items-center gap-3">
                    <!-- Model Selector - Primary -->
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <select id="chatModel" class="flex-1 max-w-xs input-theme rounded-lg px-3 py-2 text-sm font-medium" onchange="handleModelChange();">
                            <option value="">Select Model...</option>
                        </select>
                        
                        <!-- Quick Preset Buttons -->
                        <div class="hidden md:flex items-center gap-1 border-l border-theme pl-3 ml-2">
                            <span class="text-xs text-secondary mr-1">Mode:</span>
                            <button onclick="setSystemPrompt('coder')" class="px-2 py-1 text-xs rounded-md bg-tertiary hover:bg-accent/20 text-secondary hover:text-accent transition-colors" title="Code Assistant">
                                Code
                            </button>
                            <button onclick="setSystemPrompt('research')" class="px-2 py-1 text-xs rounded-md bg-tertiary hover:bg-accent/20 text-secondary hover:text-accent transition-colors" title="Research Mode">
                                Research
                            </button>
                            <button onclick="setSystemPrompt('tutor')" class="px-2 py-1 text-xs rounded-md bg-tertiary hover:bg-accent/20 text-secondary hover:text-accent transition-colors" title="Tutor Mode">
                                Tutor
                            </button>
                        </div>
                    </div>
                    
                    <!-- Right Actions -->
                    <div class="flex items-center gap-2">
                        <!-- Knowledge Base Toggle -->
                        <label class="flex items-center gap-1.5 px-2 py-1.5 rounded-lg bg-tertiary hover:bg-accent/10 cursor-pointer transition-colors" title="Use Knowledge Base">
                            <input type="checkbox" id="useKnowledgeBase" class="sr-only peer">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-secondary peer-checked:text-accent transition-colors">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                            <span class="text-xs text-secondary peer-checked:text-accent hidden sm:inline">KB</span>
                        </label>
                        
                        <!-- Settings Dropdown -->
                        <div class="relative">
                            <button onclick="toggleChatSettings()" class="p-2 rounded-lg bg-tertiary hover:bg-accent/10 text-secondary hover:text-primary transition-colors" title="Settings">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                </svg>
                            </button>
                            <!-- Settings Panel -->
                            <div id="chatSettingsPanel" class="hidden absolute right-0 top-full mt-2 w-64 bg-card border border-theme rounded-xl shadow-xl z-50 p-4 space-y-4">
                                <div class="text-xs font-semibold text-secondary uppercase tracking-wide mb-2">Chat Settings</div>
                                
                                <!-- System Prompt -->
                                <div>
                                    <label class="text-xs text-secondary block mb-1">System Prompt</label>
                                    <select id="systemPrompt" onchange="applySystemPrompt()" class="w-full input-theme rounded px-2 py-1.5 text-sm">
                                        <option value="">None</option>
                                        <option value="research">Research Assistant</option>
                                        <option value="tutor">Study Tutor</option>
                                        <option value="coder">Code Reviewer</option>
                                        <option value="writer">Academic Writer</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                </div>
                                
                                <!-- Temperature & Max Tokens -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-secondary block mb-1">Temperature</label>
                                        <input type="number" id="temperature" value="0.7" step="0.1" min="0" max="2" 
                                               class="w-full input-theme rounded px-2 py-1.5 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-secondary block mb-1">Max Tokens</label>
                                        <input type="number" id="maxTokens" value="1000" step="100" min="100" max="4000" 
                                               class="w-full input-theme rounded px-2 py-1.5 text-sm">
                                    </div>
                                </div>
                                
                                <!-- Streaming Toggle -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <span class="text-sm">Stream Response</span>
                                    <input type="checkbox" id="streamToggle" checked class="rounded accent-accent">
                                </label>
                            </div>
                        </div>
                        
                        <!-- Sessions -->
                        <button onclick="toggleSessionsPanel()" class="p-2 rounded-lg bg-tertiary hover:bg-accent/10 text-secondary hover:text-primary transition-colors" title="Sessions">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                        </button>
                        
                        <!-- New Chat -->
                        <button onclick="newChat()" class="btn btn-primary btn-sm">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span class="hidden sm:inline">New</span>
                        </button>
                    </div>
                </div>
                
                <!-- Active Indicators (shown when applicable) -->
                <div id="chatIndicators" class="flex items-center gap-2 mt-2 empty:hidden">
                    <span id="ragIndicator" class="hidden text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center gap-1">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg>
                        Knowledge Base
                    </span>
                    <span id="promptIndicator" class="hidden text-xs px-2 py-0.5 rounded-full bg-accent/20 text-accent"></span>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden bg-primary">
                <!-- Sessions Panel (collapsible) -->
                <div id="sessionsPanel" class="hidden w-72 border-r border-theme bg-secondary overflow-hidden flex-shrink-0 flex flex-col">
                    <div class="p-3 border-b border-theme flex items-center justify-between">
                        <h3 class="text-sm font-semibold">Saved Sessions</h3>
                        <div class="flex items-center gap-1">
                            <button onclick="createNewSession()" class="btn btn-primary btn-sm text-xs px-2 py-1">New</button>
                            <button onclick="toggleSessionsPanel()" class="p-1 hover:bg-white/10 rounded">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-2">
                        <input type="text" id="sessionSearch" placeholder="Search sessions..." 
                               onkeyup="filterSessions()"
                               class="w-full input-theme rounded px-2 py-1.5 text-xs" />
                    </div>
                    <div id="sessionsList" class="flex-1 overflow-auto px-2 pb-2 space-y-1">
                        <p class="text-xs text-secondary text-center py-4">No saved sessions yet.</p>
                    </div>
                </div>
                
                <!-- Main Chat Area -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div id="chatMessages" class="flex-1 scrollable px-4 py-4">
                        <div id="emptyStatePrompts" class="flex flex-col items-center justify-center h-full max-w-2xl mx-auto px-4">
                            <div class="text-center mb-8">
                                <h2 class="text-2xl font-semibold text-primary mb-2">What can I help you with?</h2>
                                <p class="text-sm text-secondary">Select a model above and try one of these prompts</p>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">
                                <button onclick="useExamplePrompt('Explain how neural networks work in simple terms')" class="example-prompt-card">
                                    <div class="card-title">Explain a concept</div>
                                    <div class="card-desc">"Explain how neural networks work in simple terms"</div>
                                </button>
                                <button onclick="useExamplePrompt('Write a Python function that sorts a list using quicksort')" class="example-prompt-card">
                                    <div class="card-title">Write code</div>
                                    <div class="card-desc">"Write a Python function that sorts a list using quicksort"</div>
                                </button>
                                <button onclick="useExamplePrompt('Help me brainstorm ideas for a mobile app that helps people learn new languages')" class="example-prompt-card">
                                    <div class="card-title">Brainstorm ideas</div>
                                    <div class="card-desc">"Help me brainstorm ideas for a mobile app..."</div>
                                </button>
                                <button onclick="useExamplePrompt('Summarize the key differences between REST and GraphQL APIs')" class="example-prompt-card">
                                    <div class="card-title">Compare topics</div>
                                    <div class="card-desc">"Summarize the key differences between REST and GraphQL"</div>
                                </button>
                            </div>
                        </div>
                    </div>
                <div class="flex-shrink-0 bg-primary border-t border-theme">
                    <div class="max-w-3xl mx-auto py-4 px-4">
                        <div class="relative input-theme rounded-xl focus-within:border-theme transition-colors shadow-lg flex flex-col">
                            <!-- Image Preview Area -->
                            <div id="imagePreview" class="hidden px-4 pt-3 pb-1 border-b border-white/5">
                                <div class="flex items-center justify-between mb-2 text-xs text-secondary">
                                    <span id="imageAttachmentCount">0 attachments</span>
                                    <button type="button" onclick="clearAllImages()" class="text-red-300 hover:text-red-200">Clear all</button>
                                </div>
                                <div id="imagePreviewList" class="flex flex-wrap gap-3"></div>
                            </div>

                            <div class="flex items-end w-full">
                                <!-- Image Upload Button -->
                                <button id="imageUploadBtn" onclick="document.getElementById('imageInput').click()" 
                                        class="ml-3 mb-3 w-8 h-8 rounded-lg text-secondary hover:text-primary hover:bg-white/10 transition-colors flex items-center justify-center hidden"
                                        title="Upload Image">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                </button>
                                <input type="file" id="imageInput" accept="image/*" multiple class="hidden" onchange="handleImageUpload(event)">

                                <div class="flex-1 relative">
                                    <textarea id="chatInput" placeholder="Message OffGrid LLM..." 
                                    onkeydown="handleChatKeydown(event)"
                                    oninput="autoResizeTextarea(this)"
                                    rows="1"
                                    style="max-height: 200px; min-height: 52px;"
                                    class="w-full bg-transparent border-none px-4 py-3 pr-12 text-sm text-primary resize-none focus:outline-none"></textarea>
                                    
                                    <button onclick="sendChat()" id="sendBtn" 
                                            class="absolute right-2 bottom-2 w-8 h-8 rounded-lg btn-primary disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="text-white">
                                            <path d="M.5 1.163A1 1 0 0 1 1.97.28l12.868 6.837a1 1 0 0 1 0 1.766L1.969 15.72A1 1 0 0 1 .5 14.836V10.33a1 1 0 0 1 .816-.983L8.5 8 1.316 6.653A1 1 0 0 1 .5 5.67V1.163Z" fill="currentColor"/>
                                        </svg>
                                    </button>
                                    <button onclick="stopGeneration()" id="stopBtn" 
                                            class="absolute right-2 bottom-2 w-8 h-8 rounded-lg bg-red-600 hover:bg-red-700 transition-colors items-center justify-center hidden">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="text-white">
                                            <rect x="3" y="3" width="10" height="10" rx="2" fill="currentColor"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-2 text-xs text-secondary px-1">
                            <div class="flex gap-3">
                                <span id="tokenCount">0 tokens</span>
                                <span>â€¢</span>
                                <span id="messageCount">0 messages</span>
                                <span id="ragIndicator" class="hidden">â€¢</span>
                                <span id="ragIndicatorText" class="hidden text-emerald-400 flex items-center gap-1">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                                    </svg>
                                    RAG Active
                                </span>
                            </div>
                            <span id="statusBadge" class="text-xs font-medium">Ready</span>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Base (RAG) Tab -->
        <div id="content-knowledge" class="hidden h-full overflow-auto px-6 py-4">
            <div class="max-w-5xl mx-auto">
                <!-- Page Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-semibold">Knowledge Base</h2>
                        <p class="text-sm text-secondary">Upload documents for AI-powered Q&A with RAG</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="ragStatusBadge" class="badge badge-secondary">Disabled</div>
                        <button onclick="disableRAG()" id="ragDisableBtn" class="btn btn-secondary btn-sm hidden">Disable</button>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column - Setup & Upload -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Enable/Model Selection Card -->
                        <div class="card">
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <label class="text-sm font-medium block mb-2">Embedding Model</label>
                                    <select id="ragEmbeddingModel" onchange="onEmbeddingModelChange()" class="w-full input-theme rounded-lg px-3 py-2 text-sm">
                                        <option value="">Select model to enable RAG...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Card -->
                        <div class="card">
                            <h4 class="font-semibold mb-4">Add Documents</h4>
                            
                            <!-- Drag & Drop Zone -->
                            <div id="ragDropZone" 
                                 class="border-2 border-dashed border-theme rounded-xl p-8 text-center hover:border-accent hover:bg-accent/5 transition-all cursor-pointer"
                                 ondrop="handleRAGDrop(event)" 
                                 ondragover="handleRAGDragOver(event)"
                                 ondragleave="handleRAGDragLeave(event)"
                                 onclick="document.getElementById('ragFileInput').click()">
                                <svg class="w-10 h-10 mx-auto mb-3 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-sm text-secondary mb-1">Drop files here or click to browse</p>
                                <p class="text-xs text-secondary">Supports: .txt, .md, .json, .csv, .html</p>
                                <input type="file" id="ragFileInput" accept=".txt,.md,.markdown,.json,.csv,.html,.htm" multiple class="hidden" onchange="handleRAGFileSelect(event)">
                            </div>

                            <!-- Paste text option -->
                            <details class="mt-4">
                                <summary class="text-sm font-medium cursor-pointer text-secondary hover:text-primary">Or paste text directly</summary>
                                <div class="mt-3 space-y-3">
                                    <textarea id="ragTextInput" rows="4" class="w-full input-theme rounded-lg px-3 py-2 text-sm" placeholder="Paste your text content here..."></textarea>
                                    <div class="flex gap-2">
                                        <input type="text" id="ragTextName" class="flex-1 input-theme rounded px-3 py-2 text-sm" placeholder="Document name">
                                        <button onclick="ingestRAGText()" class="btn btn-primary">Add</button>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <!-- Documents List -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold">Your Documents</h4>
                                <button onclick="refreshRAGDocuments()" class="btn btn-secondary btn-sm">Refresh</button>
                            </div>
                            <div id="ragDocumentsList" class="space-y-2">
                                <p class="text-secondary text-sm text-center py-4">No documents uploaded yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Stats & Search -->
                    <div class="space-y-4">
                        <!-- Stats Card -->
                        <div class="card">
                            <h4 class="font-semibold mb-4">Statistics</h4>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-tertiary rounded-lg">
                                    <span class="text-sm text-secondary">Documents</span>
                                    <span class="text-lg font-bold text-accent" id="ragDocCount">0</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-tertiary rounded-lg">
                                    <span class="text-sm text-secondary">Chunks</span>
                                    <span class="text-lg font-bold text-accent" id="ragChunkCount">0</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-tertiary rounded-lg">
                                    <span class="text-sm text-secondary">Embeddings</span>
                                    <span class="text-lg font-bold text-accent" id="ragEmbeddingCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Search Card -->
                        <div class="card">
                            <h4 class="font-semibold mb-3">Search</h4>
                            <div class="space-y-3">
                                <input type="text" id="ragSearchQuery" class="w-full input-theme rounded-lg px-3 py-2 text-sm" placeholder="Search your documents..." onkeypress="if(event.key==='Enter')searchRAGDocuments()">
                                <button onclick="searchRAGDocuments()" class="btn btn-primary w-full">Search</button>
                            </div>
                            <div id="ragSearchResults" class="mt-4 space-y-2"></div>
                        </div>

                        <!-- Developer Tools -->
                        <details class="card">
                            <summary class="font-semibold cursor-pointer flex items-center justify-between">
                                <span>Developer Tools</span>
                                <svg class="w-4 h-4 text-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </summary>
                            <div class="mt-4 pt-4 border-t border-theme space-y-4">
                                <div>
                                    <label class="text-xs text-secondary block mb-1">Embedding Model</label>
                                    <select id="embeddingModel" class="w-full input-theme rounded px-3 py-2 text-sm">
                                        <option value="">Loading...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-secondary block mb-1">Test Text</label>
                                    <textarea id="embeddingInput" placeholder="Enter text..." rows="2" class="w-full input-theme rounded px-3 py-2 text-sm resize-y"></textarea>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="generateEmbedding()" id="generateEmbeddingBtn" class="btn btn-secondary btn-sm flex-1">Generate</button>
                                    <button onclick="clearEmbedding()" class="btn btn-secondary btn-sm">Clear</button>
                                </div>
                                <div id="embeddingResults" class="hidden text-xs">
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div class="bg-tertiary rounded px-2 py-1 text-center">
                                            <div class="text-secondary">Dims</div>
                                            <div id="embeddingDimensions" class="font-semibold text-accent">-</div>
                                        </div>
                                        <div class="bg-tertiary rounded px-2 py-1 text-center">
                                            <div class="text-secondary">Tokens</div>
                                            <div id="embeddingTokens" class="font-semibold text-accent">-</div>
                                        </div>
                                        <div class="bg-tertiary rounded px-2 py-1 text-center">
                                            <div class="text-secondary">Time</div>
                                            <div id="embeddingTime" class="font-semibold text-accent">-</div>
                                        </div>
                                    </div>
                                    <div class="flex justify-end mb-1">
                                        <button onclick="copyEmbedding()" class="text-xs text-accent hover:underline">Copy</button>
                                    </div>
                                    <div id="embeddingVector" class="bg-tertiary rounded px-2 py-1 font-mono overflow-x-auto max-h-20 overflow-y-auto text-xs" style="word-break: break-all;"></div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>

        <!-- Benchmark Tab -->
        <div id="content-benchmark" class="hidden h-full overflow-auto px-6 py-4">
            <div class="max-w-5xl mx-auto">
                <!-- Page Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-semibold">Benchmarks</h2>
                        <p class="text-sm text-secondary">Measure model performance on your hardware</p>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column - Run Benchmark -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Run Benchmark Card -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold">Run Benchmark</h4>
                                <button onclick="runBenchmark()" id="benchmarkRunBtn" class="btn btn-primary">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                    </svg>
                                    Run
                                </button>
                            </div>

                            <!-- Settings -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-xs text-secondary block mb-1">Model</label>
                                    <select id="benchmarkModel" class="w-full input-theme rounded-lg px-3 py-2 text-sm">
                                        <option value="">Select model...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-secondary block mb-1">Prompt Length</label>
                                    <select id="benchmarkPromptLength" class="w-full input-theme rounded-lg px-3 py-2 text-sm">
                                        <option value="short">Short</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="long">Long</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-secondary block mb-1">Output Tokens</label>
                                    <select id="benchmarkOutputTokens" class="w-full input-theme rounded-lg px-3 py-2 text-sm">
                                        <option value="50">50</option>
                                        <option value="100" selected>100</option>
                                        <option value="200">200</option>
                                        <option value="500">500</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Progress -->
                            <div id="benchmarkProgress" class="hidden">
                                <div class="flex items-center justify-between mb-1 text-sm">
                                    <span id="benchmarkStatus">Running...</span>
                                    <span class="text-secondary" id="benchmarkPercent">0%</span>
                                </div>
                                <div class="w-full bg-tertiary rounded-full h-2">
                                    <div id="benchmarkProgressBar" class="bg-accent h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Live Metrics -->
                        <div class="card">
                            <h4 class="font-semibold mb-4">Live Metrics</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <div class="p-4 bg-tertiary rounded-xl text-center">
                                    <div class="text-2xl font-bold text-accent" id="benchLiveTokensPerSec">--</div>
                                    <div class="text-xs text-secondary mt-1">Tokens/sec</div>
                                </div>
                                <div class="p-4 bg-tertiary rounded-xl text-center">
                                    <div class="text-2xl font-bold text-accent" id="benchLiveTimeToFirst">--</div>
                                    <div class="text-xs text-secondary mt-1">TTFT (ms)</div>
                                </div>
                                <div class="p-4 bg-tertiary rounded-xl text-center">
                                    <div class="text-2xl font-bold text-accent" id="benchLiveTotalTime">--</div>
                                    <div class="text-xs text-secondary mt-1">Total (s)</div>
                                </div>
                                <div class="p-4 bg-tertiary rounded-xl text-center">
                                    <div class="text-2xl font-bold text-accent" id="benchLiveMemory">--</div>
                                    <div class="text-xs text-secondary mt-1">Memory (GB)</div>
                                </div>
                            </div>
                        </div>

                        <!-- History -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-semibold">History</h4>
                                <button onclick="clearBenchmarkHistory()" class="btn btn-secondary btn-sm">Clear</button>
                            </div>
                            
                            <!-- Chart Area -->
                            <div id="benchmarkChart" class="mb-4">
                                <p class="text-secondary text-sm text-center py-8">Run benchmarks to see comparison</p>
                            </div>

                            <!-- Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-theme text-left">
                                            <th class="py-2 px-3 font-medium">Model</th>
                                            <th class="py-2 px-3 font-medium text-right">Tok/s</th>
                                            <th class="py-2 px-3 font-medium text-right">TTFT</th>
                                            <th class="py-2 px-3 font-medium text-right">Total</th>
                                            <th class="py-2 px-3 font-medium text-right hidden sm:table-cell">Memory</th>
                                        </tr>
                                    </thead>
                                    <tbody id="benchmarkHistoryTable">
                                        <tr><td colspan="5" class="text-center py-6 text-secondary">No benchmarks yet</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - System Info -->
                    <div class="space-y-4">
                        <div class="card">
                            <h4 class="font-semibold mb-4">System</h4>
                            <div class="space-y-3">
                                <div class="p-3 bg-tertiary rounded-lg">
                                    <div class="text-xs text-secondary mb-1">CPU</div>
                                    <div id="sysInfoCPU" class="text-sm font-medium truncate">Detecting...</div>
                                </div>
                                <div class="p-3 bg-tertiary rounded-lg">
                                    <div class="text-xs text-secondary mb-1">RAM</div>
                                    <div id="sysInfoRAM" class="text-sm font-medium">Detecting...</div>
                                </div>
                                <div class="p-3 bg-tertiary rounded-lg">
                                    <div class="text-xs text-secondary mb-1">GPU</div>
                                    <div id="sysInfoGPU" class="text-sm font-medium">Detecting...</div>
                                </div>
                                <div class="p-3 bg-tertiary rounded-lg">
                                    <div class="text-xs text-secondary mb-1">Backend</div>
                                    <div id="sysInfoBackend" class="text-sm font-medium">llama.cpp</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tips Card -->
                        <div class="card">
                            <h4 class="font-semibold mb-3">Tips</h4>
                            <ul class="text-sm text-secondary space-y-2">
                                <li>â€¢ Close other apps for accurate results</li>
                                <li>â€¢ Run multiple times to average</li>
                                <li>â€¢ Smaller models = faster inference</li>
                                <li>â€¢ GPU acceleration improves speed</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Models Tab -->
        <div id="content-models" class="hidden h-full overflow-auto px-6 py-4">
            <div class="max-w-5xl mx-auto space-y-6">
            
            <!-- Header with stats -->
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-primary">Model Management</h2>
                    <p class="text-sm text-secondary mt-1">Download, manage, and transfer your local models</p>
                </div>
                <button onclick="refreshAllModels()" class="btn btn-secondary btn-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                </button>
            </div>

            <!-- Two-column layout for Installed Models and Search -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Installed Models - Left Column -->
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Installed Models</h3>
                        <span id="modelCount" class="text-xs px-2 py-1 rounded-full bg-accent/20 text-accent">0 models</span>
                    </div>
                    <div id="installedModels" class="space-y-2 max-h-[400px] overflow-y-auto">
                        <p class="text-sm text-secondary">Loading...</p>
                    </div>
                </div>

                <!-- Search & Download - Right Column -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">Search & Download</h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="searchQuery" placeholder="Search models (llama, phi, mistral...)" 
                               class="flex-1 input-theme rounded px-3 py-2 text-sm"
                               onkeydown="if(event.key==='Enter')searchModels()" />
                        <button onclick="searchModels()" class="btn btn-primary">Search</button>
                    </div>
                    <div id="searchResults" class="space-y-2 max-h-[340px] overflow-y-auto">
                        <div class="text-center text-secondary py-8">
                            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <p class="text-sm">Search for models from Hugging Face</p>
                            <p class="text-xs mt-1 text-secondary">Try "llama 3.2" or "phi" or "qwen"</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- USB Import/Export Section - Collapsible -->
            <div class="card">
                <button onclick="toggleUSBSection()" class="w-full flex items-center justify-between text-left">
                    <div>
                        <h3 class="text-lg font-semibold">USB Model Transfer</h3>
                        <p class="text-xs text-secondary mt-1">Transfer models to/from USB drives for offline deployment</p>
                    </div>
                    <svg id="usbSectionArrow" class="w-5 h-5 text-secondary transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                
                <div id="usbSectionContent" class="hidden mt-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Import Section -->
                        <div class="border border-theme rounded-lg p-4">
                            <h4 class="text-sm font-medium mb-2 text-accent flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                                Import from USB
                            </h4>
                            <p class="text-xs text-secondary mb-3">Load models from a USB drive</p>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-secondary block mb-1">USB Path:</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="usbImportPath" 
                                               placeholder="/media/usb or D:\"
                                               value="/media/usb"
                                               class="flex-1 input-theme rounded px-3 py-2 text-sm font-mono" />
                                        <button onclick="browseForPath('import')" class="btn btn-secondary px-3" title="Browse">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="scanUSB()" class="btn btn-secondary flex-1">Scan</button>
                                    <button onclick="importFromUSB()" class="btn btn-primary flex-1">Import All</button>
                                </div>
                                
                                <div id="usbScanResults" class="text-xs"></div>
                                <div id="usbImportStatus" class="text-xs"></div>
                                <div id="usbImportProgress" class="hidden">
                                    <div class="w-full bg-gray-700 rounded-full h-2 mb-1">
                                        <div id="usbImportProgressBar" class="bg-accent h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <div id="usbImportProgressText" class="text-xs text-secondary"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Section -->
                        <div class="border border-theme rounded-lg p-4">
                            <h4 class="text-sm font-medium mb-2 text-accent flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Export to USB
                            </h4>
                            <p class="text-xs text-secondary mb-3">Create a portable model bundle</p>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-secondary block mb-1">USB Path:</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="usbExportPath" 
                                               placeholder="/media/usb or D:\"
                                               value="/media/usb"
                                               class="flex-1 input-theme rounded px-3 py-2 text-sm font-mono" />
                                        <button onclick="browseForPath('export')" class="btn btn-secondary px-3" title="Browse">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <button onclick="exportToUSB()" class="btn btn-primary w-full">Export All Models</button>
                                
                                <div id="usbExportStatus" class="text-xs"></div>
                                <div id="usbExportProgress" class="hidden">
                                    <div class="w-full bg-gray-700 rounded-full h-2 mb-1">
                                        <div id="usbExportProgressBar" class="bg-accent h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <div id="usbExportProgressText" class="text-xs text-secondary"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Common USB Paths Helper -->
                    <div class="mt-4 p-3 bg-secondary rounded text-xs">
                        <span class="font-medium text-accent">Common USB mount points:</span>
                        <div class="mt-2 grid grid-cols-3 gap-2 text-secondary">
                            <div><span class="font-mono text-primary">Linux:</span> /media/usb</div>
                            <div><span class="font-mono text-primary">macOS:</span> /Volumes/USB</div>
                            <div><span class="font-mono text-primary">Windows:</span> D:\ E:\ F:\</div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Terminal Tab -->
        <div id="content-terminal" class="hidden h-full flex flex-col px-6 py-4">
            <div class="max-w-5xl mx-auto flex-1 flex flex-col gap-4 w-full min-h-0">
            <div class="flex-shrink-0">
                <div class="flex items-center gap-3 px-4 py-3 bg-secondary rounded-lg border border-theme">
                    <span class="text-xs font-bold text-secondary uppercase tracking-wider">Quick Commands:</span>
                    <div class="flex gap-2 flex-1">
                        <button onclick="runQuickCommand('offgrid list')" 
                                class="px-4 py-1.5 bg-[#1e1e1e] hover:bg-[#2d2d2d] text-[#00bcd4] hover:text-[#4FC1FF] rounded border border-[#333] font-mono text-xs transition-all duration-150 shadow-sm">
                            list
                        </button>
                        <button onclick="runQuickCommand('offgrid recommend')" 
                                class="px-4 py-1.5 bg-[#1e1e1e] hover:bg-[#2d2d2d] text-[#00bcd4] hover:text-[#4FC1FF] rounded border border-[#333] font-mono text-xs transition-all duration-150 shadow-sm">
                            recommend
                        </button>
                        <button onclick="runQuickCommand('offgrid help')" 
                                class="px-4 py-1.5 bg-[#1e1e1e] hover:bg-[#2d2d2d] text-[#00bcd4] hover:text-[#4FC1FF] rounded border border-[#333] font-mono text-xs transition-all duration-150 shadow-sm">
                            help
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card terminal-card flex-1 flex flex-col min-h-0">
                <div class="flex items-center justify-between mb-3 flex-shrink-0">
                    <h3 class="text-lg font-semibold">Terminal</h3>
                    <div class="flex gap-2">
                        <button onclick="killCommand()" id="killBtn" class="btn btn-danger btn-sm hidden">Kill</button>
                        <button onclick="clearTerminal()" class="btn btn-secondary btn-sm">Clear</button>
                    </div>
                </div>
                <div class="terminal-output" id="terminalOutput"><pre class="terminal-pre" id="terminalPre"><span style="color: #58a6ff;">OffGrid Terminal v0.2.3</span>
Connected to real offgrid binary
Type 'help' for available commands or 'offgrid --help' for all options
</pre></div>
                <div class="terminal-input-line flex-shrink-0" id="terminalInputLine">
                    <span class="terminal-prompt">$</span>
                    <input type="text" id="terminalInput" placeholder="Enter command..." 
                           onkeydown="handleTerminalKeydown(event)"
                           class="terminal-input" autocomplete="off" />
                </div>
            </div>
            </div>
        </div>

        <!-- Agent Tab -->
        <div id="content-agent" class="hidden h-full overflow-auto px-6 py-4">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-2xl font-bold">AI Agent</h1>
                        <p class="text-secondary text-sm mt-1">Run autonomous tasks with tool access</p>
                    </div>
                    <button onclick="loadAgentTools()" class="btn btn-secondary btn-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        Refresh
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Agent Runner -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Run Agent Task</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-secondary block mb-2">Model</label>
                                    <select id="agentModel" class="w-full input-theme rounded-lg px-3 py-2">
                                        <option value="">Select Model...</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-sm text-secondary block mb-2">Task Description</label>
                                    <textarea id="agentTask" rows="3" 
                                              placeholder="Describe what you want the agent to accomplish..."
                                              class="w-full input-theme rounded-lg px-3 py-2 resize-none"></textarea>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-secondary block mb-2">Style</label>
                                        <select id="agentStyle" class="w-full input-theme rounded-lg px-3 py-2">
                                            <option value="react">ReAct (Reasoning + Acting)</option>
                                            <option value="cot">Chain of Thought</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm text-secondary block mb-2">Max Steps</label>
                                        <input type="number" id="agentMaxSteps" value="10" min="1" max="50"
                                               class="w-full input-theme rounded-lg px-3 py-2">
                                    </div>
                                </div>
                                
                                <div class="flex gap-3">
                                    <button onclick="runAgent()" id="runAgentBtn" class="btn btn-primary flex-1">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                        Run Agent
                                    </button>
                                    <button onclick="stopAgent()" id="stopAgentBtn" class="btn btn-danger hidden">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12"></rect></svg>
                                        Stop
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Agent Output -->
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Agent Steps</h3>
                            <div id="agentOutput" class="space-y-3 max-h-96 overflow-auto">
                                <p class="text-secondary text-sm text-center py-8">Run a task to see agent steps here</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tools Panel -->
                    <div class="space-y-4">
                        <div class="card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">Available Tools</h3>
                                <span id="toolCount" class="badge badge-info">0</span>
                            </div>
                            <div id="agentToolsList" class="space-y-2 max-h-64 overflow-auto">
                                <p class="text-secondary text-sm text-center py-4">Loading tools...</p>
                            </div>
                        </div>
                        
                        <!-- MCP Servers -->
                        <div class="card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">MCP Servers</h3>
                                <button onclick="showAddMCPModal()" class="btn btn-primary btn-sm">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    Add
                                </button>
                            </div>
                            <div id="mcpServersList" class="space-y-2">
                                <p class="text-secondary text-sm text-center py-4">No MCP servers configured</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="content-users" class="hidden h-full overflow-auto px-6 py-4">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-2xl font-bold">User Management</h1>
                        <p class="text-secondary text-sm mt-1">Manage users, roles, and quotas</p>
                    </div>
                    <button onclick="showCreateUserModal()" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Create User
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                    <div class="card text-center">
                        <div class="text-3xl font-bold text-accent" id="totalUsersCount">0</div>
                        <div class="text-sm text-secondary">Total Users</div>
                    </div>
                    <div class="card text-center">
                        <div class="text-3xl font-bold text-emerald-400" id="activeUsersCount">0</div>
                        <div class="text-sm text-secondary">Active Today</div>
                    </div>
                    <div class="card text-center">
                        <div class="text-3xl font-bold text-amber-400" id="adminUsersCount">0</div>
                        <div class="text-sm text-secondary">Admins</div>
                    </div>
                    <div class="card text-center">
                        <div class="text-3xl font-bold text-blue-400" id="totalTokensUsed">0</div>
                        <div class="text-sm text-secondary">Tokens Used</div>
                    </div>
                </div>

                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Users</h3>
                        <input type="text" id="userSearch" placeholder="Search users..." 
                               onkeyup="filterUsers()"
                               class="input-theme rounded-lg px-3 py-2 text-sm w-64">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-sm text-secondary border-b border-theme">
                                    <th class="pb-3 font-medium">User</th>
                                    <th class="pb-3 font-medium">Role</th>
                                    <th class="pb-3 font-medium">Created</th>
                                    <th class="pb-3 font-medium">Last Active</th>
                                    <th class="pb-3 font-medium text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="5" class="text-center py-8 text-secondary">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Tab -->
        <div id="content-metrics" class="hidden h-full overflow-auto px-6 py-4">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-2xl font-bold">System Metrics</h1>
                        <p class="text-secondary text-sm mt-1">Monitor performance and usage</p>
                    </div>
                    <div class="flex gap-2">
                        <select id="metricsTimeRange" onchange="loadMetrics()" class="input-theme rounded-lg px-3 py-2 text-sm">
                            <option value="1h">Last Hour</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                        </select>
                        <button onclick="loadMetrics()" class="btn btn-secondary btn-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="card">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-accent/20 flex items-center justify-center">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-accent"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="metricRequests">0</div>
                                <div class="text-xs text-secondary">Total Requests</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-emerald-400"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="metricAvgLatency">0ms</div>
                                <div class="text-xs text-secondary">Avg Latency</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-400"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="metricTokens">0</div>
                                <div class="text-xs text-secondary">Tokens Generated</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-amber-400"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="metricErrors">0</div>
                                <div class="text-xs text-secondary">Errors</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Resources -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">Resource Usage</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>CPU</span>
                                    <span id="cpuUsage">0%</span>
                                </div>
                                <div class="h-2 bg-tertiary rounded-full overflow-hidden">
                                    <div id="cpuBar" class="h-full bg-accent transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Memory</span>
                                    <span id="memoryUsage">0 MB</span>
                                </div>
                                <div class="h-2 bg-tertiary rounded-full overflow-hidden">
                                    <div id="memoryBar" class="h-full bg-emerald-500 transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Disk</span>
                                    <span id="diskUsage">0 GB</span>
                                </div>
                                <div class="h-2 bg-tertiary rounded-full overflow-hidden">
                                    <div id="diskBar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">Active Connections</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-4 bg-tertiary rounded-lg">
                                <div class="text-3xl font-bold text-accent" id="wsConnections">0</div>
                                <div class="text-sm text-secondary">WebSocket</div>
                            </div>
                            <div class="text-center p-4 bg-tertiary rounded-lg">
                                <div class="text-3xl font-bold text-emerald-400" id="activeSessions">0</div>
                                <div class="text-sm text-secondary">Sessions</div>
                            </div>
                            <div class="text-center p-4 bg-tertiary rounded-lg">
                                <div class="text-3xl font-bold text-blue-400" id="loadedModels">0</div>
                                <div class="text-sm text-secondary">Models Loaded</div>
                            </div>
                            <div class="text-center p-4 bg-tertiary rounded-lg">
                                <div class="text-3xl font-bold text-amber-400" id="ragDocuments">0</div>
                                <div class="text-sm text-secondary">RAG Documents</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw Prometheus Metrics -->
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Prometheus Metrics</h3>
                        <button onclick="copyMetrics()" class="btn btn-secondary btn-sm">Copy</button>
                    </div>
                    <pre id="rawMetrics" class="bg-tertiary rounded-lg p-4 text-xs font-mono overflow-auto max-h-64 text-secondary">Loading metrics...</pre>
                </div>
            </div>
        </div>

        <!-- LoRA Tab -->
        <div id="content-lora" class="hidden h-full overflow-auto px-6 py-4">
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-2xl font-bold">LoRA Adapters</h1>
                        <p class="text-secondary text-sm mt-1">Fine-tuned model adapters</p>
                    </div>
                    <button onclick="showRegisterLoRAModal()" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Register Adapter
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Registered Adapters -->
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Registered Adapters</h3>
                            <div id="loraAdaptersList" class="space-y-3">
                                <div class="text-center py-8 text-secondary">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-3 opacity-50"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                                    <p>No LoRA adapters registered</p>
                                    <p class="text-xs mt-1">Register an adapter to apply fine-tuned weights</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active LoRA -->
                    <div class="space-y-4">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Active Adapter</h3>
                            <div id="activeLoraInfo" class="text-center py-6 text-secondary">
                                <p>No adapter loaded</p>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Quick Load</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm text-secondary block mb-2">Base Model</label>
                                    <select id="loraBaseModel" class="w-full input-theme rounded-lg px-3 py-2">
                                        <option value="">Select model...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm text-secondary block mb-2">Adapter</label>
                                    <select id="loraAdapterSelect" class="w-full input-theme rounded-lg px-3 py-2">
                                        <option value="">Select adapter...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm text-secondary block mb-2">Scale (0.0 - 1.0)</label>
                                    <input type="range" id="loraScale" min="0" max="1" step="0.1" value="1" 
                                           class="w-full" oninput="updateLoraScaleLabel()">
                                    <div class="text-center text-sm text-secondary mt-1">
                                        <span id="loraScaleLabel">1.0</span>
                                    </div>
                                </div>
                                <button onclick="loadLoraAdapter()" class="btn btn-primary w-full">
                                    Load Adapter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Add MCP Server Modal -->
    <div id="addMCPModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-card border border-theme rounded-xl p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold mb-4">Add MCP Server</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-secondary block mb-2">Server Name</label>
                    <input type="text" id="mcpServerName" placeholder="filesystem" 
                           class="w-full input-theme rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="text-sm text-secondary block mb-2">Server URL or Command</label>
                    <input type="text" id="mcpServerUrl" placeholder="npx -y @modelcontextprotocol/server-filesystem /tmp" 
                           class="w-full input-theme rounded-lg px-3 py-2 font-mono text-sm">
                    <p class="text-xs text-secondary mt-1">Enter an HTTP URL or an npx/node command to spawn the server</p>
                </div>
                
                <!-- Quick Start Examples -->
                <div class="bg-tertiary rounded-lg p-3">
                    <div class="text-xs font-semibold text-secondary mb-2">Popular MCP Servers (click to use)</div>
                    <div class="space-y-2 text-xs">
                        <div class="flex items-center justify-between p-2 bg-primary/5 rounded cursor-pointer hover:bg-primary/10" onclick="fillMCPExample('filesystem', 'npx -y @modelcontextprotocol/server-filesystem /tmp')">
                            <div>
                                <div class="font-medium">Filesystem</div>
                                <div class="text-secondary">Read/write files, list directories</div>
                            </div>
                            <span class="text-accent">Use</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-primary/5 rounded cursor-pointer hover:bg-primary/10" onclick="fillMCPExample('memory', 'npx -y @modelcontextprotocol/server-memory')">
                            <div>
                                <div class="font-medium">Memory</div>
                                <div class="text-secondary">Key-value store for agent memory</div>
                            </div>
                            <span class="text-accent">Use</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-primary/5 rounded cursor-pointer hover:bg-primary/10" onclick="fillMCPExample('sqlite', 'npx -y @modelcontextprotocol/server-sqlite /tmp/test.db')">
                            <div>
                                <div class="font-medium">SQLite</div>
                                <div class="text-secondary">Database queries and operations</div>
                            </div>
                            <span class="text-accent">Use</span>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-primary/5 rounded cursor-pointer hover:bg-primary/10" onclick="fillMCPExample('github', 'npx -y @modelcontextprotocol/server-github')">
                            <div>
                                <div class="font-medium">GitHub</div>
                                <div class="text-secondary">Repository operations (needs token)</div>
                            </div>
                            <span class="text-accent">Use</span>
                        </div>
                    </div>
                </div>
                
                <!-- Connection Status -->
                <div id="mcpConnectionStatus" class="hidden rounded-lg p-3">
                    <div class="flex items-center gap-2">
                        <div id="mcpStatusIndicator" class="w-2 h-2 rounded-full"></div>
                        <span id="mcpStatusText" class="text-sm"></span>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="hideAddMCPModal()" class="btn btn-secondary flex-1">Cancel</button>
                    <button onclick="testMCPConnection()" class="btn btn-secondary flex-1">Test Connection</button>
                    <button onclick="addMCPServer()" class="btn btn-primary flex-1">Add Server</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-card border border-theme rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">Create User</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-secondary block mb-2">Username</label>
                    <input type="text" id="newUsername" placeholder="username" 
                           class="w-full input-theme rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="text-sm text-secondary block mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="newUserPassword" placeholder="password" 
                               class="w-full input-theme rounded-lg px-3 py-2 pr-10">
                        <button type="button" onclick="togglePasswordVisibility('newUserPassword', this)" 
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-secondary hover:text-primary p-1">
                            <svg class="show-icon w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <svg class="hide-icon w-5 h-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="text-sm text-secondary block mb-2">Role</label>
                    <select id="newUserRole" class="w-full input-theme rounded-lg px-3 py-2">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button onclick="hideCreateUserModal()" class="btn btn-secondary flex-1">Cancel</button>
                    <button onclick="createUser()" class="btn btn-primary flex-1">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-card border border-theme rounded-xl p-6 w-full max-w-sm mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Login</h3>
                <button onclick="hideLoginModal()" class="text-secondary hover:text-primary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-secondary block mb-2">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" 
                           class="w-full input-theme rounded-lg px-3 py-2"
                           onkeydown="if(event.key==='Enter')handleLogin()">
                </div>
                <div>
                    <label class="text-sm text-secondary block mb-2">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" 
                           class="w-full input-theme rounded-lg px-3 py-2"
                           onkeydown="if(event.key==='Enter')handleLogin()">
                </div>
                <div id="loginError" class="hidden text-sm text-red-400 bg-red-500/10 p-2 rounded"></div>
                <div class="flex gap-3">
                    <button onclick="hideLoginModal()" class="btn btn-secondary flex-1">Cancel</button>
                    <button onclick="handleLogin()" class="btn btn-primary flex-1">Login</button>
                </div>
                <p id="loginCreateAccountLink" class="text-xs text-secondary text-center pt-2 hidden">Don't have an account? Go to <a href="#" onclick="hideLoginModal();switchTab('users');" class="text-accent hover:underline">Users</a> to create one.</p>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-card border border-theme rounded-xl p-6 w-full max-w-lg mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">User Details</h3>
                <button onclick="hideUserDetailsModal()" class="text-secondary hover:text-primary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="userDetailsContent" class="space-y-4">
                <!-- Content populated by JS -->
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="hideUserDetailsModal()" class="btn btn-secondary flex-1">Close</button>
                <button onclick="regenerateApiKey()" class="btn btn-warning flex-1">Regenerate API Key</button>
                <button onclick="editUserRole()" class="btn btn-primary flex-1">Change Role</button>
            </div>
        </div>
    </div>

    <!-- Register LoRA Modal -->
    <div id="registerLoRAModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-card border border-theme rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">Register LoRA Adapter</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-secondary block mb-2">Adapter Name</label>
                    <input type="text" id="loraName" placeholder="my-adapter" 
                           class="w-full input-theme rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="text-sm text-secondary block mb-2">File Path</label>
                    <input type="text" id="loraPath" placeholder="/path/to/adapter.gguf" 
                           class="w-full input-theme rounded-lg px-3 py-2">
                </div>
                <div class="flex gap-3">
                    <button onclick="hideRegisterLoRAModal()" class="btn btn-secondary flex-1">Cancel</button>
                    <button onclick="registerLoRA()" class="btn btn-primary flex-1">Register</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentModel = '';
        let messages = [];
        let isGenerating = false;
        let abortController = null;
        let commandHistory = [];
        let historyIndex = -1;
        let terminalRunning = false;
        let currentTerminalAbort = null;
        let terminalChatMode = false;
        let terminalChatModel = '';
        let terminalChatHistory = [];
        let userScrolledUp = false;
        
        // Session management
        let sessions = JSON.parse(localStorage.getItem('offgrid_sessions') || '[]');
        let currentSessionId = null;
        let currentSystemPrompt = '';
        
        // System prompts for different use cases
        const systemPrompts = {
            research: "You are a knowledgeable research assistant. Help users understand complex topics, find relevant information, and think critically about academic questions. Provide detailed, well-sourced responses with references when possible.",
            tutor: "You are a patient and encouraging tutor. Break down complex concepts into simple explanations, use analogies and examples, ask questions to check understanding, and adapt your teaching style to the student's level.",
            coder: "You are an expert code reviewer and programming mentor. Provide detailed code reviews, suggest improvements for readability and performance, explain best practices, and help debug issues. Format all code with proper syntax highlighting.",
            writer: "You are an academic writing assistant. Help with essay structure, grammar, clarity, citation formats, and academic tone. Provide constructive feedback and suggestions for improvement.",
        };
        
        // Request throttling to prevent system overload
        let lastRequestTime = 0;
        let requestCooldown = 300; // Minimum 300ms between requests
        let pendingRequest = false;

        // Save messages to localStorage
        function saveMessages() {
            try {
                localStorage.setItem('offgrid_messages', JSON.stringify(messages));
                localStorage.setItem('offgrid_current_model', currentModel);
            } catch (e) {
                console.error('Failed to save messages:', e);
            }
        }

        function normalizeMessageContent(rawContent) {
            if (Array.isArray(rawContent)) {
                const textParts = rawContent
                    .filter(part => part?.type === 'text')
                    .map(part => part.text || '');
                const imageParts = rawContent
                    .filter(part => part?.type === 'image_url' && part.image_url?.url)
                    .map(part => part.image_url.url);
                return {
                    text: textParts.join('\n\n').trim(),
                    images: imageParts
                };
            }

            if (typeof rawContent === 'string') {
                return { text: rawContent, images: [] };
            }

            if (rawContent && typeof rawContent === 'object') {
                if (typeof rawContent.text === 'string') {
                    return { text: rawContent.text, images: [] };
                }
            }

            return { text: rawContent ? String(rawContent) : '', images: [] };
        }

        function escapeAttribute(value) {
            return (value || '').replace(/"/g, '&quot;');
        }

        function modelSupportsVision(modelInfo, fallbackId = '') {
            const hasCapability = Array.isArray(modelInfo?.capabilities) && modelInfo.capabilities.includes('vision');
            if (hasCapability || modelInfo?.type === 'vlm') {
                return true;
            }

            const tags = Array.isArray(modelInfo?.tags) ? modelInfo.tags : [];
            if (tags.some(tag => ['vision', 'vlm', 'multimodal', 'image'].includes(tag?.toLowerCase?.() || tag))) {
                return true;
            }

            const identifier = (fallbackId || modelInfo?.id || '').toLowerCase();
            const keywords = ['llava', 'bakllava', 'vision', 'yi-vl', 'vlm', 'qwen', 'moondream', 'minicpm', 'minicpm-v', 'pixtral'];
            return keywords.some(keyword => identifier.includes(keyword));
        }

        async function buildAPIError(response) {
            let payload = null;
            try {
                payload = await response.json();
            } catch (e) {
                // Ignore JSON parse errors
            }

            const message = payload?.error?.message || `Server error (${response.status})`;
            const code = payload?.error?.code || null;
            const err = new Error(message);
            err.code = code;
            err.status = response.status;
            err.payload = payload;
            return err;
        }

        // Load messages from localStorage
        function loadMessages() {
            try {
                const saved = localStorage.getItem('offgrid_messages');
                const savedModel = localStorage.getItem('offgrid_current_model');
                const chatMessages = document.getElementById('chatMessages');
                
                if (saved) {
                    messages = JSON.parse(saved);
                    if (savedModel) {
                        currentModel = savedModel;
                    }
                    // Only render if there are actual messages
                    if (messages.length > 0) {
                        chatMessages.innerHTML = '';
                        messages.forEach(msg => {
                            if (msg.role === 'user' || msg.role === 'assistant') {
                                const { text, images } = normalizeMessageContent(msg.content);
                                addChatMessage(msg.role, text, images);
                            }
                        });
                    }
                    // If empty array, leave the initial placeholder
                    updateChatStats();
                }
                // If no saved messages, leave the initial placeholder
            } catch (e) {
                console.error('Failed to load messages:', e);
            }
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('active');
            
            // Save current tab to localStorage
            localStorage.setItem('offgrid_active_tab', tab);
            
            if (tab === 'models') {
                loadInstalledModels();
                // Clear search input
                document.getElementById('searchQuery').value = '';
                document.getElementById('searchResults').innerHTML = '';
            }
            if (tab === 'chat') {
                loadChatModels();
                updateChatStats();
                renderSessions(); // Load sessions panel within chat
            }
            if (tab === 'knowledge') {
                loadRAGStatus();
                loadRAGEmbeddingModels();
                refreshRAGDocuments();
                loadEmbeddingModels(); // Load embedding models for embeddings section
            }
            if (tab === 'benchmark') {
                loadBenchmarkModels();
                loadSystemInfo();
                renderBenchmarkHistory();
            }
            if (tab === 'agent') {
                loadAgentModels();
                loadAgentTools();
                loadMCPServers();
            }
            if (tab === 'users') {
                loadUsers();
            }
            if (tab === 'metrics') {
                loadMetrics();
            }
            if (tab === 'lora') {
                loadLoRAAdapters();
                loadLoRAModels();
            }
        }

        // Chat keyboard handler
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChat();
            }
        }
        
        // Auto-resize textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Terminal keyboard handler
        function handleTerminalKeydown(event) {
            const input = event.target;
            
            if (event.key === 'Enter') {
                event.preventDefault();
                runCommand();
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    input.value = commandHistory[historyIndex] || '';
                }
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    input.value = commandHistory[historyIndex] || '';
                } else if (historyIndex === 0) {
                    historyIndex = -1;
                    input.value = '';
                }
            } else if (event.key === 'Tab') {
                event.preventDefault();
                autocompleteCommand(input);
            }
        }

        function autocompleteCommand(input) {
            const val = input.value;
            const commands = [
                'offgrid list',
                'offgrid recommend',
                'offgrid download ',
                'offgrid download-hf ',
                'offgrid remove ',
                'offgrid search ',
                'offgrid run ',
                'offgrid serve',
                'offgrid --help',
                'offgrid --version',
                'help',
                'clear',
                'history'
            ];
            const match = commands.find(cmd => cmd.startsWith(val));
            if (match) {
                input.value = match;
            }
        }

        function updateChatStats() {
            document.getElementById('messageCount').textContent = `${messages.length} messages`;
            const totalTokens = messages.reduce((sum, m) => sum + (m.content?.length || 0), 0);
            document.getElementById('tokenCount').textContent = `~${Math.ceil(totalTokens / 4)} tokens`;
        }

        // Load models for chat
        async function loadChatModels() {
            try {
                // Force refresh models from filesystem
                try {
                    await fetch('/models/refresh', { method: 'POST' });
                } catch (e) {
                    console.warn('Failed to refresh models, using cached list:', e);
                }
                
                const resp = await fetch('/models');
                const data = await resp.json();
                const models = data.data || [];
                
                // Load all models - both LLM and embedding models
                // We'll detect type and route to correct API when sending
                
                const select = document.getElementById('chatModel');
                
                // Remember the current selection before clearing
                const previousSelection = select.value || currentModel;
                
                select.innerHTML = '';
                
                if (models.length === 0) {
                    select.innerHTML = '<option value="">No LLM models available</option>';
                    return;
                }
                
                // Sort models alphabetically by ID
                models.sort((a, b) => a.id.localeCompare(b.id));
                console.log('[LOAD MODELS] Sorted LLM models:', models.map(m => m.id));
                
                models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    // Format display name: replace underscores and hyphens with spaces for readability
                    const displayName = m.id.replace(/_/g, ' ').replace(/-/g, ' ');
                    opt.textContent = displayName;
                    opt.title = m.id; // Show original name on hover
                    select.appendChild(opt);
                });
                
                // Restore previous selection, or auto-select first model if none selected
                if (previousSelection && models.some(m => m.id === previousSelection)) {
                    // Restore the previous selection
                    currentModel = previousSelection;
                    select.value = previousSelection;
                    console.log('[LOAD MODELS] Restored previous selection:', previousSelection);
                } else if (!currentModel && models.length > 0) {
                    // First time - select first model
                    currentModel = models[0].id;
                    select.value = currentModel;
                    console.log('[LOAD MODELS] Auto-selected first model:', currentModel);
                }

                // Add change handler after models are loaded
                select.onchange = null; // Clear any existing handler
                select.onchange = function(e) {
                    console.log('[DROPDOWN] Change event fired! Value:', e.target.value);
                    handleModelChange();
                };
                console.log('[LOAD MODELS] Event listener attached to dropdown via onchange');
            } catch (e) {
                console.error('Failed to load models:', e);
                document.getElementById('chatModel').innerHTML = '<option value="">Error loading models</option>';
            }
        }

        // Load embedding models
        async function loadEmbeddingModels() {
            try {
                // Force refresh models from filesystem
                try {
                    await fetch('/models/refresh', { method: 'POST' });
                } catch (e) {
                    console.warn('Failed to refresh models, using cached list:', e);
                }
                
                const resp = await fetch('/models');
                const data = await resp.json();
                const allModels = data.data || [];
                
                // Filter only embedding models
                const models = allModels.filter(m => {
                    return m.type === 'embedding' || m.tags?.includes('embedding');
                });
                
                const select = document.getElementById('embeddingModel');
                select.innerHTML = '';
                
                if (models.length === 0) {
                    select.innerHTML = '<option value="">No embedding models available</option>';
                    return;
                }
                
                // Sort models alphabetically by ID
                models.sort((a, b) => a.id.localeCompare(b.id));
                console.log('[LOAD EMBEDDING MODELS] Sorted models:', models.map(m => m.id));
                
                models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    const displayName = m.id.replace(/_/g, ' ').replace(/-/g, ' ');
                    opt.textContent = displayName;
                    opt.title = m.id;
                    select.appendChild(opt);
                });
                
                // Auto-select first model
                if (models.length > 0) {
                    select.value = models[0].id;
                }
            } catch (e) {
               
                console.error('Failed to load embedding models:', e);
                document.getElementById('embeddingModel').innerHTML = '<option value="">Error loading models</option>';
            }
        }

        // Generate embedding
        let currentEmbeddingData = null;
        
        async function generateEmbedding() {
            const model = document.getElementById('embeddingModel').value;
            const input = document.getElementById('embeddingInput').value.trim();
            const btn = document.getElementById('generateEmbeddingBtn');
            
            if (!model) {
                showModal({
                    type: 'warning',
                    title: 'Selection Required',
                    message: 'Please select an embedding model',
                    confirmText: 'OK'
                });
                return;
            }
            
            if (!input) {
                showModal({
                    type: 'warning',
                    title: 'Input Required',
                    message: 'Please enter text to embed',
                    confirmText: 'OK'
                });
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            const startTime = Date.now();
            
            try {
                const response = await fetch('/v1/embeddings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        input: input
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate embedding');
                }
                
                const data = await response.json();
                const endTime = Date.now();
                const timeMs = endTime - startTime;
                
                // Store the full embedding data
                currentEmbeddingData = data.data[0].embedding;
                
                // Display results
                displayEmbeddingResults(data, timeMs);
                
            } catch (error) {
                console.error('Embedding error:', error);
                showModal({
                    type: 'error',
                    title: 'Embedding Failed',
                    message: 'Failed to generate embedding: ' + error.message,
                    confirmText: 'OK'
                });
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Embedding';
            }
        }
        
        function displayEmbeddingResults(data, timeMs) {
            const resultsDiv = document.getElementById('embeddingResults');
            const embedding = data.data[0].embedding;
            const dimensions = embedding.length;
            
            // Show results section
            resultsDiv.classList.remove('hidden');
            
            // Update stats
            document.getElementById('embeddingDimensions').textContent = dimensions;
            document.getElementById('embeddingTokens').textContent = data.usage?.prompt_tokens || '-';
            document.getElementById('embeddingTime').textContent = timeMs + 'ms';
            
            // Display first 100 values
            const preview = embedding.slice(0, 100);
            const previewText = '[' + preview.map(v => v.toFixed(6)).join(', ') + 
                              (dimensions > 100 ? ', ...' : '') + ']';
            document.getElementById('embeddingVector').textContent = previewText;
            
            // Store full vector for later display
            const fullText = '[' + embedding.map(v => v.toFixed(6)).join(', ') + ']';
            document.getElementById('embeddingVectorFull').textContent = fullText;
            
            // Reset toggle button
            document.getElementById('toggleVectorBtn').textContent = 'Show Full Vector';
            document.getElementById('fullVectorContainer').classList.add('hidden');
        }
        
        function toggleFullVector() {
            const container = document.getElementById('fullVectorContainer');
            const btn = document.getElementById('toggleVectorBtn');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btn.textContent = 'Hide Full Vector';
            } else {
                container.classList.add('hidden');
                btn.textContent = 'Show Full Vector';
            }
        }
        
        function copyEmbedding() {
            if (!currentEmbeddingData) {
                showModal({
                    type: 'warning',
                    title: 'No Data',
                    message: 'No embedding to copy',
                    confirmText: 'OK'
                });
                return;
            }
            
            const text = '[' + currentEmbeddingData.map(v => v.toFixed(6)).join(', ') + ']';
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showModal({
                    type: 'error',
                    title: 'Copy Failed',
                    message: 'Failed to copy to clipboard',
                    confirmText: 'OK'
                });
            });
        }
        
        function clearEmbedding() {
            document.getElementById('embeddingInput').value = '';
            document.getElementById('embeddingResults').classList.add('hidden');
            currentEmbeddingData = null;
        }

        // Wait for model to be fully loaded and ready
        async function waitForModelReady(modelName) {
            console.log('[HEALTH CHECK] Waiting for model to be ready:', modelName);
            const maxAttempts = 60; // 60 seconds max wait
            const pollInterval = 1000; // Check every second
            
            // Check if this is an embedding model
            const resp = await fetch('/models');
            const data = await resp.json();
            const modelInfo = data.data.find(m => m.id === modelName);
            // Check type from metadata, or fallback to name heuristics if metadata missing
            const isEmbeddingModel = modelInfo?.type === 'embedding' || 
                                   modelName.toLowerCase().includes('embed') || 
                                   modelName.toLowerCase().includes('bge') ||
                                   modelName.toLowerCase().includes('nomic');
            console.log('[HEALTH CHECK] Model type:', modelInfo?.type, 'Is embedding:', isEmbeddingModel);
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    console.log(`[HEALTH CHECK] Attempt ${attempt}/${maxAttempts}`);
                    
                    let testResponse;
                    if (isEmbeddingModel) {
                        // For embedding models, use embeddings endpoint
                        testResponse = await fetch('/v1/embeddings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: modelName,
                                input: 'test'
                            }),
                            signal: AbortSignal.timeout(5000)
                        });
                    } else {
                        // For LLM models, use chat completions endpoint
                        testResponse = await fetch('/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: modelName,
                                messages: [{ role: 'user', content: 'test' }],
                                stream: false,
                                max_tokens: 1,
                                temperature: 0.1
                            }),
                            signal: AbortSignal.timeout(5000)
                        });
                    }
                    
                    console.log('[HEALTH CHECK] Response status:', testResponse.status);
                    
                    // If we get 200, model is ready
                    if (testResponse.ok) {
                        console.log('[HEALTH CHECK] Model is ready!');
                        return true;
                    }
                    
                    // If we get 503 or 500, model is still loading
                    if (testResponse.status === 503 || testResponse.status === 500) {
                        const errorData = await testResponse.json().catch(() => ({}));
                        console.log('[HEALTH CHECK] Model loading:', errorData.error || 'Still initializing...');
                    }
                    
                    console.log(`[HEALTH CHECK] Not ready yet, waiting ${pollInterval}ms...`);
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                    
                } catch (error) {
                    console.log(`[HEALTH CHECK] Error on attempt ${attempt}:`, error.message);
                    // Network errors or timeouts are expected while loading
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                }
            }
            
            console.warn('[HEALTH CHECK] Timeout after 60s - model may not be ready');
            return false; // Return false if timeout
        }

        // Handle model dropdown change
        async function handleModelChange() {
            const select = document.getElementById('chatModel');
            const newModel = select.value;
            
            console.log('[MODEL CHANGE] Dropdown changed to:', newModel);
            console.log('[MODEL CHANGE] Current model:', currentModel);
            
            if (!newModel) {
                console.log('[MODEL CHANGE] No model selected, ignoring');
                return;
            }
            
            // Don't switch if already on this model
            if (currentModel === newModel) {
                console.log('[MODEL CHANGE] Already using this model');
                return;
            }
            
            const oldModel = currentModel;
            
            // If there are existing messages, ask user what to do
            console.log('[MODEL CHANGE] Current message count:', messages.length);
            if (messages.length > 0) {
                console.log('[MODEL CHANGE] Showing confirmation dialog...');
                showModal({
                    type: 'warning',
                    title: 'Clear Chat History?',
                    message: `Switching from <strong>${oldModel || 'no model'}</strong> to <strong>${newModel}</strong>.<br><br>Clear chat history? The new model won't have context from previous messages.`,
                    confirmText: 'Start Fresh',
                    cancelText: 'Keep History',
                    onConfirm: () => {
                        console.log('[MODEL CHANGE] User response: CLEAR');
                        console.log('[MODEL CHANGE] Clearing chat history');
                        clearChatSilent();
                    },
                    onCancel: () => {
                        console.log('[MODEL CHANGE] User response: KEEP');
                        console.log('[MODEL CHANGE] Keeping chat history');
                    }
                });
            } else {
                console.log('[MODEL CHANGE] No messages, skipping confirmation');
            }
            
            currentModel = newModel;
            console.log('[MODEL CHANGE] Switching from', oldModel, 'to', newModel);

            // Check if VLM and toggle upload button
            try {
                const resp = await fetch('/models');
                const data = await resp.json();
                const modelInfo = data.data.find(m => m.id === newModel);
                const isVLM = modelSupportsVision(modelInfo, newModel);
                
                const imageUploadBtn = document.getElementById('imageUploadBtn');
                if (imageUploadBtn) {
                    if (isVLM) {
                        imageUploadBtn.classList.remove('hidden');
                    } else {
                        imageUploadBtn.classList.add('hidden');
                        clearAllImages(); // Clear any pending image if switching away from VLM
                    }
                }
            } catch (e) {
                console.error('Error checking model type:', e);
            }
            
            // Disable UI while loading model
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const statusBadge = document.getElementById('statusBadge');
            
            chatInput.disabled = true;
            sendBtn.disabled = true;
            statusBadge.className = 'text-xs font-medium text-yellow-400';
            
            // Show loading progress
            let loadingSeconds = 0;
            statusBadge.textContent = `Loading ${newModel}...`;
            const loadingInterval = setInterval(() => {
                loadingSeconds++;
                statusBadge.textContent = `Loading ${newModel}... ${loadingSeconds}s`;
            }, 1000);
            
            console.log('[MODEL CHANGE] Starting health check for', newModel);
            
            // Wait for model to be ready before allowing messages
            const isReady = await waitForModelReady(newModel);
            
            // Clear loading interval
            clearInterval(loadingInterval);
            
            if (isReady) {
                console.log('[MODEL CHANGE] Model ready - enabling UI');
                statusBadge.className = 'badge badge-success';
                statusBadge.textContent = `Ready (${newModel})`;
            } else {
                console.warn('[MODEL CHANGE] Model not confirmed ready - may have issues');
                statusBadge.className = 'badge badge-warning';
                statusBadge.textContent = `${newModel} (not confirmed)`;
            }
            
            // Re-enable UI
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.focus();
            
            console.log('[MODEL CHANGE] Model switch complete - ready for messages');
        }

        // Modal dialog system
        function showModal({ type = 'info', title, message, confirmText = 'OK', cancelText, onConfirm, onCancel }) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const icon = type === 'error' ? 
                '<div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>' :
                type === 'warning' ?
                '<div class="w-12 h-12 rounded-full bg-yellow-100 text-yellow-500 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>' :
                '<div class="w-12 h-12 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div>';

            const cancelButton = cancelText ? `<button class="btn btn-secondary" data-action="cancel">${cancelText}</button>` : '';
            
            overlay.innerHTML = `
                <div class="modal-dialog ${type}">
                    ${icon}
                    <h3 class="text-lg font-bold mb-2 text-center" style="color: var(--text-primary)">${title}</h3>
                    <p class="text-center mb-4" style="color: var(--text-secondary)">${message}</p>
                    <div class="flex justify-center gap-3">
                        ${cancelButton}
                        <button class="btn ${type === 'error' ? 'btn-danger' : 'btn-primary'}" data-action="confirm">${confirmText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Handle clicks
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    overlay.remove();
                    if (onCancel) onCancel();
                }
            });
            
            overlay.querySelector('[data-action="confirm"]')?.addEventListener('click', () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            });
            
            overlay.querySelector('[data-action="cancel"]')?.addEventListener('click', () => {
                overlay.remove();
                if (onCancel) onCancel();
            });
        }

        // Simple alert dialog (replaces browser alert)
        function showAlert(message, type = 'info', title = null) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            // Auto-detect type from message content
            if (!title) {
                if (type === 'error' || message.toLowerCase().includes('failed') || message.toLowerCase().includes('error')) {
                    type = 'error';
                    title = 'Error';
                } else if (message.toLowerCase().includes('success') || message.toLowerCase().includes('added') || message.toLowerCase().includes('deleted')) {
                    type = 'success';
                    title = 'Success';
                } else if (message.toLowerCase().includes('please') || message.toLowerCase().includes('select') || message.toLowerCase().includes('enter')) {
                    type = 'warning';
                    title = 'Notice';
                } else {
                    title = 'Info';
                }
            }
            
            const icon = type === 'error' ? 
                '<div class="w-12 h-12 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></div>' :
                type === 'warning' ?
                '<div class="w-12 h-12 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>' :
                type === 'success' ?
                '<div class="w-12 h-12 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div>' :
                '<div class="w-12 h-12 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div>';

            overlay.innerHTML = `
                <div class="modal-dialog ${type}">
                    ${icon}
                    <h3 class="text-lg font-bold mb-2 text-center" style="color: var(--text-primary)">${title}</h3>
                    <p class="text-center mb-6" style="color: var(--text-secondary)">${message}</p>
                    <div class="flex justify-center">
                        <button class="btn btn-primary px-8" data-action="ok">OK</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Focus the OK button
            overlay.querySelector('[data-action="ok"]').focus();
            
            // Handle clicks
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay') || e.target.dataset.action === 'ok') {
                    overlay.remove();
                }
            });
            
            // Handle Enter/Escape keys
            const handleKey = (e) => {
                if (e.key === 'Enter' || e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', handleKey);
                }
            };
            document.addEventListener('keydown', handleKey);
        }

        // Confirmation dialog system (replaces native confirm())
        function showConfirm(message, onConfirm, options = {}) {
            const title = options.title || 'Confirm';
            const confirmText = options.confirmText || 'OK';
            const cancelText = options.cancelText || 'Cancel';
            const type = options.type || 'info';
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            // Icon based on type
            const icons = {
                error: '<div class="w-12 h-12 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></div>',
                warning: '<div class="w-12 h-12 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>',
                success: '<div class="w-12 h-12 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div>',
                info: '<div class="w-12 h-12 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div>'
            };
            const icon = icons[type] || icons.info;
            
            // Button style based on type
            const btnStyles = {
                error: 'bg-red-600 hover:bg-red-700 text-white',
                warning: 'bg-yellow-600 hover:bg-yellow-700 text-white',
                success: 'bg-green-600 hover:bg-green-700 text-white',
                info: 'bg-blue-600 hover:bg-blue-700 text-white'
            };
            const btnStyle = btnStyles[type] || btnStyles.info;

            overlay.innerHTML = `
                <div class="modal-dialog ${type}">
                    ${icon}
                    <h3 class="text-lg font-bold mb-2 text-center" style="color: var(--text-primary)">${title}</h3>
                    <p class="text-center mb-6" style="color: var(--text-secondary)">${message}</p>
                    <div class="flex justify-center gap-3">
                        <button class="btn btn-secondary px-6" data-action="cancel">${cancelText}</button>
                        <button class="btn px-6 ${btnStyle}" data-action="confirm">${confirmText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Focus the confirm button
            overlay.querySelector('[data-action="confirm"]').focus();
            
            // Handle clicks
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay') || e.target.dataset.action === 'cancel') {
                    overlay.remove();
                } else if (e.target.dataset.action === 'confirm') {
                    overlay.remove();
                    if (onConfirm) onConfirm();
                }
            });
            
            // Handle Enter/Escape keys
            const handleKey = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', handleKey);
                } else if (e.key === 'Enter') {
                    overlay.remove();
                    document.removeEventListener('keydown', handleKey);
                    if (onConfirm) onConfirm();
                }
            };
            document.addEventListener('keydown', handleKey);
        }

        // Alert dialog system (replaces native alert())
        function showAlert(message, options = {}) {
            const title = options.title || 'Notice';
            const buttonText = options.buttonText || 'OK';
            const type = options.type || 'info'; // info, success, warning, error
            const onClose = options.onClose || null;
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            // Icon based on type
            const icons = {
                error: '<div class="w-12 h-12 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></div>',
                warning: '<div class="w-12 h-12 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>',
                success: '<div class="w-12 h-12 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div>',
                info: '<div class="w-12 h-12 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center mb-4 mx-auto"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div>'
            };
            const icon = icons[type] || icons.info;
            
            // Button style based on type
            const btnStyles = {
                error: 'bg-red-600 hover:bg-red-700 text-white',
                warning: 'bg-yellow-600 hover:bg-yellow-700 text-white',
                success: 'bg-emerald-600 hover:bg-emerald-700 text-white',
                info: 'bg-accent hover:bg-accent/80 text-white'
            };
            const btnStyle = btnStyles[type] || btnStyles.info;
            
            // Border color based on type
            const borderClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';

            overlay.innerHTML = `
                <div class="modal-dialog ${borderClass}">
                    ${icon}
                    <h3 class="text-lg font-bold mb-2 text-center" style="color: var(--text-primary)">${title}</h3>
                    <p class="text-center mb-6" style="color: var(--text-secondary)">${message}</p>
                    <div class="flex justify-center">
                        <button class="btn px-8 ${btnStyle}" data-action="close">${buttonText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Focus the button
            overlay.querySelector('[data-action="close"]').focus();
            
            // Handle clicks
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay') || e.target.dataset.action === 'close') {
                    overlay.remove();
                    if (onClose) onClose();
                }
            });
            
            // Handle Enter/Escape keys
            const handleKey = (e) => {
                if (e.key === 'Escape' || e.key === 'Enter') {
                    overlay.remove();
                    document.removeEventListener('keydown', handleKey);
                    if (onClose) onClose();
                }
            };
            document.addEventListener('keydown', handleKey);
        }

        // Prompt dialog system
        function showPrompt({ title, message, defaultValue = '', placeholder = '', confirmText = 'OK', cancelText = 'Cancel', onConfirm, onCancel }) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            overlay.innerHTML = `
                <div class="modal-dialog">
                    <h3 class="text-lg font-bold mb-2 text-center" style="color: var(--text-primary)">${title}</h3>
                    <p class="text-center mb-4" style="color: var(--text-secondary)">${message}</p>
                    <input type="text" class="input-theme w-full p-2 mb-6" value="${defaultValue}" placeholder="${placeholder}" id="promptInput">
                    <div class="flex justify-center gap-3">
                        <button class="btn btn-secondary" data-action="cancel">${cancelText}</button>
                        <button class="btn btn-primary" data-action="confirm">${confirmText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            const input = overlay.querySelector('#promptInput');
            input.focus();
            // Select all text if there is a default value
            if (defaultValue) input.select();

            // Handle Enter key
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    const value = input.value;
                    overlay.remove();
                    if (onConfirm) onConfirm(value);
                }
            });
            
            // Handle clicks
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    overlay.remove();
                    if (onCancel) onCancel();
                }
            });
            
            overlay.querySelector('[data-action="confirm"]')?.addEventListener('click', () => {
                const value = input.value;
                overlay.remove();
                if (onConfirm) onConfirm(value);
            });
            
            overlay.querySelector('[data-action="cancel"]')?.addEventListener('click', () => {
                overlay.remove();
                if (onCancel) onCancel();
            });
        }

        // New chat - offer to save current session first
        function newChat() {
            if (messages.length === 0) {
                // No messages, just reset
                resetChatUI();
                return;
            }
            
            // Show custom 3-button dialog
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            const msgCount = messages.length;
            
            overlay.innerHTML = `
                <div class="modal-dialog warning" style="max-width: 480px;">
                    <div class="w-12 h-12 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center mb-4 mx-auto">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold mb-2 text-center" style="color: var(--text-primary)">Start New Chat?</h3>
                    <p class="text-center mb-4" style="color: var(--text-secondary)">You have <strong>${msgCount} messages</strong> in the current conversation.</p>
                    <div class="flex gap-2 justify-center">
                        <button class="btn btn-secondary" data-action="cancel">Cancel</button>
                        <button class="btn btn-primary" data-action="save-new">Save & New</button>
                        <button class="btn btn-secondary" data-action="new">New Chat</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Handle clicks
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    overlay.remove();
                }
            });
            
            overlay.querySelector('[data-action="save-new"]')?.addEventListener('click', () => {
                overlay.remove();
                // Save with callback to reset after save completes
                saveSessionAndThen(() => {
                    resetChatUI();
                });
            });
            
            overlay.querySelector('[data-action="new"]')?.addEventListener('click', () => {
                overlay.remove();
                resetChatUI();
            });
            
            overlay.querySelector('[data-action="cancel"]')?.addEventListener('click', () => {
                overlay.remove();
            });
        }
        
        // Save session with a callback after completion
        function saveSessionAndThen(onComplete) {
            if (messages.length === 0) {
                if (onComplete) onComplete();
                return;
            }
            
            // Copy messages before any reset happens
            const messagesToSave = [...messages];
            const modelToSave = currentModel;
            const systemPromptToSave = currentSystemPrompt;
            const sessionIdToSave = currentSessionId;
            
            showPrompt({
                title: 'Save Session',
                message: 'Enter a title for this session:',
                defaultValue: `Chat ${new Date().toLocaleDateString()}`,
                confirmText: 'Save',
                onConfirm: (title) => {
                    if (!title) {
                        if (onComplete) onComplete();
                        return;
                    }
                    
                    const session = {
                        id: sessionIdToSave || Date.now(),
                        title: title,
                        model: modelToSave,
                        messages: messagesToSave,
                        systemPrompt: systemPromptToSave,
                        timestamp: new Date().toISOString(),
                        messageCount: messagesToSave.length
                    };
                    
                    const existingIndex = sessions.findIndex(s => s.id === session.id);
                    if (existingIndex >= 0) {
                        sessions[existingIndex] = session;
                    } else {
                        sessions.unshift(session);
                    }
                    
                    localStorage.setItem('offgrid_sessions', JSON.stringify(sessions));
                    renderSessionsList();
                    
                    if (onComplete) onComplete();
                },
                onCancel: () => {
                    // User cancelled save, don't proceed with new chat
                }
            });
        }

        // Reset chat UI to initial state
        function resetChatUI() {
            messages = [];
            currentSessionId = null;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div id="emptyStatePrompts" class="flex flex-col items-center justify-center h-full max-w-2xl mx-auto px-4">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-semibold text-primary mb-2">What can I help you with?</h2>
                        <p class="text-sm text-secondary">Select a model above and try one of these prompts</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">
                        <button onclick="useExamplePrompt('Explain how neural networks work in simple terms')" class="example-prompt-card">
                            <div class="card-title">Explain a concept</div>
                            <div class="card-desc">"Explain how neural networks work in simple terms"</div>
                        </button>
                        <button onclick="useExamplePrompt('Write a Python function that sorts a list using quicksort')" class="example-prompt-card">
                            <div class="card-title">Write code</div>
                            <div class="card-desc">"Write a Python function that sorts a list using quicksort"</div>
                        </button>
                        <button onclick="useExamplePrompt('Help me brainstorm ideas for a mobile app that helps people learn new languages')" class="example-prompt-card">
                            <div class="card-title">Brainstorm ideas</div>
                            <div class="card-desc">"Help me brainstorm ideas for a mobile app..."</div>
                        </button>
                        <button onclick="useExamplePrompt('Summarize the key differences between REST and GraphQL APIs')" class="example-prompt-card">
                            <div class="card-title">Compare topics</div>
                            <div class="card-desc">"Summarize the key differences between REST and GraphQL"</div>
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('chatInput').value = '';
            updateChatStats();
            saveMessages();
        }

        // Clear chat (legacy, now redirects to newChat)
        function clearChat() {
            newChat();
        }

        // Export chat with enhanced options
        function showExportOptions() {
            if (messages.length === 0) {
                showModal({
                    type: 'warning',
                    title: 'No Messages',
                    message: 'There are no messages to export yet.',
                    confirmText: 'OK',
                    cancelText: null
                });
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            overlay.innerHTML = `
                <div class="modal-dialog">
                    <h3 class="text-lg font-bold mb-4 text-center" style="color: var(--text-primary)">Export Chat</h3>
                    <p class="text-center mb-6" style="color: var(--text-secondary)">Choose a format for your export:</p>
                    <div class="flex flex-col gap-3">
                        <button class="btn btn-secondary w-full justify-start p-4" data-format="1">
                            <div class="text-left">
                                <div class="font-bold text-base mb-1" style="color: var(--text-primary)">Markdown</div>
                                <div class="text-xs opacity-70" style="color: var(--text-secondary)">Best for research & reading</div>
                            </div>
                        </button>
                        <button class="btn btn-secondary w-full justify-start p-4" data-format="2">
                            <div class="text-left">
                                <div class="font-bold text-base mb-1" style="color: var(--text-primary)">Plain Text</div>
                                <div class="text-xs opacity-70" style="color: var(--text-secondary)">Simple text file</div>
                            </div>
                        </button>
                        <button class="btn btn-secondary w-full justify-start p-4" data-format="3">
                            <div class="text-left">
                                <div class="font-bold text-base mb-1" style="color: var(--text-primary)">JSON</div>
                                <div class="text-xs opacity-70" style="color: var(--text-secondary)">For programmatic use</div>
                            </div>
                        </button>
                    </div>
                    <div class="flex justify-center mt-6">
                        <button class="btn btn-secondary" data-action="cancel">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            const handleExport = (format) => {
                overlay.remove();
                processExport(format);
            };

            overlay.querySelectorAll('[data-format]').forEach(btn => {
                btn.addEventListener('click', () => handleExport(btn.dataset.format));
            });
            
            overlay.querySelector('[data-action="cancel"]').addEventListener('click', () => {
                overlay.remove();
            });
            
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    overlay.remove();
                }
            });
        }

        function processExport(format) {
            if (!format) return;
            
            let content, mimeType, extension;
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `chat-${currentModel}-${timestamp}`;
            
            if (format === '1') {
                // Markdown format with code blocks
                content = `# Chat with ${currentModel}\n**Date:** ${new Date().toLocaleString()}\n**Messages:** ${messages.length}\n\n---\n\n`;
                messages.forEach(m => {
                    content += `## ${m.role === 'user' ? 'User' : 'Assistant'}\n\n`;
                    // Detect and format code blocks
                    const hasCode = m.content.includes('```');
                    content += hasCode ? m.content : m.content.replace(/`([^`]+)`/g, '`$1`');
                    content += '\n\n---\n\n';
                });
                mimeType = 'text/markdown';
                extension = 'md';
            } else if (format === '3') {
                // JSON format for programmatic access
                content = JSON.stringify({
                    model: currentModel,
                    timestamp: new Date().toISOString(),
                    messageCount: messages.length,
                    messages: messages
                }, null, 2);
                mimeType = 'application/json';
                extension = 'json';
            } else {
                // Plain text
                content = messages.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n\n');
                mimeType = 'text/plain';
                extension = 'txt';
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.${extension}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // System prompt functions
        function toggleChatSettings() {
            const panel = document.getElementById('chatSettingsPanel');
            panel.classList.toggle('hidden');
            
            // Close when clicking outside
            if (!panel.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', closeChatSettingsOnOutsideClick);
                }, 10);
            }
        }
        
        function closeChatSettingsOnOutsideClick(e) {
            const panel = document.getElementById('chatSettingsPanel');
            const button = e.target.closest('button[onclick="toggleChatSettings()"]');
            if (!panel.contains(e.target) && !button) {
                panel.classList.add('hidden');
                document.removeEventListener('click', closeChatSettingsOnOutsideClick);
            }
        }
        
        function useExamplePrompt(prompt) {
            const input = document.getElementById('chatInput');
            input.value = prompt;
            input.focus();
            autoResizeTextarea(input);
            // Hide empty state
            const emptyState = document.getElementById('emptyStatePrompts');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
        }
        
        function setSystemPrompt(preset) {
            const select = document.getElementById('systemPrompt');
            select.value = preset;
            applySystemPrompt();
            updatePromptIndicator(preset);
        }
        
        function updatePromptIndicator(preset) {
            const indicator = document.getElementById('promptIndicator');
            const labels = {
                'research': 'Research Mode',
                'tutor': 'Tutor Mode',
                'coder': 'Code Mode',
                'writer': 'Writer Mode',
                'custom': 'Custom Prompt'
            };
            if (preset && labels[preset]) {
                indicator.textContent = labels[preset];
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }
        
        function applySystemPrompt() {
            const select = document.getElementById('systemPrompt');
            const value = select.value;
            
            if (value === 'custom') {
                showPrompt({
                    title: 'Custom System Prompt',
                    message: 'Enter your custom system prompt:',
                    placeholder: 'You are a helpful assistant...',
                    confirmText: 'Apply',
                    onConfirm: (custom) => {
                        if (custom) {
                            currentSystemPrompt = custom;
                            updatePromptIndicator('custom');
                        }
                    },
                    onCancel: () => {
                        select.value = '';
                        updatePromptIndicator('');
                    }
                });
            } else if (value) {
                currentSystemPrompt = systemPrompts[value];
                updatePromptIndicator(value);
            } else {
                currentSystemPrompt = '';
                updatePromptIndicator('');
            }
        }

        // Session Management Functions
        function saveCurrentSession() {
            if (messages.length === 0) {
                showModal({
                    type: 'error',
                    title: 'Cannot Save',
                    message: 'No messages to save',
                    confirmText: 'OK'
                });
                return;
            }
            
            showPrompt({
                title: 'Save Session',
                message: 'Enter a title for this session:',
                defaultValue: `Chat ${new Date().toLocaleDateString()}`,
                confirmText: 'Save',
                onConfirm: (title) => {
                    if (!title) return;
                    
                    const session = {
                        id: currentSessionId || Date.now(),
                        title: title,
                        model: currentModel,
                        messages: [...messages],
                        systemPrompt: currentSystemPrompt,
                        timestamp: new Date().toISOString(),
                        messageCount: messages.length
                    };
                    
                    const existingIndex = sessions.findIndex(s => s.id === session.id);
                    if (existingIndex >= 0) {
                        sessions[existingIndex] = session;
                    } else {
                        sessions.unshift(session);
                        currentSessionId = session.id;
                    }
                    
                    localStorage.setItem('offgrid_sessions', JSON.stringify(sessions));
                    showModal({
                        type: 'success',
                        title: 'Saved',
                        message: 'Session saved successfully',
                        confirmText: 'OK'
                    });
                    renderSessionsList();
                }
            });
        }

        // Toggle sessions panel in chat tab
        function toggleSessionsPanel() {
            const panel = document.getElementById('sessionsPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                renderSessions();
            }
        }

        // Toggle embeddings section in knowledge tab
        function toggleEmbeddingsSection() {
            const content = document.getElementById('embeddingsContent');
            const icon = document.getElementById('embeddingsSectionIcon');
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        function renderSessions() {
            const container = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-xs text-secondary text-center py-4">No saved sessions yet.</p>';
                return;
            }
            
            container.innerHTML = sessions.map(session => `
                <div class="p-2 rounded bg-tertiary hover:bg-white/5 cursor-pointer transition-colors group" data-session-id="${session.id}">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0" onclick="loadSession(${session.id})">
                            <h4 class="font-medium text-sm text-accent truncate">${session.title}</h4>
                            <p class="text-xs text-secondary mt-0.5">
                                ${session.messageCount} messages â€¢ ${new Date(session.timestamp).toLocaleDateString()}
                            </p>
                        </div>
                        <button onclick="deleteSession(${session.id}); event.stopPropagation();" 
                                class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded text-red-400 transition-opacity"
                                title="Delete session">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadSession(id) {
            const session = sessions.find(s => s.id === id);
            if (!session) return;
            
            if (messages.length > 0) {
                showModal({
                    type: 'warning',
                    title: 'Load Session?',
                    message: 'Current chat will be replaced. Continue?',
                    confirmText: 'Load Session',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                        messages = [...session.messages];
                        currentModel = session.model;
                        currentSessionId = session.id;
                        currentSystemPrompt = session.systemPrompt || '';
                        
                        // Update UI
                        document.getElementById('chatModel').value = currentModel;
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.innerHTML = '';
                        messages.forEach(m => {
                            const { text, images } = normalizeMessageContent(m.content);
                            addChatMessage(m.role, text, images);
                        });
                        
                        // Close sessions panel after loading
                        document.getElementById('sessionsPanel').classList.add('hidden');
                        switchTab('chat');
                        showModal({
                            type: 'success',
                            title: 'Loaded',
                            message: `Session loaded: "${session.title}"`,
                            confirmText: 'OK'
                        });
                    }
                });
                return;
            }
            
            messages = [...session.messages];
            currentModel = session.model;
            currentSessionId = session.id;
            currentSystemPrompt = session.systemPrompt || '';
            
            // Update UI
            document.getElementById('chatModel').value = currentModel;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            messages.forEach(m => {
                const { text, images } = normalizeMessageContent(m.content);
                addChatMessage(m.role, text, images);
            });
            
            // Close sessions panel after loading
            document.getElementById('sessionsPanel').classList.add('hidden');
            switchTab('chat');
        }

        function deleteSession(id) {
            showModal({
                type: 'error',
                title: 'Delete Session?',
                message: `This action cannot be undone.`,
                confirmText: 'Delete',
                cancelText: 'Cancel',
                onConfirm: () => {
                    sessions = sessions.filter(s => s.id !== id);
                    localStorage.setItem('offgrid_sessions', JSON.stringify(sessions));
                    
                    if (currentSessionId === id) {
                        currentSessionId = null;
                    }
                    
                    renderSessions();
                }
            });
        }

        function createNewSession() {
            if (messages.length > 0) {
                showModal({
                    type: 'warning',
                    title: 'Start New Session?',
                    message: 'Current chat will be cleared.',
                    confirmText: 'New Session',
                    cancelText: 'Cancel',
                    onConfirm: () => {
                        clearChatSilent();
                        currentSessionId = null;
                        switchTab('chat');
                        showModal({
                            type: 'success',
                            title: 'New Session',
                            message: 'New session started',
                            confirmText: 'OK'
                        });
                    }
                });
                return;
            }
            
            clearChatSilent();
            currentSessionId = null;
            switchTab('chat');
            showModal({
                type: 'success',
                title: 'New Session',
                message: 'New session started',
                confirmText: 'OK'
            });
        }

        function filterSessions() {
            const query = document.getElementById('sessionSearch').value.toLowerCase();
            const sessionCards = document.querySelectorAll('[data-session-id]');
            
            sessionCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(query) ? 'block' : 'none';
            });
        }

        function clearChatSilent() {
            messages = [];
            document.getElementById('chatMessages').innerHTML = `
                <div id="emptyStatePrompts" class="flex flex-col items-center justify-center h-full max-w-2xl mx-auto px-4">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-semibold text-primary mb-2">What can I help you with?</h2>
                        <p class="text-sm text-secondary">Select a model above and try one of these prompts</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">
                        <button onclick="useExamplePrompt('Explain how neural networks work in simple terms')" class="example-prompt-card">
                            <div class="card-title">Explain a concept</div>
                            <div class="card-desc">"Explain how neural networks work in simple terms"</div>
                        </button>
                        <button onclick="useExamplePrompt('Write a Python function that sorts a list using quicksort')" class="example-prompt-card">
                            <div class="card-title">Write code</div>
                            <div class="card-desc">"Write a Python function that sorts a list using quicksort"</div>
                        </button>
                        <button onclick="useExamplePrompt('Help me brainstorm ideas for a mobile app that helps people learn new languages')" class="example-prompt-card">
                            <div class="card-title">Brainstorm ideas</div>
                            <div class="card-desc">"Help me brainstorm ideas for a mobile app..."</div>
                        </button>
                        <button onclick="useExamplePrompt('Summarize the key differences between REST and GraphQL APIs')" class="example-prompt-card">
                            <div class="card-title">Compare topics</div>
                            <div class="card-desc">"Summarize the key differences between REST and GraphQL"</div>
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('chatInput').value = '';
            updateChatStats();
            saveMessages();
        }

        // Stop generation
        function stopGeneration() {
            console.log('[STOP] Stopping generation...');
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            resetChatState();
        }
        
        // Reset chat state (useful for debugging stuck states)
        function resetChatState() {
            console.log('[RESET STATE] Resetting all chat state flags');
            isGenerating = false;
            pendingRequest = false;
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            const chatInput = document.getElementById('chatInput');
            const statusBadge = document.getElementById('statusBadge');
            
            if (sendBtn) sendBtn.disabled = false;
            if (stopBtn) stopBtn.classList.add('hidden');
            if (chatInput) chatInput.disabled = false;
            if (statusBadge) {
                statusBadge.className = 'badge badge-success';
                statusBadge.textContent = currentModel ? `Ready (${currentModel})` : 'Ready';
            }
            
            console.log('[RESET STATE] State reset complete');
        }
        
        // Make resetChatState globally accessible for debugging
        window.resetChatState = resetChatState;
        
        // Make handleModelChange globally accessible for manual testing
        window.handleModelChange = handleModelChange;
        window.testModelSwitch = function(modelName) {
            console.log('[TEST] Manually switching to:', modelName);
            const select = document.getElementById('chatModel');
            select.value = modelName;
            handleModelChange();
        };

        // Image handling
        const MAX_IMAGE_ATTACHMENTS = 5;
        let imageAttachments = [];
        let nextImageAttachmentId = 1;

        function handleImageUpload(event) {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;

            const remainingSlots = MAX_IMAGE_ATTACHMENTS - imageAttachments.length;
            if (remainingSlots <= 0) {
                showToast(`Maximum of ${MAX_IMAGE_ATTACHMENTS} images reached`, 'error');
                event.target.value = '';
                return;
            }

            const filesToProcess = files.slice(0, remainingSlots);
            if (files.length > filesToProcess.length) {
                showToast(`Only ${remainingSlots} more image${remainingSlots === 1 ? '' : 's'} allowed`, 'warning');
            }

            filesToProcess.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`${file.name} is larger than 10MB`, 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Convert to JPEG to ensure compatibility with llama.cpp (stb_image)
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        // Fill white background for transparent images (PNG/WebP)
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        // Convert to JPEG
                        const jpegUrl = canvas.toDataURL('image/jpeg', 0.95);
                        
                        imageAttachments.push({
                            id: nextImageAttachmentId++,
                            name: file.name.replace(/\.[^/.]+$/, "") + ".jpg",
                            url: jpegUrl
                        });
                        updateImagePreview();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            // Reset input so same files can be selected again
            event.target.value = '';
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            const list = document.getElementById('imagePreviewList');
            const countLabel = document.getElementById('imageAttachmentCount');

            if (!preview || !list || !countLabel) return;

            list.innerHTML = '';

            if (imageAttachments.length === 0) {
                preview.classList.add('hidden');
                countLabel.textContent = '0 attachments';
                return;
            }

            preview.classList.remove('hidden');
            countLabel.textContent = `${imageAttachments.length} attachment${imageAttachments.length === 1 ? '' : 's'}`;

            imageAttachments.forEach(att => {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative group';
                const altText = escapeAttribute(att.name || 'Attachment');
                const imageUrl = escapeAttribute(att.url);
                wrapper.innerHTML = `
                    <img src="${imageUrl}" alt="${altText}" class="h-24 w-24 object-cover rounded-lg border border-white/10 shadow-sm">
                    <button type="button" onclick="removeImageAttachment(${att.id})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>`;
                list.appendChild(wrapper);
            });
        }

        function removeImageAttachment(id) {
            imageAttachments = imageAttachments.filter(att => att.id !== id);
            updateImagePreview();
        }

        function clearAllImages() {
            imageAttachments = [];
            updateImagePreview();
        }

        // Send chat message with streaming
        async function sendChat() {
            console.log('[SEND CHAT] Function called');
            console.log('[SEND CHAT] Flags - isGenerating:', isGenerating, 'pendingRequest:', pendingRequest);
            
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();

            if (!msg && imageAttachments.length === 0) {
                return;
            }

            // Prevent rapid-fire requests
            if (isGenerating || pendingRequest) {
                console.warn('[SEND CHAT] Request already in progress, ignoring...');
                // If stuck, reset after 30 seconds
                const now = Date.now();
                if (lastRequestTime && (now - lastRequestTime) > 30000) {
                    console.warn('[SEND CHAT] Flags stuck for >30s, force resetting...');
                    isGenerating = false;
                    pendingRequest = false;
                } else {
                    return;
                }
            }
            
            lastRequestTime = Date.now();
            pendingRequest = true;
            console.log('[SEND CHAT] Set pendingRequest = true');

            const model = document.getElementById('chatModel').value;
            console.log('[SEND CHAT] Selected model from dropdown:', model);
            console.log('[SEND CHAT] Current model variable:', currentModel);
            console.log('[SEND CHAT] Dropdown element value:', document.getElementById('chatModel').value);
            
            // Check if this is an embedding model
            const resp = await fetch('/models');
            const data = await resp.json();
            console.log('[SEND CHAT] ALL MODELS DATA:', JSON.stringify(data.data, null, 2));
            const modelInfo = data.data.find(m => m.id === model);
            console.log('[SEND CHAT] Found model info:', JSON.stringify(modelInfo, null, 2));
            // Check type from metadata, or fallback to name heuristics if metadata missing
            const isEmbeddingModel = modelInfo?.type === 'embedding' || 
                                   model.toLowerCase().includes('embed') || 
                                   model.toLowerCase().includes('bge') ||
                                   model.toLowerCase().includes('nomic');
            console.log('[SEND CHAT] Model type:', modelInfo?.type, 'Is embedding:', isEmbeddingModel);
            const supportsVision = modelSupportsVision(modelInfo, model);
            console.log('[SEND CHAT] Supports vision:', supportsVision);
            
            if (!model) {
                console.log('[SEND CHAT] No model selected!');
                pendingRequest = false; // Clear flag
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.className = 'badge badge-warning';
                statusBadge.textContent = 'Select Model';
                setTimeout(() => {
                    statusBadge.className = 'badge badge-success';
                    statusBadge.textContent = 'Ready';
                }, 3000);
                return;
            }

            // ALWAYS sync currentModel with dropdown before sending
            currentModel = model;
            console.log('[SEND CHAT] Synced currentModel to:', currentModel);

            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            const streamEnabled = document.getElementById('streamToggle').checked;
            const temperature = parseFloat(document.getElementById('temperature').value);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);

            isGenerating = true;
            input.disabled = true;
            sendBtn.disabled = true;
            stopBtn.classList.remove('hidden');

            // Handle VLM content
            let messageContent = msg;
            let inlineImages = [];
            if (imageAttachments.length > 0) {
                if (!supportsVision) {
                    showToast('Selected model does not support image input', 'error');
                    pendingRequest = false;
                    isGenerating = false;
                    input.disabled = false;
                    sendBtn.disabled = false;
                    stopBtn.classList.add('hidden');
                    return;
                }
                inlineImages = imageAttachments.map(att => att.url);
                messageContent = [
                    { type: "text", text: msg },
                    ...inlineImages.map(url => {
                        // Convert WebP to JPEG if needed, or just strip the prefix if llama-server expects raw base64
                        // But standard OpenAI API expects data URI.
                        // The issue is likely that llama-server's stb_image doesn't support WebP.
                        // We should convert to JPEG/PNG before sending.
                        // For now, let's try to ensure it's a format stb_image supports (JPEG/PNG).
                        return {
                            type: "image_url",
                            image_url: { url }
                        };
                    })
                ];
            }

            messages.push({ role: 'user', content: messageContent });
            addChatMessage('user', msg, inlineImages);
            
            // Clear image attachments after adding to chat
            clearAllImages();
            
            input.value = '';
            updateChatStats();
            saveMessages();
            scrollToBottom();

            // Show thinking indicator immediately after user message
            const thinkingIndicator = addThinkingIndicator();

            const statusBadge = document.getElementById('statusBadge');
            statusBadge.className = 'text-xs font-medium text-yellow-400';
            
            // Show loading indicator with elapsed time
            let loadingInterval;
            let elapsedSeconds = 0;
            statusBadge.textContent = 'Loading model...';
            loadingInterval = setInterval(() => {
                elapsedSeconds++;
                if (elapsedSeconds < 60) {
                    statusBadge.textContent = `Loading model... ${elapsedSeconds}s`;
                } else {
                    const mins = Math.floor(elapsedSeconds / 60);
                    const secs = elapsedSeconds % 60;
                    statusBadge.textContent = `Loading model... ${mins}m ${secs}s`;
                }
            }, 1000);

            abortController = new AbortController();
            const startTime = Date.now();

            // Prepare messages with system prompt if present
            let apiMessages = [...messages];
            if (currentSystemPrompt && currentSystemPrompt.trim()) {
                // Check if first message is already a system message
                if (apiMessages.length === 0 || apiMessages[0].role !== 'system') {
                    apiMessages = [{ role: 'system', content: currentSystemPrompt }, ...apiMessages];
                }
            }

            try {
                // If it's an embedding model, use embeddings API
                if (isEmbeddingModel) {
                    console.log('[SEND CHAT] Routing to embeddings API for embedding model');
                    const embeddingResponse = await fetch('/v1/embeddings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: model, input: msg }),
                        signal: abortController.signal
                    });
                    
                    if (!embeddingResponse.ok) {
                        let errorDetails = '';
                        try {
                            const errorData = await embeddingResponse.json();
                            errorDetails = errorData.error?.message || JSON.stringify(errorData);
                        } catch (e) {
                            errorDetails = embeddingResponse.statusText;
                        }
                        throw new Error(`Server error (${embeddingResponse.status}): ${errorDetails}`);
                    }
                    
                    const embeddingData = await embeddingResponse.json();
                    const embedding = embeddingData.data[0].embedding;
                    const dimensions = embedding.length;
                    
                    // Remove thinking indicator
                    if (thinkingIndicator) {
                        thinkingIndicator.remove();
                    }
                    
                    // Display embedding result as a message
                    const embeddingText = `**Embedding Generated**\n\n` +
                        `**Dimensions:** ${dimensions}\n` +
                        `**First 10 values:** [${embedding.slice(0, 10).map(v => v.toFixed(4)).join(', ')}...]\n\n` +
                        `<details>\n<summary>View full embedding vector (${dimensions} dimensions)</summary>\n\n\`\`\`json\n${JSON.stringify(embedding, null, 2)}\n\`\`\`\n</details>`;
                    
                    addChatMessage('assistant', embeddingText, null, startTime);
                    updateChatStats();
                    saveMessages();
                    
                    if (loadingInterval) clearInterval(loadingInterval);
                    statusBadge.className = 'text-xs font-medium text-green-400';
                    statusBadge.textContent = 'Ready';
                    isGenerating = false;
                    pendingRequest = false;
                    input.disabled = false;
                    sendBtn.disabled = false;
                    stopBtn.classList.add('hidden');
                    scrollToBottom();
                    return;
                }
                
                const requestPayload = {
                    model: model,
                    messages: apiMessages,
                    stream: streamEnabled,
                    temperature: temperature,
                    max_tokens: maxTokens,
                    use_knowledge_base: document.getElementById('useKnowledgeBase').checked
                };
                
                console.log('[SEND CHAT] REQUEST PAYLOAD:', JSON.stringify(requestPayload, null, 2));
                console.log('[SEND CHAT] Model being sent:', model);
                console.log('[SEND CHAT] Knowledge Base enabled:', document.getElementById('useKnowledgeBase').checked);
                
                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    throw await buildAPIError(response);
                }

                if (streamEnabled) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let assistantMsg = '';
                    let msgDiv = null;
                    let firstTokenReceived = false;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n').filter(line => line.trim() !== '');

                        for (const line of lines) {
                            if (!line.startsWith('data: ')) continue;
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const json = JSON.parse(data);

                                if (json.error) {
                                    const streamError = new Error(json.error.message || 'Stream error');
                                    streamError.code = json.error.code || json.error.type || null;
                                    throw streamError;
                                }

                                const content = json.choices?.[0]?.delta?.content || '';
                                if (content) {
                                    // Remove thinking indicator on first token
                                    if (!firstTokenReceived && thinkingIndicator) {
                                        thinkingIndicator.remove();
                                        firstTokenReceived = true;
                                    }
                                    
                                    if (loadingInterval) {
                                        clearInterval(loadingInterval);
                                        loadingInterval = null;
                    statusBadge.textContent = 'Generating...';
                                    }
                                    
                                    assistantMsg += content;
                                    if (!msgDiv) {
                                        msgDiv = addChatMessage('assistant', '', null, startTime);
                                    }
                                    const contentDiv = msgDiv.querySelector('.message-content');
                                    contentDiv.innerHTML = marked.parse(assistantMsg);
                                    contentDiv.querySelectorAll('pre code').forEach((block) => {
                                        hljs.highlightElement(block);
                                    });
                                    scrollToBottom();
                                }
                            } catch (streamErr) {
                                if (streamErr instanceof SyntaxError) {
                                    continue; // Wait for more data
                                }
                                throw streamErr;
                            }
                        }
                    }

                    // Remove thinking indicator if still present
                    if (thinkingIndicator) {
                        thinkingIndicator.remove();
                    }

                    if (assistantMsg) {
                        messages.push({ role: 'assistant', content: assistantMsg });
                        const elapsed = Date.now() - startTime;
                        msgDiv.querySelector('.time-badge').textContent = `${elapsed}ms`;
                        saveMessages();
                    }
                } else {
                    // Non-streaming mode
                    // Model is loaded when we get response
                    if (loadingInterval) {
                        clearInterval(loadingInterval);
                        loadingInterval = null;
                        statusBadge.textContent = 'Generating...';
                    }
                    
                    const result = await response.json();
                    
                    // Remove thinking indicator
                    if (thinkingIndicator) {
                        thinkingIndicator.remove();
                    }
                    
                    const assistantMsg = result.choices[0]?.message?.content || 'No response';
                    const elapsed = Date.now() - startTime;
                    if (assistantMsg) {
                        messages.push({ role: 'assistant', content: assistantMsg });
                        addChatMessage('assistant', assistantMsg, null, startTime);
                        saveMessages();
                        scrollToBottom();
                    }
                }

                updateChatStats();
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                    loadingInterval = null;
                }
                statusBadge.className = 'text-xs font-medium text-green-400';
                statusBadge.textContent = 'Ready';
            } catch (error) {
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                    loadingInterval = null;
                }
                
                // Remove thinking indicator on error
                if (thinkingIndicator) {
                    thinkingIndicator.remove();
                }
                
                if (error.name === 'AbortError') {
                    addChatMessage('assistant', '[Generation stopped by user]', null, startTime);
                    statusBadge.className = 'text-xs font-medium text-green-400';
                    statusBadge.textContent = 'Ready';
                } else {
                    const errorMsg = error.message || 'Unknown error occurred';
                    console.error('Chat error:', error);
                    
                    // Better error messages for common issues
                    let userMessage = `âš  Error: ${errorMsg}`;
                    if (error.code === 'missing_mmproj') {
                        userMessage = 'âš  This vision model is missing its mmproj adapter. Download the matching .mmproj file, place it next to the GGUF, reload the model, and try again.';
                    } else if (errorMsg.includes('503') || errorMsg.includes('Failed to load model')) {
                        userMessage = `âš  Model is taking longer than expected to load.\n\nThis can happen on slower systems. Please try again in a few moments.`;
                    } else if (errorMsg.includes('500')) {
                        userMessage = `âš  Server error occurred.\n\nThe model may still be loading. Please wait a moment and try again.`;
                    }
                    
                    addChatMessage('assistant', userMessage, null, startTime);
                    statusBadge.className = 'text-xs font-medium text-red-400';
                    statusBadge.textContent = 'Error';
                }
            } finally {
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                }
                isGenerating = false;
                pendingRequest = false;
                console.log('[SEND CHAT] Cleaned up - pendingRequest = false, isGenerating = false');
                abortController = null;
                input.disabled = false;
                sendBtn.disabled = false;
                stopBtn.classList.add('hidden');
                input.focus();
            }
        }

        // Add thinking indicator
        function addThinkingIndicator() {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'message message-assistant thinking-indicator';
            
            div.innerHTML = `
                <div class="message-wrapper">
                    <div class="message-avatar">AI</div>
                    <div class="message-body">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-medium text-secondary">Assistant</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-secondary">
                            <div class="thinking-dots">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                            <span class="thinking-text">Thinking...</span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
            return div;
        }

        // Add thinking indicator
        function addThinkingIndicator() {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'message message-assistant thinking-indicator';
            
            div.innerHTML = `
                <div class="message-wrapper">
                    <div class="message-avatar">AI</div>
                    <div class="message-body">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-medium text-secondary">Assistant</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-secondary">
                            <div class="thinking-dots">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                            <span class="thinking-text">Thinking...</span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
            return div;
        }

        // Helper function to smoothly scroll chat to bottom
        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function addChatMessage(role, content, images = null, startTime = null) {
            const container = document.getElementById('chatMessages');
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = 'message message-' + role;
            
            // Configure marked.js with syntax highlighting
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (e) {
                            console.error('Highlight error:', e);
                        }
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });

            // Parse markdown content
            const formattedContent = marked.parse(content);
            const avatar = role === 'user' ? 'U' : 'AI';
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const elapsed = startTime ? `${Date.now() - startTime}ms` : '';
            
            const attachmentList = Array.isArray(images) ? images : (images ? [images] : []);
            let imageHtml = '';
            if (attachmentList.length) {
                const imageItems = attachmentList.map(url => {
                    const safeUrl = escapeAttribute(url);
                    return `<img src="${safeUrl}" class="max-h-64 rounded-lg border border-theme shadow-md object-cover">`;
                }).join('');
                imageHtml = `<div class="flex flex-wrap gap-3 mb-3">${imageItems}</div>`;
            }
            
            div.innerHTML = `
                <div class="message-wrapper">
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-body">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-medium text-secondary">${role === 'user' ? 'You' : 'Assistant'}</span>
                            <span class="text-xs text-secondary">${timestamp}</span>
                            ${elapsed ? `<span class="time-badge text-xs text-accent">${elapsed}</span>` : ''}
                        </div>
                        ${imageHtml}
                        <div class="text-sm message-content prose prose-invert max-w-none">${formattedContent}</div>
                        ${role === 'assistant' ? `
                        <div class="message-actions mt-3">
                            <button onclick="copyMessage(this)" class="btn btn-secondary btn-sm">Copy</button>
                            <button onclick="regenerateMessage()" class="btn btn-info btn-sm">Regenerate</button>
                        </div>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
            
            // Apply highlighting to all code blocks in this message
            div.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            return div;
        }

        function copyMessage(btn) {
            const content = btn.closest('.message').querySelector('.message-content').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = original, 2000);
            });
        }

        function regenerateMessage() {
            if (messages.length < 2) return;
            messages.pop(); // Remove last assistant message
            const lastUserMsg = messages[messages.length - 1];
            messages.pop(); // Remove last user message
            document.getElementById('chatInput').value = lastUserMsg.content;
            sendChat();
        }

        // Search models
        async function searchModels() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                const results = document.getElementById('searchResults');
                results.innerHTML = '<p class="text-sm text-yellow-400">âš  Please enter a search query</p>';
                return;
            }

            const results = document.getElementById('searchResults');
            results.innerHTML = '<p class="text-sm text-secondary">ðŸ” Searching HuggingFace...</p>';

            try {
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 35000); // 35 second timeout (backend has 30s)
                
                const resp = await fetch(`/v1/search?query=${encodeURIComponent(query)}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                }
                
                const data = await resp.json();
                
                if (data.error) {
                    throw new Error(typeof data.error === 'string' ? data.error : JSON.stringify(data.error));
                }
                
                const models = data.results || [];

                if (models.length === 0) {
                    results.innerHTML = '<p class="text-sm text-secondary">No models found. Try different keywords like "llama", "phi", "mistral".</p>';
                    return;
                }

                results.innerHTML = '';
                models.slice(0, 10).forEach(model => {
                    const div = document.createElement('div');
                    div.className = 'model-item';
                    const downloadCmd = model.download_command || `offgrid download-hf ${model.id}`;
                    const sizeInfo = model.size_gb ? `${model.size_gb} GB` : 'Size unknown';
                    const quantInfo = model.best_quant ? ` Â· ${model.best_quant}` : '';
                    const escapedCmd = downloadCmd.replace(/'/g, "\\'");
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-semibold text-sm text-accent">${model.name || model.id}</div>
                                <div class="text-xs text-secondary mt-1">${sizeInfo}${quantInfo} Â· ${model.downloads || 0} downloads</div>
                            </div>
                            <button onclick="downloadModelWithCommand('${escapedCmd}')" class="btn btn-primary btn-sm">Download</button>
                        </div>
                    `;
                    results.appendChild(div);
                });
            } catch (error) {
                console.error('Search error:', error);
                
                // Provide helpful error message based on error type
                let errorHtml = '';
                if (error.name === 'AbortError' || error.message.includes('Timeout') || error.message.includes('exceeded')) {
                    errorHtml = `
                        <div class="text-sm">
                            <p class="text-red-400 mb-2">âš  Search timeout: HuggingFace API not responding</p>
                            <p class="text-secondary mb-3">This usually means no internet connection or HuggingFace is slow.</p>
                            <div class="text-xs text-secondary">
                                <p class="font-semibold text-accent mb-2">Try instead:</p>
                                <p class="mb-1">â€¢ Use the terminal: <span class="font-mono bg-secondary px-2 py-1 rounded">offgrid search llama</span></p>
                                <p class="mb-1">â€¢ Download directly: <span class="font-mono bg-secondary px-2 py-1 rounded">offgrid download-hf TheBloke/TinyLlama-1.1B-Chat-v1.0-GGUF</span></p>
                            </div>
                        </div>
                    `;
                } else {
                    errorHtml = `
                        <div class="text-sm">
                            <p class="text-red-400 mb-2">Search error: ${error.message}</p>
                            <p class="text-secondary mb-2">Use the Terminal tab to search instead:</p>
                            <p class="text-xs font-mono bg-secondary px-2 py-1 rounded inline-block">offgrid search ${query}</p>
                        </div>
                    `;
                }
                results.innerHTML = errorHtml;
            }
        }

        // Download model with specific command
        async function downloadModelWithCommand(command) {
            // Switch to terminal tab and execute download command
            switchTab('terminal');
            document.getElementById('terminalInput').value = command;
            runCommand();
        }

        // Download model (fallback for installed models)
        async function downloadModel(modelName) {
            // Switch to terminal tab and execute download command
            switchTab('terminal');
            document.getElementById('terminalInput').value = `offgrid download ${modelName}`;
            runCommand();
        }

        // Load installed models
        async function loadInstalledModels() {
            const container = document.getElementById('installedModels');
            container.innerHTML = '<p class="text-sm text-secondary">Loading...</p>';

            try {
                // Force refresh models from filesystem
                try {
                    await fetch('/models/refresh', { method: 'POST' });
                } catch (e) {
                    console.warn('Failed to refresh models, using cached list:', e);
                }
                
                const resp = await fetch('/models');
                const data = await resp.json();
                const models = data.data || [];

                if (models.length === 0) {
                    container.innerHTML = '<p class="text-sm text-secondary text-center py-8">No models installed yet.<br><span class="text-xs">Search and download models from the right panel.</span></p>';
                    updateModelCount();
                    return;
                }

                container.innerHTML = '';
                models.forEach(model => {
                    const div = document.createElement('div');
                    div.className = 'model-card model-item';
                    const modelId = (model.id || '').replace(/'/g, "\\'");
                    
                    // Format size if available (assuming it might be in metadata)
                    // Since the API might not return size directly in the root object, we check
                    // But for now we'll just show the ID cleanly
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-center gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-sm text-accent truncate" title="${model.id}">${model.id}</div>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-xs bg-secondary px-1.5 py-0.5 rounded text-secondary font-mono">GGUF</span>
                                </div>
                            </div>
                            <button onclick="removeModel('${modelId}')" class="btn btn-danger btn-sm flex-shrink-0">Remove</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
                updateModelCount();
            } catch (error) {
                container.innerHTML = '<p class="text-sm text-red-400">Failed to load models</p>';
                updateModelCount();
            }
        }

        // Remove model
        async function removeModel(modelId) {
            showModal({
                type: 'error',
                title: 'Remove Model?',
                message: `Are you sure you want to remove <strong>${modelId}</strong>?<br><br>This will delete the model file from your system.`,
                confirmText: 'Remove',
                cancelText: 'Cancel',
                onConfirm: () => {
                    confirmRemoveModel(modelId);
                }
            });
        }

        // Execute the actual removal via terminal
        async function confirmRemoveModel(modelId) {
            try {
                // Clear saved model if it's the one being deleted
                if (currentModel === modelId) {
                    currentModel = '';
                    localStorage.removeItem('offgrid_current_model');
                }
                
                // Switch to terminal tab to show progress
                switchTab('terminal');
                
                // Execute remove command
                const input = document.getElementById('terminalInput');
                input.value = `offgrid remove ${modelId} --yes`;
                
                // Trigger the command
                const event = new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13 });
                input.dispatchEvent(event);
                
                // Note: Model list refresh happens in handleOffgridCommand after command completes
            } catch (error) {
                showModal({
                    type: 'error',
                    title: 'Remove Failed',
                    message: `Failed to remove model: ${error.message}`,
                    confirmText: 'OK'
                });
            }
        }

        // Toggle USB section visibility
        function toggleUSBSection() {
            const content = document.getElementById('usbSectionContent');
            const arrow = document.getElementById('usbSectionArrow');
            content.classList.toggle('hidden');
            arrow.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        // Refresh all models
        async function refreshAllModels() {
            await fetchModels();
            updateModelCount();
        }

        // Update model count badge
        function updateModelCount() {
            const countEl = document.getElementById('modelCount');
            if (countEl) {
                const models = document.querySelectorAll('#installedModels .model-card');
                countEl.textContent = models.length + ' model' + (models.length !== 1 ? 's' : '');
            }
        }

        // USB Import/Export Functions
        
        // Scan USB drive for models
        async function scanUSB() {
            const usbPath = document.getElementById('usbImportPath').value.trim();
            const resultsDiv = document.getElementById('usbScanResults');
            const statusDiv = document.getElementById('usbImportStatus');
            
            if (!usbPath) {
                statusDiv.innerHTML = '<span class="text-yellow-400">âš  Please enter a USB path</span>';
                return;
            }
            
            statusDiv.innerHTML = '';
            resultsDiv.innerHTML = '<span class="text-accent">ðŸ” Scanning USB drive...</span>';
            
            try {
                const response = await fetch('/v1/usb/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usb_path: usbPath })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const count = data.count || 0;
                    if (count > 0) {
                        const totalSize = data.models.reduce((sum, m) => sum + m.size, 0);
                        const totalGB = (totalSize / (1024 * 1024 * 1024)).toFixed(2);
                        
                        resultsDiv.innerHTML = `
                            <div class="p-2 bg-secondary rounded border border-accent">
                                <div class="font-medium text-accent mb-2">Found ${count} model(s) - ${totalGB} GB</div>
                                <div class="space-y-1 max-h-32 overflow-y-auto">
                                    ${data.models.map(m => `
                                        <div class="text-xs flex justify-between">
                                            <span class="font-mono">${m.file_name}</span>
                                            <span class="text-secondary">${(m.size / (1024*1024*1024)).toFixed(2)} GB</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        resultsDiv.innerHTML = '<span class="text-secondary">No GGUF models found</span>';
                    }
                } else {
                    const error = data.error || 'Scan failed';
                    resultsDiv.innerHTML = `<span class="text-red-400">âœ— ${error}</span>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<span class="text-red-400">âœ— Error: ${error.message}</span>`;
            }
        }
        
        async function importFromUSB() {
            const usbPath = document.getElementById('usbImportPath').value.trim();
            const statusDiv = document.getElementById('usbImportStatus');
            const progressDiv = document.getElementById('usbImportProgress');
            const progressBar = document.getElementById('usbImportProgressBar');
            const progressText = document.getElementById('usbImportProgressText');
            
            if (!usbPath) {
                statusDiv.innerHTML = '<span class="text-yellow-400">âš  Please enter a USB path</span>';
                return;
            }
            
            statusDiv.innerHTML = '';
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.innerHTML = 'Starting import...';
            
            try {
                const response = await fetch('/v1/usb/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: usbPath })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const count = data.imported_count || 0;
                    progressBar.style.width = '100%';
                    progressText.innerHTML = `âœ“ Successfully imported ${count} model(s)`;
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        statusDiv.innerHTML = `<span class="text-green-400">âœ“ Import complete - ${count} model(s) added</span>`;
                    }, 2000);
                    loadInstalledModels(); // Refresh the models list
                } else {
                    const error = data.error || 'Import failed';
                    progressDiv.classList.add('hidden');
                    statusDiv.innerHTML = `<span class="text-red-400">âœ— ${error}</span>`;
                }
            } catch (error) {
                progressDiv.classList.add('hidden');
                statusDiv.innerHTML = `<span class="text-red-400">âœ— Error: ${error.message}</span>`;
            }
        }
        
        async function exportToUSB() {
            const usbPath = document.getElementById('usbExportPath').value.trim();
            const statusDiv = document.getElementById('usbExportStatus');
            const progressDiv = document.getElementById('usbExportProgress');
            const progressBar = document.getElementById('usbExportProgressBar');
            const progressText = document.getElementById('usbExportProgressText');
            
            if (!usbPath) {
                statusDiv.innerHTML = '<span class="text-yellow-400">âš  Please enter a USB path</span>';
                return;
            }
            
            statusDiv.innerHTML = '';
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.innerHTML = 'Starting export...';
            
            try {
                const response = await fetch('/v1/usb/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: usbPath })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const count = data.exported_count || 0;
                    const size = data.total_size_gb || 0;
                    progressBar.style.width = '100%';
                    progressText.innerHTML = `âœ“ Exported ${count} model(s) (${size.toFixed(2)} GB)`;
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        statusDiv.innerHTML = `
                            <div class="p-2 bg-secondary rounded border border-green-500">
                                <div class="text-green-400 font-medium">âœ“ Export Complete</div>
                                <div class="text-xs text-secondary mt-1">
                                    ${count} model(s) exported (${size.toFixed(2)} GB)<br>
                                    Location: ${usbPath}/offgrid-models/<br>
                                    Manifest and README included
                                </div>
                            </div>
                        `;
                    }, 2000);
                } else {
                    const error = data.error || 'Export failed';
                    progressDiv.classList.add('hidden');
                    statusDiv.innerHTML = `<span class="text-red-400">âœ— ${error}</span>`;
                }
            } catch (error) {
                progressDiv.classList.add('hidden');
                statusDiv.innerHTML = `<span class="text-red-400">âœ— Error: ${error.message}</span>`;
            }
        }

        // Terminal commands
        function scrollTerminalToBottom() {
            if (userScrolledUp) return; // Don't auto-scroll if user scrolled up
            const terminal = document.getElementById('terminalOutput');
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function clearTerminal() {
            terminalOutputBuffer = ''; // Clear any buffered output
            userScrolledUp = false;
            const pre = document.getElementById('terminalPre');
            pre.textContent = 'OffGrid Terminal v0.2.3\nConnected to real offgrid binary\nType \'help\' for available commands\n';
        }

        function killCommand() {
            if (currentTerminalAbort) {
                currentTerminalAbort.abort();
                currentTerminalAbort = null;
            }
            terminalRunning = false;
            const inputLine = document.getElementById('terminalInputLine');
            inputLine.classList.remove('terminal-running');
            document.getElementById('terminalInput').disabled = false;
            document.getElementById('killBtn').classList.add('hidden');
            addTerminalOutput('Command killed', 'error');
        }

        function runQuickCommand(cmd) {
            document.getElementById('terminalInput').value = cmd;
            runCommand();
        }

        function runCommand() {
            const input = document.getElementById('terminalInput');
            const cmd = input.value.trim();
            if (!cmd) return;

            // Handle chat mode
            if (terminalChatMode) {
                // Prevent sending while already processing
                if (terminalRunning || pendingRequest) {
                    console.log('Terminal chat request already in progress');
                    return; // Silently ignore, don't show error
                }
                
                // Throttle terminal chat requests
                const now = Date.now();
                if (now - lastRequestTime < requestCooldown) {
                    console.log('Throttling terminal chat request');
                    return;
                }
                lastRequestTime = now;
                
                if (cmd === 'exit' || cmd === 'quit') {
                    addTerminalOutput(cmd, 'prompt');
                    addTerminalOutput('Exiting chat mode...', 'success');
                    terminalChatMode = false;
                    terminalChatModel = '';
                    terminalChatHistory = [];
                    input.value = '';
                    return;
                } else if (cmd === 'clear') {
                    clearTerminal();
                    addTerminalOutput(`Chat mode with ${terminalChatModel}`, 'success');
                    addTerminalOutput('Type your message or "exit" to quit');
                    addTerminalOutput('> ', 'success');
                    input.value = '';
                    return;
                }
                
                // Send message in chat mode - disable input while processing
                addTerminalOutput(cmd, 'prompt');
                input.value = '';
                input.disabled = true;
                terminalRunning = true;
                pendingRequest = true;
                sendTerminalChat(cmd);
                return;
            }

            if (terminalRunning) {
                addTerminalOutput('Command already running. Use Kill button to stop it.', 'error');
                return;
            }
            
            // Add to history
            if (commandHistory[0] !== cmd) {
                commandHistory.unshift(cmd);
                if (commandHistory.length > 50) commandHistory.pop();
            }
            historyIndex = -1;

            addTerminalOutput(cmd, 'prompt');
            input.value = '';

            const parts = cmd.split(' ').filter(p => p);
            const command = parts[0];
            const args = parts.slice(1);

            // Set running state
            terminalRunning = true;
            const inputLine = document.getElementById('terminalInputLine');
            inputLine.classList.add('terminal-running');
            input.disabled = true;
            document.getElementById('killBtn').classList.remove('hidden');

            switch (command) {
                case 'offgrid':
                    handleOffgridCommand(args);
                    break;
                case 'clear':
                    clearTerminal();
                    resetTerminalState();
                    break;
                case 'help':
                    showHelp();
                    resetTerminalState();
                    break;
                case 'history':
                    showHistory();
                    resetTerminalState();
                    break;
                default:
                    addTerminalOutput(`Unknown command: ${command}. Type 'help' for available commands`, 'error');
                    resetTerminalState();
            }
        }

        function resetTerminalState() {
            terminalRunning = false;
            const inputLine = document.getElementById('terminalInputLine');
            inputLine.classList.remove('terminal-running');
            document.getElementById('terminalInput').disabled = false;
            document.getElementById('killBtn').classList.add('hidden');
        }

        function showHelp() {
            const help = [
                'Available Commands:',
                '',
                'Terminal Commands:',
                '  clear                         Clear terminal screen',
                '  history                       Show command history',
                '  help                          Show this help',
                '',
                'OffGrid Commands (runs real offgrid binary):',
                '  offgrid list                  List installed models',
                '  offgrid search <query>        Search for models to download',
                '  offgrid download <model>      Download a model',
                '  offgrid remove <model>        Remove an installed model',
                '  offgrid run <model>           Load model and switch to Chat tab',
                '  offgrid info                  Show system information',
                '  offgrid doctor                Run diagnostics',
                '  offgrid --help                Show all offgrid commands',
                '  offgrid --version             Show version',
                '',
                'Tips:',
                '  - Use arrow keys (â†‘/â†“) to navigate history',
                '  - Use Tab for command autocomplete',
                '  - Press Ctrl+C or click Kill to stop command',
                '  - For interactive chat, use "offgrid run <model>" or Chat tab'
            ];
            help.forEach(line => addTerminalOutput(line));
        }

        function showHistory() {
            if (commandHistory.length === 0) {
                addTerminalOutput('No command history');
                return;
            }
            addTerminalOutput('Command History:');
            commandHistory.slice(0, 10).forEach((cmd, i) => {
                addTerminalOutput(`  ${i + 1}. ${cmd}`);
            });
        }

        async function handleOffgridCommand(args) {
            if (args.length === 0) {
                addTerminalOutput('Usage: offgrid <command>', 'error');
                addTerminalOutput('Try: offgrid help');
                resetTerminalState();
                return;
            }

            // Create abort controller for this command
            currentTerminalAbort = new AbortController();
            
            try {
                // Execute real offgrid command via streaming endpoint for real-time output
                const resp = await fetch('/v1/terminal/exec/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        command: 'offgrid',
                        args: args
                    }),
                    signal: currentTerminalAbort?.signal
                });

                if (!resp.ok) {
                    addTerminalOutput(`Command failed: HTTP ${resp.status}`, 'error');
                    resetTerminalState();
                    return;
                }

                // Read streaming response
                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let exitCode = 0;

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, {stream: true});
                    
                    // Process complete SSE events
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // Keep incomplete event in buffer

                    for (const event of lines) {
                        if (!event.trim()) continue;
                        
                        // Parse SSE format: "event: type\ndata: line1\ndata: line2\n..."
                        const eventLines = event.split('\n');
                        let eventType = '';
                        const dataLines = [];
                        
                        for (const eLine of eventLines) {
                            if (eLine.startsWith('event:')) {
                                eventType = eLine.substring(6).trim();
                            } else if (eLine.startsWith('data:')) {
                                dataLines.push(eLine.substring(5).trim());
                            }
                        }
                        
                        if (!eventType) continue;
                        
                        const data = dataLines.join('\n');
                        
                        if (eventType === 'output') {
                            // Display output in real-time
                            if (data) addTerminalRawOutput(data);
                        } else if (eventType === 'exit') {
                            exitCode = parseInt(data);
                        } else if (eventType === 'error') {
                            addTerminalOutput(`Error: ${data}`, 'error');
                        }
                    }
                }
                
                // Special handling for 'run' command - enable terminal chat mode
                const subcmd = args[0];
                if (subcmd === 'run' && args.length > 1 && exitCode === 0) {
                    // Extract just the model name (first argument after run), ignoring flags
                    // We assume the syntax is: offgrid run <model_id> [flags]

                    const modelName = args[1];
                    
                    // Enable chat mode
                    terminalChatMode = true;
                    terminalChatModel = modelName;
                    terminalChatHistory = [];
                    addTerminalOutput('', 'normal');
                    addTerminalOutput('Chat mode enabled. Type your messages below.', 'success');
                    addTerminalOutput('Commands: "exit" to quit, "clear" to reset screen', 'success');
                    addTerminalOutput('> ', 'success');
                }

                if (exitCode !== 0) {
                    addTerminalOutput(`Command exited with code ${exitCode}`, 'error');
                }

                // Refresh UI after certain commands (only on success)
                if (['download', 'remove', 'delete'].includes(subcmd) && exitCode === 0) {
                    // Wait longer to ensure backend has updated
                    setTimeout(() => {
                        loadInstalledModels();
                        loadChatModels();
                    }, 2500);
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    addTerminalOutput('Command aborted', 'error');
                } else {
                    addTerminalOutput(`Error: ${error.message}`, 'error');
                }
            } finally {
                flushTerminalBuffer(); // Flush any remaining buffered output
                resetTerminalState();
                currentTerminalAbort = null;
            }
        }



        // Send chat message in terminal mode
        async function sendTerminalChat(message) {
            try {
                terminalChatHistory.push({ role: 'user', content: message });
                
                const resp = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: terminalChatModel,
                        messages: terminalChatHistory,
                        stream: false,
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!resp.ok) {
                    let errorMsg = `HTTP ${resp.status}`;
                    try {
                        const errorData = await resp.json();
                        errorMsg = errorData.error?.message || errorMsg;
                    } catch (e) {
                        // Ignore JSON parse errors
                    }
                    addTerminalOutput(`Error: ${errorMsg}`, 'error');
                    terminalChatHistory.pop(); // Remove failed message
                    return;
                }

                const data = await resp.json();
                const assistantMsg = data.choices?.[0]?.message?.content || 'No response';
                const actualModel = data.model || terminalChatModel;
                
                terminalChatHistory.push({ role: 'assistant', content: assistantMsg });
                
                // Show model info if different from expected
                if (actualModel !== terminalChatModel) {
                    addTerminalOutput(`[Using model: ${actualModel}]`, 'error');
                }
                
                addTerminalOutput('', 'normal');
                addTerminalOutput(assistantMsg, 'success');
                addTerminalOutput('', 'normal');
                addTerminalOutput('> ', 'success');
                
            } catch (error) {
                addTerminalOutput(`Error: ${error.message}`, 'error');
                if (terminalChatHistory.length > 0 && terminalChatHistory[terminalChatHistory.length - 1].role === 'user') {
                    terminalChatHistory.pop(); // Remove failed message
                }
            } finally {
                // Re-enable input after processing
                terminalRunning = false;
                pendingRequest = false;
                document.getElementById('terminalInput').disabled = false;
                document.getElementById('terminalInput').focus();
            }
        }

        // Format progress line with visual progress bar
        function formatProgressLine(text) {
            const cleanText = stripAnsi(text);
            
            // Extract percentage if present
            const percentMatch = cleanText.match(/(\d+(?:\.\d+)?)\s*%/);
            const percent = percentMatch ? parseFloat(percentMatch[1]) : null;
            
            // Clean up the text and format nicely
            let formattedText = parseAnsiColors(text);
            
            if (percent !== null) {
                // Create visual progress bar
                const progressBar = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="min-width: 50px; text-align: right; color: #7ee787;">${percent.toFixed(1)}%</span>
                        <div style="flex: 1; max-width: 200px; height: 6px; background: #21262d; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${Math.min(percent, 100)}%; height: 100%; background: linear-gradient(90deg, #238636, #2ea043); transition: width 0.15s ease;"></div>
                        </div>
                        <span style="color: #8b949e; font-size: 12px;">${cleanText.replace(/\d+(?:\.\d+)?\s*%/, '').trim()}</span>
                    </div>
                `;
                return progressBar;
            }
            
            return formattedText;
        }

        // Strip ANSI escape codes
        function stripAnsi(text) {
            // Strip all ANSI escape codes (colors, cursor movement, etc.)
            return text.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '');
        }

        // Parse ANSI color codes and convert to HTML with CSS classes
        function parseAnsiColors(text) {
            // Simple escape - just escape HTML chars, preserve spaces
            function escapeHtml(str) {
                return str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }
            
            // Strip ANSI codes completely for now - they cause formatting issues
            // Just return clean text
            const stripped = text.replace(/\\x1b\\[[0-9;]*m/g, '');
            return escapeHtml(stripped);
        }

        function addTerminalOutput(text, type = 'normal') {
            const pre = document.getElementById('terminalPre');
            
            // Simple escape
            function esc(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }
            
            // Strip literal \n from text
            const cleanText = text.replace(/\\n/g, '').replace(/\\r/g, '');
            
            let output = '';
            if (type === 'prompt') {
                output = '\n\n<span style="color: #06b6d4;">$ ' + esc(cleanText) + '</span>\n';
            } else if (type === 'error') {
                output = '<span style="color: #f7768e;">' + esc(cleanText) + '</span>\n';
            } else if (type === 'success') {
                output = '<span style="color: #06b6d4;">' + esc(cleanText) + '</span>\n';
            } else {
                output = esc(cleanText) + '\n';
            }
            
            pre.innerHTML += output;
            scrollTerminalToBottom();
        }

        // Buffer for incomplete lines across chunks
        let terminalOutputBuffer = '';

        // Strip ANSI escape codes from text
        function stripAnsiCodes(str) {
            // Match ESC[ followed by any number of digits/semicolons, ending with a letter
            // This handles \x1b[, \033[, and actual escape character
            return str
                .replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '')  // Actual escape char
                .replace(/\033\[[0-9;]*[a-zA-Z]/g, '')  // Octal escape
                .replace(/\[\d+m/g, '')                  // Bare codes like [36m
                .replace(/\[\d+;\d+m/g, '')              // Codes like [1;36m
                .replace(/\[0m/g, '')                    // Reset code
                .replace(/\[m/g, '');                    // Short reset
        }

        function addTerminalRawOutput(text) {
            const pre = document.getElementById('terminalPre');
            
            // Simple escape function
            function esc(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }
            
            // Convert literal \n to actual newlines first
            let processedText = text.replace(/\\n/g, '\n').replace(/\\r/g, '\r');
            
            // Combine with any buffered text
            let currentText = terminalOutputBuffer + processedText;
            
            // Split by newlines
            const lines = currentText.split('\n');
            
            // Keep the last incomplete line in buffer
            terminalOutputBuffer = lines.pop() || '';
            
            // Append complete lines - strip ANSI codes but preserve text
            if (lines.length > 0) {
                let output = '';
                for (let line of lines) {
                    // Handle carriage return (take last part)
                    if (line.includes('\r')) {
                        const parts = line.split('\r');
                        line = parts[parts.length - 1];
                    }
                    // Strip ANSI codes and escape HTML
                    const clean = stripAnsiCodes(line);
                    // Skip empty prompt lines (just > or whitespace)
                    if (clean.trim() === '>' || clean.trim() === '') continue;
                    output += esc(clean) + '\n';
                }
                if (output) {
                    pre.innerHTML += output;
                    scrollTerminalToBottom();
                }
            }
        }
        
        // Flush any remaining buffer content (call this when command completes)
        function flushTerminalBuffer() {
            if (terminalOutputBuffer) {
                const pre = document.getElementById('terminalPre');
                // Strip ANSI and escape
                const clean = stripAnsiCodes(terminalOutputBuffer);
                const escaped = clean.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                pre.innerHTML += escaped + '\n';
                terminalOutputBuffer = '';
                scrollTerminalToBottom();
            }
        }

        // ==================== RAG (Knowledge Base) Functions ====================
        
        let ragEnabled = false;
        
        async function loadRAGStatus() {
            try {
                const response = await fetch('/v1/rag/status');
                const data = await response.json();
                ragEnabled = data.enabled;
                
                const badge = document.getElementById('ragStatusBadge');
                const disableBtn = document.getElementById('ragDisableBtn');
                const modelSelect = document.getElementById('ragEmbeddingModel');
                
                if (data.enabled) {
                    badge.className = 'badge badge-success';
                    badge.textContent = 'Enabled';
                    disableBtn.classList.remove('hidden');
                    // Set the current model in the dropdown
                    if (data.embedding_model) {
                        modelSelect.value = data.embedding_model;
                    }
                } else {
                    badge.className = 'badge badge-secondary';
                    badge.textContent = 'Disabled';
                    disableBtn.classList.add('hidden');
                }
                
                // Update stats
                if (data.stats) {
                    document.getElementById('ragDocCount').textContent = data.stats.document_count || 0;
                    document.getElementById('ragChunkCount').textContent = data.stats.chunk_count || 0;
                    document.getElementById('ragEmbeddingCount').textContent = data.stats.embedding_count || 0;
                }
            } catch (e) {
                console.error('Failed to load RAG status:', e);
            }
        }
        
        async function loadRAGEmbeddingModels() {
            try {
                // First get current RAG status to know which model is active
                const statusResp = await fetch('/v1/rag/status');
                const status = await statusResp.json();
                const currentModel = status.embedding_model || '';
                
                const response = await fetch('/v1/models');
                const data = await response.json();
                const select = document.getElementById('ragEmbeddingModel');
                select.innerHTML = '<option value="">Select model to enable...</option>';
                
                const embeddingModels = data.data.filter(m => 
                    m.id.toLowerCase().includes('embed') || 
                    m.id.toLowerCase().includes('minilm') ||
                    m.id.toLowerCase().includes('bge') ||
                    m.id.toLowerCase().includes('nomic')
                );
                
                let modelsToShow = embeddingModels.length > 0 ? embeddingModels : data.data;
                
                modelsToShow.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    select.appendChild(option);
                });
                
                // Set the dropdown to show current model if RAG is enabled
                if (currentModel) {
                    select.value = currentModel;
                }
            } catch (e) {
                console.error('Failed to load embedding models:', e);
            }
        }
        
        // Called when embedding model dropdown changes
        async function onEmbeddingModelChange() {
            const model = document.getElementById('ragEmbeddingModel').value;
            
            if (!model) {
                // If cleared, disable RAG
                if (ragEnabled) {
                    await disableRAG();
                }
                return;
            }
            
            // Enable RAG with selected model
            try {
                const response = await fetch('/v1/rag/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ embedding_model: model })
                });
                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err);
                }
                loadRAGStatus();
            } catch (e) {
                showAlert('Failed to enable RAG: ' + e.message, 'error');
            }
        }
        
        async function disableRAG() {
            try {
                await fetch('/v1/rag/disable', { method: 'POST' });
                document.getElementById('ragEmbeddingModel').value = '';
                loadRAGStatus();
            } catch (e) {
                showAlert('Failed to disable RAG: ' + e.message, 'error');
            }
        }
        
        // Legacy function - kept for compatibility
        async function toggleRAG() {
            if (ragEnabled) {
                await disableRAG();
            } else {
                await onEmbeddingModelChange();
            }
        }
        
        // Toggle developer tools section
        function toggleDevTools() {
            const content = document.getElementById('devToolsContent');
            const icon = document.getElementById('devToolsIcon');
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }
        
        async function refreshRAGDocuments() {
            try {
                const response = await fetch('/v1/documents');
                const data = await response.json();
                const list = document.getElementById('ragDocumentsList');
                
                if (!data.documents || data.documents.length === 0) {
                    list.innerHTML = '<p class="text-secondary text-sm">No documents uploaded yet.</p>';
                    return;
                }
                
                list.innerHTML = data.documents.map(doc => `
                    <div class="flex items-center justify-between p-3 bg-tertiary rounded-lg">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <div>
                                <div class="font-medium">${doc.name}</div>
                                <div class="text-xs text-secondary">${doc.chunk_count} chunks â€¢ ${formatBytes(doc.size)}</div>
                            </div>
                        </div>
                        <button onclick="deleteRAGDocument('${doc.id}')" class="btn btn-secondary btn-sm text-red-400 hover:text-red-300">
                            Delete
                        </button>
                    </div>
                `).join('');
                
                loadRAGStatus(); // Refresh stats
            } catch (e) {
                console.error('Failed to load documents:', e);
            }
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        async function ingestRAGText() {
            const content = document.getElementById('ragTextInput').value.trim();
            const name = document.getElementById('ragTextName').value.trim() || 'untitled.txt';
            
            if (!content) {
                showAlert('Please enter some text content', 'warning');
                return;
            }
            
            if (!ragEnabled) {
                showAlert('Please enable RAG first by selecting an embedding model', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/v1/documents/ingest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, content })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to ingest document');
                }
                
                document.getElementById('ragTextInput').value = '';
                document.getElementById('ragTextName').value = '';
                refreshRAGDocuments();
                showAlert('Document added successfully!', 'success');
            } catch (e) {
                showAlert('Failed to ingest document: ' + e.message, 'error');
            }
        }
        
        async function deleteRAGDocument(docId) {
            showConfirm('Are you sure you want to delete this document?', async () => {
                try {
                    await fetch('/v1/documents/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: docId })
                    });
                    refreshRAGDocuments();
                } catch (e) {
                    showAlert('Failed to delete document: ' + e.message, 'error');
                }
            }, { title: 'Delete Document', confirmText: 'Delete', type: 'error' });
        }
        
        async function searchRAGDocuments() {
            const query = document.getElementById('ragSearchQuery').value.trim();
            if (!query) {
                showAlert('Please enter a search query', 'warning');
                return;
            }
            
            const resultsDiv = document.getElementById('ragSearchResults');
            resultsDiv.innerHTML = '<p class="text-secondary">Searching...</p>';
            
            try {
                const response = await fetch('/v1/documents/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, top_k: 5 })
                });
                
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-secondary">No results found.</p>';
                    return;
                }
                
                resultsDiv.innerHTML = data.results.map((r, i) => `
                    <div class="p-3 bg-tertiary rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium">${r.document_name}</span>
                            <span class="text-xs text-accent">Score: ${(r.score * 100).toFixed(1)}%</span>
                        </div>
                        <p class="text-sm text-secondary">${r.chunk.content.substring(0, 300)}${r.chunk.content.length > 300 ? '...' : ''}</p>
                    </div>
                `).join('');
            } catch (e) {
                resultsDiv.innerHTML = `<p class="text-red-400">Search failed: ${e.message}</p>`;
            }
        }
        
        // Drag & Drop handlers for RAG
        function handleRAGDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('border-accent');
        }
        
        function handleRAGDragLeave(event) {
            event.currentTarget.classList.remove('border-accent');
        }
        
        async function handleRAGDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-accent');
            
            const files = event.dataTransfer.files;
            await uploadRAGFiles(files);
        }
        
        async function handleRAGFileSelect(event) {
            const files = event.target.files;
            await uploadRAGFiles(files);
            event.target.value = ''; // Reset for next upload
        }
        
        async function uploadRAGFiles(files) {
            if (!ragEnabled) {
                showAlert('Please enable RAG first by selecting an embedding model', 'warning');
                return;
            }
            
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/v1/documents/ingest', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to upload');
                    }
                } catch (e) {
                    showAlert(`Failed to upload ${file.name}: ${e.message}`, 'error');
                }
            }
            
            refreshRAGDocuments();
        }
        
        // ==================== Benchmark Functions ====================
        
        let benchmarkHistory = JSON.parse(localStorage.getItem('offgrid_benchmarks') || '[]');
        
        async function loadBenchmarkModels() {
            try {
                const response = await fetch('/v1/models');
                const data = await response.json();
                const select = document.getElementById('benchmarkModel');
                select.innerHTML = '<option value="">Choose a model...</option>';
                
                // Filter for LLM models (not embeddings)
                const llmModels = data.data.filter(m => 
                    !m.id.toLowerCase().includes('embed') && 
                    !m.id.toLowerCase().includes('minilm') &&
                    !m.id.toLowerCase().includes('bge')
                );
                
                llmModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load models:', e);
            }
        }
        
        async function loadSystemInfo() {
            try {
                const response = await fetch('/v1/system/info');
                const data = await response.json();
                
                // Format CPU - truncate if too long
                let cpuName = data.cpu || 'Unknown';
                if (cpuName.length > 40) {
                    cpuName = cpuName.substring(0, 37) + '...';
                }
                document.getElementById('sysInfoCPU').textContent = cpuName;
                document.getElementById('sysInfoCPU').title = data.cpu || 'Unknown'; // Full name on hover
                
                // Format RAM
                if (data.total_memory) {
                    const totalGB = (data.total_memory / 1024 / 1024 / 1024).toFixed(1);
                    const freeGB = data.free_memory ? (data.free_memory / 1024 / 1024 / 1024).toFixed(1) : '?';
                    document.getElementById('sysInfoRAM').textContent = `${totalGB} GB`;
                    document.getElementById('sysInfoRAM').title = `${freeGB} GB available`;
                } else {
                    document.getElementById('sysInfoRAM').textContent = 'Unknown';
                }
                
                // Format GPU
                let gpuName = data.gpu || 'CPU only';
                if (gpuName.length > 30) {
                    gpuName = gpuName.substring(0, 27) + '...';
                }
                document.getElementById('sysInfoGPU').textContent = gpuName;
                if (data.gpu_memory) {
                    const gpuMemGB = (data.gpu_memory / 1024 / 1024 / 1024).toFixed(1);
                    document.getElementById('sysInfoGPU').title = `${data.gpu} (${gpuMemGB} GB VRAM)`;
                } else {
                    document.getElementById('sysInfoGPU').title = data.gpu || 'CPU only';
                }
                
                // Backend
                document.getElementById('sysInfoBackend').textContent = data.backend || 'llama.cpp';
                
            } catch (e) {
                console.error('Failed to load system info:', e);
                document.getElementById('sysInfoCPU').textContent = 'Error loading';
                document.getElementById('sysInfoRAM').textContent = 'Error loading';
                document.getElementById('sysInfoGPU').textContent = 'Error loading';
            }
        }
        
        async function runBenchmark() {
            const model = document.getElementById('benchmarkModel').value;
            if (!model) {
                showAlert('Please select a model first', 'warning');
                return;
            }
            
            const promptLength = document.getElementById('benchmarkPromptLength').value;
            const outputTokens = parseInt(document.getElementById('benchmarkOutputTokens').value);
            
            const btn = document.getElementById('benchmarkRunBtn');
            const progress = document.getElementById('benchmarkProgress');
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Running...';
            progress.classList.remove('hidden');
            
            // Generate test prompt based on length
            let prompt = '';
            switch (promptLength) {
                case 'short':
                    prompt = 'Write a haiku about programming.';
                    break;
                case 'medium':
                    prompt = 'Explain the concept of recursion in programming. Include an example and discuss when it should be used versus iteration.';
                    break;
                case 'long':
                    prompt = 'Write a comprehensive guide on building a REST API. Cover the following topics: 1) What is REST and its principles, 2) HTTP methods and status codes, 3) Authentication and authorization, 4) Error handling, 5) Best practices for API design. Include code examples where appropriate.';
                    break;
            }
            
            const startTime = performance.now();
            let firstTokenTime = null;
            let tokenCount = 0;
            
            try {
                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: outputTokens,
                        stream: true
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.choices && data.choices[0].delta && data.choices[0].delta.content) {
                                    if (!firstTokenTime) {
                                        firstTokenTime = performance.now();
                                    }
                                    tokenCount++;
                                    
                                    // Update progress
                                    const percent = Math.min((tokenCount / outputTokens) * 100, 100);
                                    document.getElementById('benchmarkProgressBar').style.width = percent + '%';
                                    document.getElementById('benchmarkPercent').textContent = Math.round(percent) + '%';
                                    
                                    // Update live metrics
                                    const elapsed = (performance.now() - startTime) / 1000;
                                    document.getElementById('benchLiveTokensPerSec').textContent = (tokenCount / elapsed).toFixed(1);
                                    if (firstTokenTime) {
                                        document.getElementById('benchLiveTimeToFirst').textContent = Math.round(firstTokenTime - startTime);
                                    }
                                    document.getElementById('benchLiveTotalTime').textContent = elapsed.toFixed(2);
                                }
                            } catch (e) { }
                        }
                    }
                }
                
                const endTime = performance.now();
                const totalTime = (endTime - startTime) / 1000;
                const ttft = firstTokenTime ? (firstTokenTime - startTime) : 0;
                const tokensPerSec = tokenCount / totalTime;
                
                // Get memory usage from health endpoint
                let memoryGB = '--';
                try {
                    const healthRes = await fetch('/health');
                    const healthData = await healthRes.json();
                    if (healthData.system && healthData.system.memory_mb) {
                        memoryGB = (healthData.system.memory_mb / 1024).toFixed(2);
                        document.getElementById('benchLiveMemory').textContent = memoryGB;
                    }
                } catch (e) { }
                
                // Save to history
                const result = {
                    model,
                    tokensPerSec: tokensPerSec.toFixed(1),
                    ttft: Math.round(ttft),
                    totalTime: totalTime.toFixed(2),
                    memory: memoryGB,
                    date: new Date().toLocaleString(),
                    promptLength,
                    outputTokens
                };
                
                benchmarkHistory.unshift(result);
                benchmarkHistory = benchmarkHistory.slice(0, 20); // Keep last 20
                localStorage.setItem('offgrid_benchmarks', JSON.stringify(benchmarkHistory));
                
                renderBenchmarkHistory();
                
            } catch (e) {
                showAlert('Benchmark failed: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Run Benchmark';
                progress.classList.add('hidden');
            }
        }
        
        function renderBenchmarkHistory() {
            const table = document.getElementById('benchmarkHistoryTable');
            const chart = document.getElementById('benchmarkChart');
            
            if (benchmarkHistory.length === 0) {
                table.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-secondary">No benchmarks yet</td></tr>';
                chart.innerHTML = '<p class="text-secondary text-sm text-center py-4">Run benchmarks to see comparison charts</p>';
                return;
            }
            
            // Render table
            table.innerHTML = benchmarkHistory.map(r => `
                <tr class="border-b border-theme">
                    <td class="py-2 px-3">${r.model}</td>
                    <td class="text-right py-2 px-3 font-mono">${r.tokensPerSec}</td>
                    <td class="text-right py-2 px-3 font-mono">${r.ttft}</td>
                    <td class="text-right py-2 px-3 font-mono">${r.totalTime}s</td>
                    <td class="text-right py-2 px-3 font-mono">${r.memory}</td>
                    <td class="text-right py-2 px-3 text-secondary text-xs">${r.date}</td>
                </tr>
            `).join('');
            
            // Render simple bar chart for tokens/sec
            const maxTokens = Math.max(...benchmarkHistory.map(r => parseFloat(r.tokensPerSec)));
            chart.innerHTML = benchmarkHistory.slice(0, 5).map(r => {
                const width = (parseFloat(r.tokensPerSec) / maxTokens) * 100;
                return `
                    <div class="flex items-center gap-3">
                        <div class="w-32 truncate text-sm">${r.model.split('/').pop()}</div>
                        <div class="flex-1 bg-tertiary rounded-full h-4 overflow-hidden">
                            <div class="bg-accent h-full rounded-full transition-all" style="width: ${width}%"></div>
                        </div>
                        <div class="w-20 text-right text-sm font-mono">${r.tokensPerSec} t/s</div>
                    </div>
                `;
            }).join('');
        }
        
        function clearBenchmarkHistory() {
            showConfirm('Clear all benchmark history?', () => {
                benchmarkHistory = [];
                localStorage.removeItem('offgrid_benchmarks');
                renderBenchmarkHistory();
            }, { title: 'Clear History', confirmText: 'Clear All', type: 'warning' });
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Setup terminal scroll tracking
            const terminalOutput = document.getElementById('terminalOutput');
            terminalOutput.addEventListener('scroll', () => {
                const isAtBottom = terminalOutput.scrollHeight - terminalOutput.scrollTop <= terminalOutput.clientHeight + 50;
                userScrolledUp = !isAtBottom;
            });
            
            // Restore active tab
            const savedTab = localStorage.getItem('offgrid_active_tab');
            if (savedTab && document.getElementById('tab-' + savedTab)) {
                switchTab(savedTab);
            } else {
                switchTab('chat');
            }
            
            // Load saved messages
            loadMessages();
            
            // Load chat models
            loadChatModels();
            
            // Setup Knowledge Base toggle indicator
            const kbCheckbox = document.getElementById('useKnowledgeBase');
            const ragIndicator = document.getElementById('ragIndicator');
            
            // Restore saved preference
            const savedKbPref = localStorage.getItem('offgrid_use_knowledge_base');
            if (savedKbPref === 'true') {
                kbCheckbox.checked = true;
                ragIndicator.classList.remove('hidden');
            }
            
            kbCheckbox.addEventListener('change', async () => {
                if (kbCheckbox.checked) {
                    // Check if RAG is enabled on the server
                    try {
                        const response = await fetch('/v1/rag/status');
                        const data = await response.json();
                        if (!data.enabled) {
                            showAlert('Knowledge Base is not enabled on the server. Go to the Knowledge Base tab and enable RAG first.', 'warning');
                            kbCheckbox.checked = false;
                            return;
                        }
                        if (!data.stats || data.stats.document_count === 0) {
                            showAlert('No documents in knowledge base. Upload some documents in the Knowledge Base tab first.', 'warning');
                        }
                    } catch (e) {
                        console.error('Failed to check RAG status:', e);
                    }
                    ragIndicator.classList.remove('hidden');
                    localStorage.setItem('offgrid_use_knowledge_base', 'true');
                } else {
                    ragIndicator.classList.add('hidden');
                    localStorage.setItem('offgrid_use_knowledge_base', 'false');
                }
            });
        });

        // Theme Toggle Logic
        const themeToggleBtn = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;
        
        // Check for saved theme preference or system preference
        const savedTheme = localStorage.getItem('theme');
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        
        // Set initial theme
        if (savedTheme === 'dark' || (!savedTheme && systemTheme === 'dark')) {
            htmlElement.setAttribute('data-theme', 'dark');
        } else {
            htmlElement.removeAttribute('data-theme');
        }
        
        themeToggleBtn.addEventListener('click', () => {
            if (htmlElement.getAttribute('data-theme') === 'dark') {
                htmlElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                htmlElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        });

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        let currentAuthUser = null;
        
        async function checkAuthStatus() {
            try {
                // Try to get current user info from a protected endpoint
                const resp = await fetch('/v1/users/me', { credentials: 'include' });
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.user) {
                        setAuthUser(data.user);
                        return;
                    }
                }
            } catch (e) {
                console.log('Auth check failed, treating as guest');
            }
            setAuthUser(null);
        }
        
        function setAuthUser(user) {
            currentAuthUser = user;
            const loggedIn = document.getElementById('authLoggedIn');
            const loggedOut = document.getElementById('authLoggedOut');
            
            if (user) {
                loggedIn.classList.remove('hidden');
                loggedOut.classList.add('hidden');
                document.getElementById('authUserInitial').textContent = user.username.charAt(0).toUpperCase();
                document.getElementById('authUsername').textContent = user.username;
                document.getElementById('authRole').textContent = user.role;
            } else {
                loggedIn.classList.add('hidden');
                loggedOut.classList.remove('hidden');
            }
        }
        
        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginUsername').focus();
        }
        
        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('flex');
        }
        
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            if (!username) {
                errorEl.textContent = 'Please enter a username';
                errorEl.classList.remove('hidden');
                return;
            }
            
            try {
                const resp = await fetch('/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });
                
                const data = await resp.json();
                
                if (resp.ok) {
                    hideLoginModal();
                    setAuthUser(data.user);
                    showAlert('Logged in successfully', { title: 'Welcome', type: 'success' });
                } else {
                    errorEl.textContent = data.error || 'Login failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'Connection error: ' + e.message;
                errorEl.classList.remove('hidden');
            }
        }
        
        async function handleLogout() {
            try {
                await fetch('/v1/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                setAuthUser(null);
                showAlert('Logged out successfully', { type: 'info' });
            } catch (e) {
                console.error('Logout failed:', e);
            }
        }
        
        // System configuration (feature flags)
        let systemConfig = { multi_user_mode: false, features: {} };
        
        async function loadSystemConfig() {
            try {
                const resp = await fetch('/v1/system/config');
                if (resp.ok) {
                    systemConfig = await resp.json();
                    applyFeatureFlags();
                }
            } catch (e) {
                console.log('Using default config (single-user mode)');
            }
        }
        
        function applyFeatureFlags() {
            const multiUserNav = document.getElementById('multiUserNav');
            const authStatus = document.getElementById('authStatus');
            const createAccountLink = document.getElementById('loginCreateAccountLink');
            
            if (systemConfig.multi_user_mode) {
                // Multi-user mode: show Users, Metrics, and auth status
                if (multiUserNav) multiUserNav.classList.remove('hidden');
                if (authStatus) authStatus.classList.remove('hidden');
                if (createAccountLink) createAccountLink.classList.remove('hidden');
            } else {
                // Single-user mode: hide Users, Metrics, and auth status
                if (multiUserNav) multiUserNav.classList.add('hidden');
                if (authStatus) authStatus.classList.add('hidden');
                if (createAccountLink) createAccountLink.classList.add('hidden');
            }
        }
        
        // Load config and check auth on page load
        loadSystemConfig();
        checkAuthStatus();

        // ============================================
        // AGENT FUNCTIONS
        // ============================================
        
        let agentAbortController = null;
        
        async function loadAgentModels() {
            try {
                const resp = await fetch('/v1/models');
                const data = await resp.json();
                const select = document.getElementById('agentModel');
                select.innerHTML = '<option value="">Select Model...</option>';
                data.data.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.id;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load agent models:', e);
            }
        }
        
        async function loadAgentTools() {
            try {
                const resp = await fetch('/v1/agents/tools?all=true');
                const data = await resp.json();
                const tools = data.tools || [];
                const list = document.getElementById('agentToolsList');
                const count = document.getElementById('toolCount');
                
                if (tools.length === 0) {
                    list.innerHTML = '<p class="text-secondary text-sm text-center py-4">No tools available</p>';
                    count.textContent = '0';
                    return;
                }
                
                count.textContent = data.enabled_count || tools.filter(t => t.enabled).length;
                list.innerHTML = tools.map(t => `
                    <div class="p-2 bg-tertiary rounded-lg flex items-center justify-between gap-2 ${!t.enabled ? 'opacity-50' : ''}">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm flex items-center gap-2">
                                <span class="truncate">${t.name}</span>
                                ${t.source && t.source !== 'builtin' ? `<span class="text-xs px-1 py-0.5 rounded bg-blue-500/20 text-blue-400">${t.source}</span>` : ''}
                            </div>
                            <div class="text-xs text-secondary mt-1 truncate">${t.description || 'No description'}</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                            <input type="checkbox" class="sr-only peer" ${t.enabled ? 'checked' : ''} onchange="toggleTool('${t.name}', this.checked)">
                            <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-accent"></div>
                        </label>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load tools:', e);
            }
        }
        
        async function toggleTool(name, enabled) {
            try {
                const resp = await fetch('/v1/agents/tools', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, enabled })
                });
                const data = await resp.json();
                if (resp.ok) {
                    document.getElementById('toolCount').textContent = data.enabled_count;
                    // Re-render with updated state
                    loadAgentTools();
                } else {
                    showAlert(data.error || 'Failed to toggle tool', { type: 'error' });
                }
            } catch (e) {
                showAlert('Failed to toggle tool: ' + e.message, { type: 'error' });
            }
        }
        
        async function loadMCPServers() {
            try {
                const resp = await fetch('/v1/agents/tools');
                const data = await resp.json();
                const tools = data.tools || [];
                // Filter for MCP tools (have source = mcp-*)
                const mcpTools = tools.filter(t => t.source && t.source.startsWith('mcp-'));
                const mcpServers = [...new Set(mcpTools.map(t => t.source.replace('mcp-', '')))];
                
                const list = document.getElementById('mcpServersList');
                if (mcpServers.length === 0) {
                    list.innerHTML = '<p class="text-secondary text-sm text-center py-4">No MCP servers configured</p>';
                    return;
                }
                
                list.innerHTML = mcpServers.map(s => `
                    <div class="flex items-center justify-between p-2 bg-tertiary rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                            <span class="text-sm font-medium">${s}</span>
                        </div>
                        <span class="text-xs text-secondary">${mcpTools.filter(t => t.source === 'mcp-' + s).length} tools</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load MCP servers:', e);
            }
        }
        
        async function runAgent() {
            const model = document.getElementById('agentModel').value;
            const task = document.getElementById('agentTask').value;
            const style = document.getElementById('agentStyle').value;
            const maxSteps = parseInt(document.getElementById('agentMaxSteps').value) || 10;
            
            if (!model || !task) {
                showAlert('Please select a model and enter a task', { title: 'Missing Information', type: 'warning' });
                return;
            }
            
            // Reset token buffer
            tokenBuffer = '';
            // Reset token buffer
            tokenBuffer = '';
            tokenContainer = null;
            
            // Reset duplicate content tracking
            displayedContents = new Set();
            lastStepId = -1;
            
            document.getElementById('runAgentBtn').classList.add('hidden');
            document.getElementById('stopAgentBtn').classList.remove('hidden');
            document.getElementById('agentOutput').innerHTML = '';
            
            agentAbortController = new AbortController();
            
            try {
                const resp = await fetch('/v1/agents/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, prompt: task, style, max_steps: maxSteps, stream: true }),
                    signal: agentAbortController.signal
                });
                
                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let output = document.getElementById('agentOutput');
                output.innerHTML = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const text = decoder.decode(value);
                    const lines = text.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const step = JSON.parse(data);
                                appendAgentStep(step);
                            } catch (e) {}
                        }
                    }
                }
            } catch (e) {
                if (e.name !== 'AbortError') {
                    document.getElementById('agentOutput').innerHTML += `<div class="text-red-400 p-2">Error: ${e.message}</div>`;
                }
            } finally {
                document.getElementById('runAgentBtn').classList.remove('hidden');
                document.getElementById('stopAgentBtn').classList.add('hidden');
                agentAbortController = null;
            }
        }
        
        // Token aggregator for streaming
        let tokenBuffer = '';
        let tokenContainer = null;
        let lastStepId = -1;
        
        // Clean up messy agent output - remove tool descriptions that leak into thoughts
        function cleanAgentOutput(text) {
            if (!text) return '';
            
            // Remove tool description blocks that the model echoes
            let cleaned = text;
            
            // Remove lines starting with "### tool_name" (tool headers)
            cleaned = cleaned.replace(/^###\s+\w+.*$/gm, '');
            
            // Remove "Description:" lines
            cleaned = cleaned.replace(/^Description:.*$/gm, '');
            
            // Remove "Parameters:" blocks
            cleaned = cleaned.replace(/^Parameters:[\s\S]*?(?=\n\n|Thought:|Action:|Answer:|$)/gm, '');
            
            // Remove "  - param (type):" lines
            cleaned = cleaned.replace(/^\s+-\s+\w+\s+\(\w+\):.*$/gm, '');
            
            // Remove "Required:" lines
            cleaned = cleaned.replace(/^Required:.*$/gm, '');
            
            // Remove "Action Input:" lines (model echoing examples)
            cleaned = cleaned.replace(/^Action Input:\s*\{.*\}$/gm, '');
            cleaned = cleaned.replace(/^Action Input:\s*$/gm, '');
            
            // Remove "Action:" lines that aren't tool calls
            cleaned = cleaned.replace(/^Action:\s*\w+\s*$/gm, '');
            
            // Remove "Observation:" prefix if followed by same content
            cleaned = cleaned.replace(/^Observation:\s*/gm, '');
            
            // Remove "Thought:" prefix - we already label it as Thought
            cleaned = cleaned.replace(/^Thought:\s*/gm, '');
            
            // Remove multiple newlines
            cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
            
            // Trim
            return cleaned.trim();
        }
        
        // Extract just the actual thought from messy output
        function extractThought(text) {
            if (!text) return '';
            
            // Look for content between "Thought:" and next section
            const thoughtMatch = text.match(/(?:^|Thought:\s*)([^]*?)(?=Action:|Answer:|Observation:|Action Input:|$)/i);
            if (thoughtMatch && thoughtMatch[1]) {
                let thought = thoughtMatch[1].trim();
                // Clean remaining noise
                return cleanAgentOutput(thought);
            }
            
            // If no explicit Thought:, clean the whole text
            return cleanAgentOutput(text);
        }
        
        // Track displayed content to avoid duplicates
        let displayedContents = new Set();
        
        function appendAgentStep(step) {
            const output = document.getElementById('agentOutput');
            const stepType = step.step_type || step.type || 'unknown';
            const stepId = step.step_id || step.id;
            
            // Handle token events - aggregate into a single streaming container
            if (stepType === 'token') {
                tokenBuffer += step.token || '';
                if (!tokenContainer) {
                    tokenContainer = document.createElement('div');
                    tokenContainer.className = 'agent-step agent-step-streaming';
                    tokenContainer.id = 'token-stream';
                    tokenContainer.innerHTML = `
                        <div class="agent-step-header">
                            <span class="agent-step-indicator streaming"></span>
                            <span class="agent-step-label">Thinking...</span>
                        </div>
                        <div class="agent-step-content" id="token-content"></div>
                    `;
                    output.appendChild(tokenContainer);
                }
                document.getElementById('token-content').textContent = tokenBuffer;
                output.scrollTop = output.scrollHeight;
                return;
            }
            
            // When we get a real step, finalize the token buffer and remove streaming container
            if (tokenContainer && tokenBuffer.trim()) {
                // Clean and format the streamed content
                const cleanedContent = extractThought(tokenBuffer);
                if (cleanedContent && !displayedContents.has(cleanedContent.substring(0, 100))) {
                    // Track this content to avoid showing it again
                    displayedContents.add(cleanedContent.substring(0, 100));
                    // Keep the content but change the style to a finalized thought
                    tokenContainer.className = 'agent-step agent-step-thought';
                    tokenContainer.innerHTML = `
                        <div class="agent-step-header">
                            <span class="agent-step-indicator"></span>
                            <span class="agent-step-label">Reasoning</span>
                        </div>
                        <div class="agent-step-content">${escapeHtml(cleanedContent)}</div>
                    `;
                } else {
                    // Content was all noise or duplicate, remove it
                    tokenContainer.remove();
                }
            } else if (tokenContainer) {
                // Remove empty streaming container
                tokenContainer.remove();
            }
            
            // Reset token state
            tokenBuffer = '';
            tokenContainer = null;
            
            // Skip status updates - they clutter the output
            if (stepType === 'status') return;
            
            // Skip duplicate steps with same ID
            if (stepId !== undefined && stepId === lastStepId) return;
            lastStepId = stepId;
            
            const stepDiv = document.createElement('div');
            
            const typeConfig = {
                'thought': { class: 'thought', label: 'Thought' },
                'action': { class: 'action', label: 'Action' },
                'observation': { class: 'observation', label: 'Observation' },
                'answer': { class: 'answer', label: 'Answer' },
                'step': { class: 'step', label: 'Step' },
                'done': { class: 'complete', label: 'Complete' },
                'error': { class: 'error', label: 'Error' }
            };
            
            const config = typeConfig[stepType] || { class: 'default', label: stepType };
            
            stepDiv.className = `agent-step agent-step-${config.class}`;
            
            let content = step.content || step.output || '';
            if (step.error) content = step.error;
            
            // Clean thought content to remove tool descriptions that leak through
            if (stepType === 'thought' || stepType === 'step') {
                content = extractThought(content);
            } else {
                content = cleanAgentOutput(content);
            }
            
            // Skip empty steps after cleaning
            if (!content && !step.tool_name && !step.tool_result) return;
            
            // Skip duplicate content (Reasoning already showed it from streaming)
            const contentKey = content.substring(0, 100);
            if (stepType === 'thought' && displayedContents.has(contentKey)) {
                return; // Already shown as Reasoning from streaming
            }
            if (content) {
                displayedContents.add(contentKey);
            }
            
            content = escapeHtml(content);
            
            let html = `
                <div class="agent-step-header">
                    <span class="agent-step-indicator"></span>
                    <span class="agent-step-label">${config.label}</span>
                    ${stepId !== undefined ? `<span class="agent-step-number">#${stepId}</span>` : ''}
                    ${step.tool_name ? `<span class="agent-step-tool">${step.tool_name}</span>` : ''}
                </div>
                <div class="agent-step-content">${content}</div>
            `;
            
            // Add tool arguments if present
            if (step.tool_args && Object.keys(step.tool_args).length > 0) {
                const argsStr = typeof step.tool_args === 'string' ? step.tool_args : JSON.stringify(step.tool_args, null, 2);
                html += `<div class="agent-step-meta">
                    <div class="agent-step-meta-label">Input</div>
                    <pre class="agent-step-code">${escapeHtml(argsStr)}</pre>
                </div>`;
            }
            
            // Add tool result if present  
            if (step.tool_result) {
                const resultStr = typeof step.tool_result === 'string' ? step.tool_result : JSON.stringify(step.tool_result, null, 2);
                html += `<div class="agent-step-meta">
                    <div class="agent-step-meta-label">Output</div>
                    <pre class="agent-step-code result">${escapeHtml(resultStr)}</pre>
                </div>`;
            }
            
            stepDiv.innerHTML = html;
            output.appendChild(stepDiv);
            output.scrollTop = output.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function stopAgent() {
            if (agentAbortController) {
                agentAbortController.abort();
            }
        }
        
        function showAddMCPModal() {
            document.getElementById('addMCPModal').classList.remove('hidden');
            document.getElementById('addMCPModal').classList.add('flex');
            document.getElementById('mcpServerName').value = '';
            document.getElementById('mcpServerUrl').value = '';
            document.getElementById('mcpCommandHint').classList.add('hidden');
        }
        
        function hideAddMCPModal() {
            document.getElementById('addMCPModal').classList.add('hidden');
            document.getElementById('addMCPModal').classList.remove('flex');
            // Reset connection status
            document.getElementById('mcpConnectionStatus').classList.add('hidden');
        }
        
        function fillMCPExample(name, command) {
            document.getElementById('mcpServerName').value = name;
            document.getElementById('mcpServerUrl').value = command;
            // Reset connection status when changing server
            document.getElementById('mcpConnectionStatus').classList.add('hidden');
        }
        
        function showMCPStatus(status, message) {
            const statusDiv = document.getElementById('mcpConnectionStatus');
            const indicator = document.getElementById('mcpStatusIndicator');
            const text = document.getElementById('mcpStatusText');
            
            statusDiv.classList.remove('hidden', 'bg-green-500/10', 'bg-red-500/10', 'bg-yellow-500/10');
            indicator.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'animate-pulse');
            
            if (status === 'testing') {
                statusDiv.classList.add('bg-yellow-500/10');
                indicator.classList.add('bg-yellow-500', 'animate-pulse');
            } else if (status === 'success') {
                statusDiv.classList.add('bg-green-500/10');
                indicator.classList.add('bg-green-500');
            } else {
                statusDiv.classList.add('bg-red-500/10');
                indicator.classList.add('bg-red-500');
            }
            
            text.textContent = message;
        }
        
        async function testMCPConnection() {
            const urlOrCommand = document.getElementById('mcpServerUrl').value;
            
            if (!urlOrCommand) {
                showAlert('Please enter a server URL or command first', { title: 'Missing Input', type: 'warning' });
                return;
            }
            
            const isCommand = urlOrCommand.startsWith('npx ') || urlOrCommand.startsWith('node ') || 
                              urlOrCommand.startsWith('python ') || urlOrCommand.startsWith('./') || 
                              urlOrCommand.startsWith('/');
            
            showMCPStatus('testing', isCommand ? 'Starting server and testing...' : 'Testing connection...');
            
            try {
                const resp = await fetch('/v1/agents/mcp/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: urlOrCommand })
                });
                
                const data = await resp.json();
                
                if (resp.ok) {
                    showMCPStatus('success', `Connected! Found ${data.tools_count || 0} tools available.`);
                } else {
                    showMCPStatus('error', data.error || 'Connection failed');
                }
            } catch (e) {
                showMCPStatus('error', 'Connection failed: ' + e.message);
            }
        }
        
        async function addMCPServer() {
            const name = document.getElementById('mcpServerName').value;
            const url = document.getElementById('mcpServerUrl').value;
            
            if (!name || !url) {
                showAlert('Please fill in all fields', { title: 'Missing Information', type: 'warning' });
                return;
            }
            
            try {
                // Add to tools.json config
                const resp = await fetch('/v1/agents/mcp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, url })
                });
                
                if (resp.ok) {
                    const data = await resp.json();
                    showAlert(`MCP server "${name}" added successfully!<br><br>Found ${data.tools_added || 0} tools from this server.`, { title: 'Server Added', type: 'success' });
                    hideAddMCPModal();
                    loadAgentTools();
                    loadMCPServers();
                } else {
                    const err = await resp.json();
                    throw new Error(err.error || 'Failed to add server');
                }
            } catch (e) {
                showAlert('Failed to add MCP server: ' + e.message + '<br><br>Make sure the MCP server is running first. Use the "Test Connection" button to verify.', { title: 'Error', type: 'error' });
            }
        }

        // ============================================
        // USER MANAGEMENT FUNCTIONS
        // ============================================
        
        async function loadUsers() {
            try {
                const resp = await fetch('/v1/users');
                const data = await resp.json();
                
                const tbody = document.getElementById('usersTableBody');
                const users = data.users || [];
                
                document.getElementById('totalUsersCount').textContent = users.length;
                document.getElementById('adminUsersCount').textContent = users.filter(u => u.role === 'admin').length;
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-secondary">No users found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(u => `
                    <tr class="border-b border-theme hover:bg-tertiary/50">
                        <td class="py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center text-accent font-bold text-sm">
                                    ${u.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-medium">${u.username}</div>
                                    <div class="text-xs text-secondary">${u.id.substring(0, 8)}...</div>
                                </div>
                            </div>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 rounded text-xs font-medium ${getRoleBadgeClass(u.role)}">${u.role}</span>
                        </td>
                        <td class="py-3 text-sm text-secondary">${formatDate(u.created_at)}</td>
                        <td class="py-3 text-sm text-secondary">${u.last_login_at ? formatDate(u.last_login_at) : 'Never'}</td>
                        <td class="py-3 text-right">
                            <button onclick="showUserDetails('${u.id}')" class="btn btn-secondary btn-sm mr-1">View</button>
                            <button onclick="deleteUser('${u.id}')" class="btn btn-danger btn-sm">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load users:', e);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-400">Failed to load users</td></tr>';
            }
        }
        
        function getRoleBadgeClass(role) {
            const classes = {
                'admin': 'bg-red-500/20 text-red-400',
                'user': 'bg-blue-500/20 text-blue-400',
                'viewer': 'bg-green-500/20 text-green-400',
                'guest': 'bg-gray-500/20 text-gray-400'
            };
            return classes[role] || classes['user'];
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString();
        }
        
        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            const showIcon = btn.querySelector('.show-icon');
            const hideIcon = btn.querySelector('.hide-icon');
            if (input.type === 'password') {
                input.type = 'text';
                showIcon.classList.add('hidden');
                hideIcon.classList.remove('hidden');
            } else {
                input.type = 'password';
                showIcon.classList.remove('hidden');
                hideIcon.classList.add('hidden');
            }
        }
        
        function showCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
            document.getElementById('createUserModal').classList.add('flex');
        }
        
        function hideCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
            document.getElementById('createUserModal').classList.remove('flex');
        }
        
        async function createUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!username) {
                showAlert('Please enter a username', { title: 'Missing Information', type: 'warning' });
                return;
            }
            
            if (!password) {
                showAlert('Please enter a password', { title: 'Missing Information', type: 'warning' });
                return;
            }
            
            try {
                const resp = await fetch('/v1/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });
                
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.error || 'Failed to create user');
                }
                
                const data = await resp.json();
                hideCreateUserModal();
                loadUsers();
                
                // Clear form
                document.getElementById('newUsername').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserRole').value = 'user';
                
                // Offer to login as new user
                showConfirm(
                    `User "${username}" created!<br><br>` +
                    `<strong>API Key:</strong><br><code class="bg-tertiary px-2 py-1 rounded text-xs break-all">${data.api_key}</code><br><br>` +
                    `<small class="text-secondary">Save this key - it won't be shown again.</small><br><br>` +
                    `Would you like to login as this user now?`,
                    async () => {
                        // Auto-login with the credentials
                        const loginResp = await fetch('/v1/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password }),
                            credentials: 'include'
                        });
                        if (loginResp.ok) {
                            const loginData = await loginResp.json();
                            setAuthUser(loginData.user);
                            showAlert(`Logged in as ${username}`, { title: 'Welcome!', type: 'success' });
                        }
                    },
                    { title: 'User Created', type: 'success', confirmText: 'Login Now', cancelText: 'Not Now' }
                );
            } catch (e) {
                showAlert('Failed to create user: ' + e.message, { title: 'Error', type: 'error' });
            }
        }
        
        async function deleteUser(id) {
            showConfirm('Are you sure you want to delete this user? This action cannot be undone.', async () => {
                try {
                    const resp = await fetch(`/v1/users/${id}`, { method: 'DELETE' });
                    if (!resp.ok) throw new Error('Failed to delete user');
                    loadUsers();
                    showAlert('User deleted successfully', { title: 'Deleted', type: 'success' });
                } catch (e) {
                    showAlert('Failed to delete user: ' + e.message, { title: 'Error', type: 'error' });
                }
            }, { title: 'Delete User?', type: 'warning', confirmText: 'Delete', cancelText: 'Cancel' });
        }
        
        function filterUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }
        
        let currentUserDetails = null;
        
        async function showUserDetails(userId) {
            try {
                const resp = await fetch(`/v1/users/${userId}`);
                if (!resp.ok) throw new Error('Failed to fetch user');
                const user = await resp.json();
                currentUserDetails = user;
                
                const content = document.getElementById('userDetailsContent');
                content.innerHTML = `
                    <div class="flex items-center gap-4 pb-4 border-b border-theme">
                        <div class="w-16 h-16 rounded-full bg-accent/20 flex items-center justify-center text-accent text-2xl font-bold">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold">${user.username}</h4>
                            <span class="px-2 py-1 rounded text-xs font-medium ${getRoleBadgeClass(user.role)}">${user.role}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-secondary block mb-1">User ID</label>
                            <code class="text-sm bg-tertiary px-2 py-1 rounded block break-all">${user.id}</code>
                        </div>
                        <div>
                            <label class="text-xs text-secondary block mb-1">Created</label>
                            <span class="text-sm">${formatDate(user.created_at)}</span>
                        </div>
                        <div>
                            <label class="text-xs text-secondary block mb-1">Last Active</label>
                            <span class="text-sm">${user.last_login_at ? formatDate(user.last_login_at) : 'Never'}</span>
                        </div>
                        <div>
                            <label class="text-xs text-secondary block mb-1">API Key</label>
                            <span class="text-sm text-secondary italic">Hidden for security</span>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-theme">
                        <h5 class="text-sm font-semibold mb-3">Quota & Usage</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-tertiary rounded-lg p-3">
                                <div class="text-2xl font-bold text-accent">${user.tokens_used || 0}</div>
                                <div class="text-xs text-secondary">Tokens Used</div>
                            </div>
                            <div class="bg-tertiary rounded-lg p-3">
                                <div class="text-2xl font-bold text-emerald-400">${user.requests_count || 0}</div>
                                <div class="text-xs text-secondary">Requests Made</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('userDetailsModal').classList.remove('hidden');
                document.getElementById('userDetailsModal').classList.add('flex');
            } catch (e) {
                showAlert('Failed to load user details: ' + e.message, { title: 'Error', type: 'error' });
            }
        }
        
        function hideUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.add('hidden');
            document.getElementById('userDetailsModal').classList.remove('flex');
            currentUserDetails = null;
        }
        
        async function regenerateApiKey() {
            if (!currentUserDetails) return;
            
            showConfirm('Regenerate API key? The old key will stop working immediately.', async () => {
                try {
                    const resp = await fetch(`/v1/users/${currentUserDetails.id}/regenerate-key`, {
                        method: 'POST'
                    });
                    if (!resp.ok) throw new Error('Failed to regenerate key');
                    const data = await resp.json();
                    showAlert(`New API Key:<br><br><code class="bg-tertiary px-2 py-1 rounded text-sm break-all">${data.api_key}</code><br><br><small>Copy this - it won't be shown again.</small>`, { title: 'API Key Regenerated', type: 'success' });
                    hideUserDetailsModal();
                    loadUsers();
                } catch (e) {
                    showAlert('Failed to regenerate API key: ' + e.message, { title: 'Error', type: 'error' });
                }
            }, { title: 'Regenerate API Key?', type: 'warning', confirmText: 'Regenerate', cancelText: 'Cancel' });
        }
        
        async function editUserRole() {
            if (!currentUserDetails) return;
            
            const roles = ['admin', 'user', 'viewer', 'guest'];
            const currentRole = currentUserDetails.role;
            
            // Create a simple role selector
            const roleOptions = roles.map(r => 
                `<option value="${r}" ${r === currentRole ? 'selected' : ''}>${r}</option>`
            ).join('');
            
            const html = `
                <select id="newRoleSelect" class="w-full input-theme rounded-lg px-3 py-2">
                    ${roleOptions}
                </select>
            `;
            
            // Show a custom modal with the select
            showPrompt('Select new role:', async (newRole) => {
                if (!newRole || newRole === currentRole) return;
                try {
                    const resp = await fetch(`/v1/users/${currentUserDetails.id}/role`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: newRole })
                    });
                    if (!resp.ok) throw new Error('Failed to update role');
                    showAlert(`Role updated to ${newRole}`, { title: 'Role Updated', type: 'success' });
                    hideUserDetailsModal();
                    loadUsers();
                } catch (e) {
                    showAlert('Failed to update role: ' + e.message, { title: 'Error', type: 'error' });
                }
            }, { 
                title: 'Change User Role',
                inputType: 'select',
                selectOptions: roles,
                defaultValue: currentRole
            });
        }
        
        // Add showPrompt function for role editing
        function showPrompt(message, onSubmit, options = {}) {
            const { title = 'Input', inputType = 'text', selectOptions = [], defaultValue = '' } = options;
            
            let inputHtml = '';
            if (inputType === 'select') {
                const opts = selectOptions.map(o => 
                    `<option value="${o}" ${o === defaultValue ? 'selected' : ''}>${o}</option>`
                ).join('');
                inputHtml = `<select id="promptInput" class="w-full input-theme rounded-lg px-3 py-2 mt-3">${opts}</select>`;
            } else {
                inputHtml = `<input type="text" id="promptInput" value="${defaultValue}" class="w-full input-theme rounded-lg px-3 py-2 mt-3">`;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100]';
            modal.innerHTML = `
                <div class="bg-card border border-theme rounded-xl p-6 w-full max-w-sm mx-4 shadow-2xl">
                    <h3 class="text-lg font-semibold mb-2">${title}</h3>
                    <p class="text-secondary text-sm">${message}</p>
                    ${inputHtml}
                    <div class="flex gap-3 mt-4">
                        <button id="promptCancel" class="btn btn-secondary flex-1">Cancel</button>
                        <button id="promptSubmit" class="btn btn-primary flex-1">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const input = document.getElementById('promptInput');
            input.focus();
            
            modal.querySelector('#promptCancel').addEventListener('click', () => {
                modal.remove();
            });
            
            modal.querySelector('#promptSubmit').addEventListener('click', () => {
                onSubmit(input.value);
                modal.remove();
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    onSubmit(input.value);
                    modal.remove();
                }
            });
        }

        // ============================================
        // METRICS FUNCTIONS
        // ============================================
        
        async function loadMetrics() {
            try {
                // Fetch both prometheus metrics and system stats
                const [metricsResp, statsResp] = await Promise.all([
                    fetch('/metrics'),
                    fetch('/v1/system/stats')
                ]);
                
                const metricsText = await metricsResp.text();
                const rawMetricsEl = document.getElementById('rawMetrics');
                
                // Format the raw metrics for better readability
                if (rawMetricsEl) {
                    const formatted = formatPrometheusMetrics(metricsText);
                    rawMetricsEl.innerHTML = formatted;
                }
                
                // Use real system stats
                const stats = await statsResp.json();
                
                // Update top cards (with null checks)
                const reqEl = document.getElementById('metricRequests');
                const errEl = document.getElementById('metricErrors');
                const tokEl = document.getElementById('metricTokens');
                const latEl = document.getElementById('metricLatency');
                const avgLatEl = document.getElementById('metricAvgLatency');
                
                if (reqEl) reqEl.textContent = (stats.requests_total || 0).toLocaleString();
                if (errEl) errEl.textContent = (stats.errors_total || 0).toLocaleString();
                if (tokEl) tokEl.textContent = (stats.tokens_generated || 0).toLocaleString();
                
                // Update latency (use actual average latency)
                const avgLatency = stats.avg_latency_ms || 0;
                if (latEl) latEl.textContent = avgLatency.toFixed(1) + 'ms';
                if (avgLatEl) avgLatEl.textContent = avgLatency.toFixed(1) + 'ms';
                
                // Update resource usage (with null checks)
                const cpuPercent = stats.cpu_percent || 0;
                const cpuUsageEl = document.getElementById('cpuUsage');
                const cpuBarEl = document.getElementById('cpuBar');
                if (cpuUsageEl) cpuUsageEl.textContent = cpuPercent.toFixed(1) + '%';
                if (cpuBarEl) cpuBarEl.style.width = Math.min(cpuPercent, 100) + '%';
                
                const memBytes = stats.memory_bytes || 0;
                const memMB = (memBytes / 1024 / 1024).toFixed(0);
                const memUsageEl = document.getElementById('memoryUsage');
                const memBarEl = document.getElementById('memoryBar');
                if (memUsageEl) memUsageEl.textContent = memMB + ' MB';
                const memTotal = stats.memory_total || (8 * 1024 * 1024 * 1024);
                if (memBarEl) memBarEl.style.width = Math.min(memBytes / memTotal * 100, 100) + '%';
                
                // Disk usage
                const diskUsageEl = document.getElementById('diskUsage');
                const diskBarEl = document.getElementById('diskBar');
                if (diskUsageEl) diskUsageEl.textContent = '0.0 GB';
                if (diskBarEl) diskBarEl.style.width = '0%';
                
                // Update active connections (with null checks)
                const wsEl = document.getElementById('wsConnections');
                const sessEl = document.getElementById('activeSessions');
                const modelsEl = document.getElementById('loadedModels');
                const ragEl = document.getElementById('ragDocuments');
                
                if (wsEl) wsEl.textContent = stats.websocket_connections || 0;
                if (sessEl) sessEl.textContent = stats.active_sessions || 0;
                if (modelsEl) modelsEl.textContent = stats.models_loaded || 0;
                if (ragEl) ragEl.textContent = stats.rag_documents || 0;
                
            } catch (e) {
                console.error('Failed to load metrics:', e);
                const rawMetricsEl = document.getElementById('rawMetrics');
                if (rawMetricsEl) rawMetricsEl.textContent = 'Failed to load metrics: ' + e.message;
            }
        }
        
        function formatPrometheusMetrics(text) {
            // Parse and format Prometheus metrics for better readability
            const lines = text.split('\n');
            let html = '';
            let currentMetric = '';
            
            for (const line of lines) {
                if (!line.trim()) continue;
                
                if (line.startsWith('# HELP')) {
                    // Help line - extract metric name and description
                    const match = line.match(/# HELP (\S+) (.+)/);
                    if (match) {
                        html += `<div class="mt-3 text-accent font-medium">${match[1]}</div>`;
                        html += `<div class="text-xs text-secondary italic mb-1">${match[2]}</div>`;
                        currentMetric = match[1];
                    }
                } else if (line.startsWith('# TYPE')) {
                    // Type line - skip (redundant for display)
                    continue;
                } else {
                    // Metric value line
                    const match = line.match(/^(\S+?)(\{[^}]+\})?\s+(.+)$/);
                    if (match) {
                        const [, name, labels, value] = match;
                        const numValue = parseFloat(value);
                        const formattedValue = Number.isInteger(numValue) ? numValue.toLocaleString() : numValue.toFixed(2);
                        const labelStr = labels ? `<span class="text-blue-400">${labels}</span>` : '';
                        html += `<div class="pl-2">${labelStr} <span class="text-emerald-400 font-mono">${formattedValue}</span></div>`;
                    }
                }
            }
            
            return html || '<span class="text-secondary">No metrics available</span>';
        }
        
        function copyMetrics() {
            const el = document.getElementById('rawMetrics');
            const text = el.innerText || el.textContent;
            navigator.clipboard.writeText(text);
            showAlert('Metrics copied to clipboard', { title: 'Copied', type: 'success' });
        }

        // ============================================
        // LORA FUNCTIONS
        // ============================================
        
        async function loadLoRAAdapters() {
            try {
                const resp = await fetch('/v1/lora/adapters');
                const data = await resp.json();
                const list = document.getElementById('loraAdaptersList');
                const adapters = data.adapters || [];
                
                if (adapters.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-8 text-secondary">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto mb-3 opacity-50"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            <p>No LoRA adapters registered</p>
                            <p class="text-xs mt-1">Register an adapter to apply fine-tuned weights</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = adapters.map(a => `
                    <div class="flex items-center justify-between p-3 bg-tertiary rounded-lg">
                        <div>
                            <div class="font-medium">${a.name}</div>
                            <div class="text-xs text-secondary mt-1">${a.path}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-secondary">Scale: ${a.scale || 1.0}</span>
                            <button onclick="removeLoRA('${a.id}')" class="btn btn-danger btn-sm">Remove</button>
                        </div>
                    </div>
                `).join('');
                
                // Update adapter select
                const select = document.getElementById('loraAdapterSelect');
                select.innerHTML = '<option value="">Select adapter...</option>' + 
                    adapters.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
                    
            } catch (e) {
                console.error('Failed to load LoRA adapters:', e);
            }
        }
        
        async function loadLoRAModels() {
            try {
                const resp = await fetch('/v1/models');
                const data = await resp.json();
                const select = document.getElementById('loraBaseModel');
                select.innerHTML = '<option value="">Select model...</option>';
                data.data.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.id;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load models for LoRA:', e);
            }
        }
        
        function updateLoraScaleLabel() {
            const val = document.getElementById('loraScale').value;
            document.getElementById('loraScaleLabel').textContent = parseFloat(val).toFixed(1);
        }
        
        function showRegisterLoRAModal() {
            document.getElementById('registerLoRAModal').classList.remove('hidden');
            document.getElementById('registerLoRAModal').classList.add('flex');
        }
        
        function hideRegisterLoRAModal() {
            document.getElementById('registerLoRAModal').classList.add('hidden');
            document.getElementById('registerLoRAModal').classList.remove('flex');
        }
        
        async function registerLoRA() {
            const name = document.getElementById('loraName').value;
            const path = document.getElementById('loraPath').value;
            
            if (!name || !path) {
                showAlert('Please fill in all fields', { title: 'Missing Information', type: 'warning' });
                return;
            }
            
            try {
                const resp = await fetch('/v1/lora/adapters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, path })
                });
                
                if (!resp.ok) throw new Error('Failed to register adapter');
                
                hideRegisterLoRAModal();
                loadLoRAAdapters();
            } catch (e) {
                showAlert('Failed to register adapter: ' + e.message, { title: 'Error', type: 'error' });
            }
        }
        
        async function removeLoRA(id) {
            showConfirm('Are you sure you want to remove this adapter?', async () => {
                try {
                    const resp = await fetch(`/v1/lora/adapters/${id}`, { method: 'DELETE' });
                    if (!resp.ok) throw new Error('Failed to remove adapter');
                    loadLoRAAdapters();
                    showAlert('Adapter removed successfully', { title: 'Removed', type: 'success' });
                } catch (e) {
                    showAlert('Failed to remove adapter: ' + e.message, { title: 'Error', type: 'error' });
                }
            }, { title: 'Remove Adapter?', type: 'warning', confirmText: 'Remove', cancelText: 'Cancel' });
        }
        
        async function loadLoraAdapter() {
            const model = document.getElementById('loraBaseModel').value;
            const adapter = document.getElementById('loraAdapterSelect').value;
            const scale = parseFloat(document.getElementById('loraScale').value);
            
            if (!model || !adapter) {
                showAlert('Please select a model and adapter', { title: 'Missing Selection', type: 'warning' });
                return;
            }
            
            try {
                const resp = await fetch('/v1/lora/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, adapter_id: adapter, scale })
                });
                
                if (!resp.ok) throw new Error('Failed to load adapter');
                
                const data = await resp.json();
                document.getElementById('activeLoraInfo').innerHTML = `
                    <div class="text-left">
                        <div class="text-sm"><span class="text-secondary">Model:</span> ${model}</div>
                        <div class="text-sm"><span class="text-secondary">Adapter:</span> ${data.adapter_name || adapter}</div>
                        <div class="text-sm"><span class="text-secondary">Scale:</span> ${scale}</div>
                    </div>
                `;
            } catch (e) {
                showAlert('Failed to load adapter: ' + e.message, { title: 'Error', type: 'error' });
            }
        }

    </script>

    <!-- File Browser Modal -->
    <div id="fileBrowserModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header">
                <span class="modal-icon"></span>
                <h3 class="modal-title">Select Folder</h3>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <!-- Common Paths -->
                <div class="mb-3">
                    <div class="text-xs text-secondary mb-2">Quick Access:</div>
                    <div id="commonPathsList" class="flex flex-wrap gap-2"></div>
                </div>
                
                <!-- Current Path and Navigation -->
                <div class="mb-3">
                    <div class="text-xs text-secondary mb-1">Current Path:</div>
                    <div class="flex gap-2">
                        <input type="text" id="browserCurrentPath" readonly 
                               class="flex-1 input-theme rounded px-3 py-2 text-xs font-mono bg-secondary" />
                        <button onclick="browseParentDir()" class="btn btn-secondary px-3" title="Go up one level">
                            Up
                        </button>
                        <button onclick="refreshBrowser()" class="btn btn-secondary px-3" title="Refresh">
                            Refresh
                        </button>
                    </div>
                </div>
                
                <!-- File List -->
                <div style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px;">
                    <div id="browserFileList" class="text-sm"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeFileBrowser()">Cancel</button>
                <button class="btn btn-primary" onclick="selectCurrentPath()">Select Current Folder</button>
            </div>
        </div>
    </div>

    <script>
        // File Browser functionality
        let currentBrowserPath = '';
        let fileBrowserTarget = ''; // 'import' or 'export'
        
        async function browseForPath(target) {
            fileBrowserTarget = target;
            const modal = document.getElementById('fileBrowserModal');
            modal.style.display = 'flex';
            
            // Load common paths
            await loadCommonPaths();
            
            // Browse to default path
            const currentPath = target === 'import' 
                ? document.getElementById('usbImportPath').value 
                : document.getElementById('usbExportPath').value;
            
            await browseTo(currentPath || '');
        }
        
        async function loadCommonPaths() {
            const container = document.getElementById('commonPathsList');
            container.innerHTML = '<span class="text-xs text-secondary">Loading...</span>';
            
            try {
                const response = await fetch('/v1/filesystem/common-paths');
                const data = await response.json();
                
                if (response.ok && data.paths) {
                    container.innerHTML = data.paths
                        .filter(p => p.exists)
                        .map(p => `
                            <button onclick="browseTo('${p.path.replace(/'/g, "\\'")}')" 
                                    class="px-3 py-1 text-xs bg-secondary hover:bg-accent hover:text-white rounded border border-theme transition-colors"
                                    title="${p.description}">
                                ${p.label}
                            </button>
                        `).join('');
                } else {
                    container.innerHTML = '<span class="text-xs text-red-400">Failed to load paths</span>';
                }
            } catch (error) {
                container.innerHTML = '<span class="text-xs text-red-400">Error loading paths</span>';
            }
        }
        
        async function browseTo(path) {
            const listContainer = document.getElementById('browserFileList');
            const pathInput = document.getElementById('browserCurrentPath');
            
            listContainer.innerHTML = '<div class="p-4 text-center text-secondary text-sm">Loading...</div>';
            
            try {
                const response = await fetch('/v1/filesystem/browse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentBrowserPath = data.current_path;
                    pathInput.value = currentBrowserPath;
                    
                    let html = '';
                    
                    // Add directories
                    if (data.directories && data.directories.length > 0) {
                        const visibleDirs = data.directories.filter(d => !d.is_hidden);
                        visibleDirs.forEach(dir => {
                            html += `
                                <div class="file-entry directory" onclick="browseTo('${dir.path.replace(/'/g, "\\'")}')">
                                    <span class="file-icon">â–¸</span>
                                    <span class="file-name">${dir.name}</span>
                                </div>
                            `;
                        });
                    }
                    
                    // Show message if no directories
                    if (!html) {
                        html = '<div class="p-4 text-center text-secondary text-sm">No subdirectories</div>';
                    }
                    
                    listContainer.innerHTML = html;
                } else {
                    listContainer.innerHTML = `<div class="p-4 text-center text-red-400 text-sm">${data.error || 'Failed to browse'}</div>`;
                }
            } catch (error) {
                listContainer.innerHTML = `<div class="p-4 text-center text-red-400 text-sm">Error: ${error.message}</div>`;
            }
        }
        
        function browseParentDir() {
            const pathInput = document.getElementById('browserCurrentPath');
            const currentPath = pathInput.value;
            
            // Extract parent path
            const parts = currentPath.split('/').filter(p => p);
            if (parts.length > 0) {
                parts.pop();
                const parentPath = '/' + parts.join('/');
                browseTo(parentPath || '/');
            }
        }
        
        function refreshBrowser() {
            const pathInput = document.getElementById('browserCurrentPath');
            browseTo(pathInput.value);
        }
        
        function selectCurrentPath() {
            const pathInput = document.getElementById('browserCurrentPath');
            const selectedPath = pathInput.value;
            
            if (fileBrowserTarget === 'import') {
                document.getElementById('usbImportPath').value = selectedPath;
            } else {
                document.getElementById('usbExportPath').value = selectedPath;
            }
            
            closeFileBrowser();
        }
        
        function closeFileBrowser() {
            const modal = document.getElementById('fileBrowserModal');
            modal.style.display = 'none';
        }
        
        // Close modal when clicking outside
        document.getElementById('fileBrowserModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'fileBrowserModal') {
                closeFileBrowser();
            }
        });
    </script>

    <style>
        .file-entry {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.15s;
            border-bottom: 1px solid var(--border-color);
        }
        
        .file-entry:hover {
            background-color: var(--bg-secondary);
        }
        
        .file-entry.directory {
            font-weight: 500;
        }
        
        .file-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }
        
        .file-name {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }
    </style>
</body>
</html>
